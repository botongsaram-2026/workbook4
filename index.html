<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸í›„ì¤€ë¹„ ì¸í„°ë™í‹°ë¸Œ ì›Œí¬ë¶ (Final Version - Fixed)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        
        /* [ìˆ˜ì •ë¨] ë·°ì–´ ìŠ¤íƒ€ì¼: ê¸€ì”¨ í¬ê¸° í™•ëŒ€ ë° ê°€ë…ì„± ê°œì„  */
        .smart-content { padding: 0 0.5rem; }
        .smart-content h1 { 
            font-size: 2.6rem; /* ì œëª© í¬ê¸° í™•ëŒ€ */
            font-weight: 900; 
            color: #111827; 
            margin-top: 2rem; 
            margin-bottom: 2.5rem; 
            line-height: 1.3; 
            border-bottom: 5px solid #3b82f6; 
            padding-bottom: 15px; 
            letter-spacing: -0.05rem;
        }
        .smart-content h2 { 
            font-size: 2.0rem; /* ì†Œì œëª© í¬ê¸° í™•ëŒ€ */
            font-weight: 800; 
            color: #1e293b; 
            margin-top: 4rem; 
            margin-bottom: 1.5rem; 
            border-left: 6px solid #2563eb; 
            padding-left: 20px; 
            letter-spacing: -0.03rem;
        }
        .smart-content h3 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #334155;
            margin-top: 3rem;
            margin-bottom: 1rem;
        }
        .smart-content p { 
            font-size: 1.3rem; /* ë³¸ë¬¸ ê¸€ì”¨ í¬ê¸° ëŒ€í­ í™•ëŒ€ (ê¸°ì¡´ 1.1rem -> 1.3rem) */
            line-height: 1.9;  /* ì¤„ ê°„ê²©ë„ ë„“ê²Œ */
            color: #334155; 
            margin-bottom: 1.8rem; 
            text-align: justify; 
            word-break: keep-all; 
        }
        .smart-content ul, .smart-content ol {
            font-size: 1.3rem; /* ë¦¬ìŠ¤íŠ¸ ê¸€ì”¨ë„ ë™ì¼í•˜ê²Œ í™•ëŒ€ */
            line-height: 1.9;
            color: #334155;
            margin-bottom: 1.8rem;
            padding-left: 1.5rem;
        }
        .smart-content li {
            margin-bottom: 0.8rem;
        }
        .smart-content strong { 
            color: #1d4ed8; 
            font-weight: 800; 
            background: rgba(37, 99, 235, 0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
        }
        .smart-content a { 
            color: #2563eb; 
            text-decoration: underline; 
            text-underline-offset: 4px;
            font-weight: 600; 
        }
        .smart-content img { 
            max-width: 100%; 
            height: auto; 
            border-radius: 0.8rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            margin: 3rem auto; 
            display: block; 
        }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group label { display: block; font-size: 0.95rem; color: #64748b; margin-bottom: 0.3rem; font-weight: 600; }
        .input-group input { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-weight: 600; text-align: right; outline: none; transition: all 0.2s; font-size: 1.1rem; }
        .input-group input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .expense-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .expense-table th { background: #f1f5f9; padding: 12px 8px; text-align: center; font-weight: bold; color: #475569; border: 1px solid #e2e8f0; }
        .expense-table td { padding: 8px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .expense-table input[type="text"] { width: 100%; border: none; border-bottom: 1px dashed #cbd5e1; padding: 6px; outline: none; font-size: 0.95rem; color: #334155; background: transparent; }
        .expense-table input[type="text"]:focus { border-bottom: 1px solid #2563eb; background: #eff6ff; }
        .expense-table input[type="number"] { width: 100%; text-align: right; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-weight: bold; color: #2563eb; outline: none; font-size: 0.95rem; }
        .expense-table input[type="number"]:focus { border-color: #2563eb; ring: 2px solid #93c5fd; }
        .cat-header { background: #f8fafc; font-weight: bold; color: #1e293b; text-align: center; }

        /* ì—°ê¸ˆ í…Œì´ë¸” */
        .pension-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; text-align: center; }
        .pension-table th { background: #e2e8f0; padding: 10px; font-weight: bold; color: #475569; }
        .pension-table td { padding: 10px; border-bottom: 1px solid #cbd5e1; }
        .highlight-row { background-color: #dbeafe; font-weight: bold; color: #1e40af; border: 2px solid #2563eb; }

        /* PDFìš© ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .avoid-break { page-break-inside: avoid; }
        .page-break { page-break-before: always; }

        /* í”„ë¦°íŠ¸ ìŠ¤íƒ€ì¼ */
        @media print {
            .no-print { display: none !important; }
            body { background: white; font-size: 12pt; }
            #root { height: auto; overflow: visible; }
            .smart-content p { font-size: 12pt; } /* ì¸ì‡„ ì‹œì—ëŠ” ë„ˆë¬´ í¬ì§€ ì•Šê²Œ ì¡°ì • */
        }
/* â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¶€ë¶„] ì‹¤ì²œí•˜ê¸° ëª¨ë“œ ì „ìš© ê¸€ì”¨ í™•ëŒ€ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */
        .practice-zoom {
            /* ê¸°ë³¸ ì»¨í…Œì´ë„ˆ í°íŠ¸ í™•ëŒ€ */
            font-size: 1.15rem; 
        }
        /* ì„¤ëª…ê¸€, ë¦¬ìŠ¤íŠ¸, ë¼ë²¨ í™•ëŒ€ */
        .practice-zoom p, 
        .practice-zoom li, 
        .practice-zoom label,
        .practice-zoom div { 
            line-height: 1.6; /* ì¤„ê°„ê²©ë„ ì‹œì›í•˜ê²Œ */
        }
        /* ì…ë ¥ì°½(ìˆ«ì, í…ìŠ¤íŠ¸, ë°•ìŠ¤) ëŒ€í­ í™•ëŒ€ */
        .practice-zoom input[type="text"], 
        .practice-zoom input[type="number"], 
        .practice-zoom textarea, 
        .practice-zoom select { 
            font-size: 1.2rem !important; /* ì…ë ¥ ê¸€ì”¨ í¬ê²Œ */
            padding: 12px !important;     /* ì…ë ¥ì¹¸ ìì²´ë„ ë„“ê²Œ */
            height: auto;
        }
        /* í‘œ ë‚´ë¶€ ê¸€ì”¨ í™•ëŒ€ */
        .practice-zoom table th, 
        .practice-zoom table td { 
            font-size: 1.05rem !important; 
            padding: 12px 8px !important;
        }
        /* ì•„ì£¼ ì‘ì€ ê¸€ì”¨(text-xs, text-sm)ë“¤ë„ ê°•ì œë¡œ í‚¤ì›€ */
        .practice-zoom .text-xs { font-size: 0.95rem !important; }
        .practice-zoom .text-sm { font-size: 1.05rem !important; }
        /* â–²â–²â–² [ì¶”ê°€ ë] â–²â–²â–² */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="root"></div>

<script type="text/babel">
// [ì¤‘ìš”] ì•„ë˜ ì˜ì—­ì€ ë°°í¬ íŒŒì¼ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„°ê°€ ì±„ì›Œì§‘ë‹ˆë‹¤. ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”.
    /*__DATA_START__*/
    const EMBEDDED_DATA = null; 
    const LOCKED_PASSWORD = "260127";  // ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •

    // GitHub ì´ë¯¸ì§€ ìë™ ë¡œë“œ í•¨ìˆ˜
    async function loadGitHubImages() {
        const imageFiles = [
            "1-1.jpg", "10-1.jpg", "10-10.jpg", "10-11.jpg", "10-12.jpg", 
            "10-2.jpg", "10-3.jpg", "10-4.jpg", "10-5.jpg", "10-6.jpg", 
            "10-7.jpg", "10-8.jpg", "10-9.jpg", "11-1.jpg", "11-10.jpg", 
            "11-11.jpg", "11-2.jpg", "11-3.jpg", "11-4.jpg", "11-5.jpg", 
            "11-6.jpg", "11-7.jpg", "11-8.jpg", "11-9.jpg", 
            "2ë‹¨ê³„1.jpg", "2ë‹¨ê³„10.jpg", "2ë‹¨ê³„11.jpg", "2ë‹¨ê³„2.jpg", 
            "2ë‹¨ê³„3.jpg", "2ë‹¨ê³„4.jpg", "2ë‹¨ê³„5.jpg", "2ë‹¨ê³„6.jpg", 
            "2ë‹¨ê³„7.jpg", "2ë‹¨ê³„8.jpg", "2ë‹¨ê³„9.jpg", 
            "3ë‹¨ê³„1.jpg", "3ë‹¨ê³„10.jpg", "3ë‹¨ê³„11.jpg", "3ë‹¨ê³„12.jpg", 
            "3ë‹¨ê³„13.jpg", "3ë‹¨ê³„14.jpg", "3ë‹¨ê³„2.jpg", "3ë‹¨ê³„3.jpg", 
            "3ë‹¨ê³„4.jpg", "3ë‹¨ê³„5.jpg", "3ë‹¨ê³„6.jpg", "3ë‹¨ê³„7.jpg", 
            "3ë‹¨ê³„8.jpg", "3ë‹¨ê³„9.jpg", 
            "4ë‹¨ê³„1.jpg", "4ë‹¨ê³„10.jpg", "4ë‹¨ê³„11.jpg", "4ë‹¨ê³„12.jpg", 
            "4ë‹¨ê³„13.jpg", "4ë‹¨ê³„14.jpg", "4ë‹¨ê³„15.jpg", "4ë‹¨ê³„16.jpg", 
            "4ë‹¨ê³„17.jpg", "4ë‹¨ê³„2.jpg", "4ë‹¨ê³„3.jpg", "4ë‹¨ê³„4.jpg", 
            "4ë‹¨ê³„5.jpg", "4ë‹¨ê³„6.jpg", "4ë‹¨ê³„7.jpg", "4ë‹¨ê³„8.jpg", 
            "4ë‹¨ê³„9.jpg", 
            "5-1.jpg", "5-10.jpg", "5-11.jpg", "5-12.jpg", "5-13.jpg", 
            "5-14.jpg", "5-15.jpg", "5-16.jpg", "5-2.jpg", "5-3.jpg", 
            "5-4.jpg", "5-5.jpg", "5-6.jpg", "5-7.jpg", "5-8.jpg", "5-9.jpg", 
            "5ë‹¨ê³„1.jpg", "5ë‹¨ê³„10.jpg", "5ë‹¨ê³„11.jpg", "5ë‹¨ê³„12.jpg", 
            "5ë‹¨ê³„2.jpg", "5ë‹¨ê³„3.jpg", "5ë‹¨ê³„4.jpg", "5ë‹¨ê³„5.jpg", 
            "5ë‹¨ê³„6.jpg", "5ë‹¨ê³„7.jpg", "5ë‹¨ê³„8.jpg", "5ë‹¨ê³„9.jpg", 
            "6-1.jpg", "6-10.jpg", "6-11.jpg", "6-12.jpg", "6-13.jpg", 
            "6-14.jpg", "6-15.jpg", "6-16.jpg", "6-17.jpg", "6-18.jpg", 
            "6-19.jpg", "6-2.jpg", "6-20.jpg", "6-21.jpg", "6-22.jpg", 
            "6-23.jpg", "6-24.jpg", "6-25.jpg", "6-26.jpg", "6-27.jpg", 
            "6-28.jpg", "6-29.jpg", "6-3.jpg", "6-30.jpg", "6-31.jpg", 
            "6-32.jpg", "6-33.jpg", "6-34.jpg", "6-35.jpg", "6-36.jpg", 
            "6-37.jpg", "6-38.jpg", "6-39.jpg", "6-4.jpg", "6-40.jpg", 
            "6-41.jpg", "6-42.jpg", "6-43.jpg", "6-5.jpg", "6-6.jpg", 
            "6-7.jpg", "6-8.jpg", "6-9.jpg", 
            "7-1.jpg", "7-10.jpg", "7-11.jpg", "7-12.jpg", "7-13.jpg", 
            "7-14.jpg", "7-15.jpg", "7-16.jpg", "7-17.jpg", "7-18.jpg", 
            "7-19.jpg", "7-2.jpg", "7-20.jpg", "7-21.jpg", "7-22.jpg", 
            "7-23.jpg", "7-24.jpg", "7-25.jpg", "7-26.jpg", "7-27.jpg", 
            "7-28.jpg", "7-29.jpg", "7-3.jpg", "7-30.jpg", "7-31.jpg", 
            "7-32.jpg", "7-33.jpg", "7-34.jpg", "7-35.jpg", "7-36.jpg", 
            "7-37.jpg", "7-4.jpg", "7-5.jpg", "7-6.jpg", "7-7.jpg", 
            "7-8.jpg", "7-9.jpg", 
            "8-1.jpg", "8-10.jpg", "8-11.jpg", "8-12.jpg", "8-13.jpg", 
            "8-14.jpg", "8-15.jpg", "8-16.jpg", "8-17.jpg", "8-18.jpg", 
            "8-19.jpg", "8-2.jpg", "8-20.jpg", "8-21.jpg", "8-22.jpg", 
            "8-23.jpg", "8-24.jpg", "8-25.jpg", "8-26.jpg", "8-3.jpg", 
            "8-4.jpg", "8-5.jpg", "8-6.jpg", "8-7.jpg", "8-8.jpg", "8-9.jpg", 
            "9-1.jpg", "9-10.jpg", "9-11.jpg", "9-12.jpg", "9-13.jpg", 
            "9-14.jpg", "9-15.jpg", "9-16.jpg", "9-17.jpg", "9-18.jpg", 
            "9-19.jpg", "9-2.jpg", "9-20.jpg", "9-21.jpg", "9-22.jpg", 
            "9-3.jpg", "9-4.jpg", "9-5.jpg", "9-6.jpg", "9-7.jpg", 
            "9-8.jpg", "9-9.jpg", 
            "ë‚˜ì˜ ë…¸í›„ ì˜ˆìƒ ë¹„ìš©.jpg", "ë‚˜ì˜ ë…¸í›„ ì˜ˆìƒ ë¹„ìš©2.jpg", 
            "ì¸í”Œë ˆì´ì…˜.jpg", "í†µí•©ì—°ê¸ˆí¬í„¸1.jpg", "í†µí•©ì—°ê¸ˆí¬í„¸2.jpg", 
            "í†µí•©ì—°ê¸ˆí¬í„¸3.jpg", "í†µí•©ì—°ê¸ˆí¬í„¸4.jpg", "í†µí•©ì—°ê¸ˆí¬í„¸5.jpg"
        ];
        
        const imageMap = {};
        imageFiles.forEach(filename => {
            imageMap[filename] = `images/${filename}`;
        });
        return imageMap;
    }

    // í…ìŠ¤íŠ¸ íŒŒì¼ ë¡œë“œ í•¨ìˆ˜
    async function loadLectureText() {
        try {
            // íƒ€ì„ì•„ì›ƒ ì„¤ì • (3ì´ˆ)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);
            
            const response = await fetch('ì„¤ëª… ë“£ê¸°.txt', { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) return {};
            const text = await response.text();
            
            const contents = {};
            const parts = text.split(/\[(\d+)ë‹¨ê³„\]/);
            for (let i = 1; i < parts.length; i += 2) {
                if (i + 1 < parts.length) {
                    contents[`step${parts[i]}`] = parts[i + 1].trim();
                }
            }
            return contents;
        } catch (err) {
            console.error('í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
            return {};
        }
    }

    // [ì „ì—­] í…ìŠ¤íŠ¸ í¬ë§·íŒ… í•¨ìˆ˜ (ì´ˆê°•ë ¥ ì´ë¯¸ì§€ ë§¤ì¹­ + ì§„ë‹¨ í‘œì‹œ)
    const formatTextToHtml = (text, imgMap) => {
        let html = text.replace(/\r\n/g, "\n").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        // ì´ë¯¸ì§€ ì¹˜í™˜ (í™•ì¥ì, ê³µë°± ë¬´ì‹œí•˜ê³  ì´ë¦„ë§Œ ê°™ìœ¼ë©´ ë§¤ì¹­)
        html = html.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, (m, f) => { 
            const rawName = f.trim();
            // ë¹„êµë¥¼ ìœ„í•´ ì´ë¦„ì—ì„œ í™•ì¥ì(.jpg ë“±)ì™€ ê³µë°±ì„ ëª¨ë‘ ì œê±°í•˜ê³  ì†Œë¬¸ìë¡œ ë³€í™˜
            const cleanTarget = rawName.replace(/\.[^/.]+$/, "").replace(/\s/g, "").toLowerCase();
            
            const uploadedFiles = Object.keys(imgMap);
            
            // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì¤‘ì—ì„œ 'í•µì‹¬ ì´ë¦„'ì´ ê°™ì€ ê²ƒì„ ì°¾ìŒ
            const matchedKey = uploadedFiles.find(key => {
                const cleanKey = key.replace(/\.[^/.]+$/, "").replace(/\s/g, "").toLowerCase();
                return cleanKey === cleanTarget;
            });

            if (matchedKey) {
                return `<img src="${imgMap[matchedKey]}" alt="${rawName}" class="mx-auto rounded-lg shadow-md my-8 transition-transform hover:scale-[1.02]" style="max-height: 500px; width: auto;" />`;
            } else {
                // ëª» ì°¾ì•˜ì„ ë•Œ ë‚˜ì˜¤ëŠ” ì§„ë‹¨ ë°•ìŠ¤
                return `
                    <div class="text-red-500 border-2 border-red-300 bg-red-50 p-4 rounded-lg text-center my-6 text-sm">
                        <strong class="text-lg block mb-2">âš ï¸ ì´ë¯¸ì§€ë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤</strong>
                        <div class="text-left bg-white p-2 rounded border text-slate-600 mb-2">
                            <div>ğŸ“ <strong>ì›ê³ ì— ì ì€ ê²ƒ:</strong> ${rawName}</div>
                            <div>ğŸ” <strong>ì°¾ëŠ” í•µì‹¬ ë‹¨ì–´:</strong> ${cleanTarget}</div>
                        </div>
                        <div class="text-left bg-blue-50 p-2 rounded border text-blue-800">
                            <div>ğŸ“‚ <strong>í˜„ì¬ ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ (${uploadedFiles.length}ì¥):</strong></div>
                            <div class="text-xs mt-1 break-all">${uploadedFiles.length > 0 ? uploadedFiles.join(', ') : '(ì—†ìŒ. ì—…ë¡œë“œ ì‹œ ì‚¬ì§„ì„ ê°™ì´ ì„ íƒí•´ì£¼ì„¸ìš”!)'}</div>
                        </div>
                    </div>
                `;
            }
        });

        // ë§í¬, ì œëª©, ìŠ¤íƒ€ì¼ ë“± ë‚˜ë¨¸ì§€ ë³€í™˜ ë¡œì§
        html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline decoration-2 hover:text-blue-800 font-bold transition-colors">$1</a>');
        html = html.replace(/(^|\n)!!![ \t]+(.*)/g, '\n<h1 class="text-3xl md:text-4xl font-black text-slate-900 mt-12 mb-8 pb-4 border-b-4 border-blue-500 leading-tight">$2</h1>\n');
        html = html.replace(/(^|\n)(##|Â¶)[ \t]+(.*)/g, '\n<h2 class="text-2xl md:text-3xl font-bold text-slate-800 mt-10 mb-5 pl-4 border-l-8 border-blue-600 leading-snug">$3</h2>\n');
        html = html.replace(/(^|\n)(###|â– )[ \t]+(.*)/g, '\n<h3 class="text-xl font-bold text-indigo-700 mt-8 mb-3 flex items-center gap-2"><span class="text-indigo-400 text-sm">â—</span> $3</h3>\n');
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-700 font-extrabold bg-blue-50 px-1 py-0.5 rounded border border-blue-100">$1</strong>');
        html = html.replace(/\^\^(.*?)\^\^/g, '<span class="bg-yellow-200 text-yellow-900 px-1 py-0.5 rounded font-bold shadow-sm" style="box-decoration-break: clone;">$1</span>');
        html = html.replace(/(^|\n)-[ \t]+(.*)/g, '\n<li class="mb-2 text-lg text-slate-700 pl-2 border-l-2 border-slate-200 hover:border-blue-400 transition-colors">$2</li>\n');

        return html.split(/\n\s*\n/).map(p => {
            const t = p.trim(); 
            if(!t) return "";
            if(t.startsWith('<h') || t.startsWith('<img') || t.startsWith('<div')) return t;
            if(t.startsWith('<li')) return `<ul class="list-none my-6 space-y-1">${t}</ul>`;
            return `<p class="text-lg leading-relaxed text-slate-700 mb-6 text-justify break-keep font-medium">${t.replace(/\n/g, '<br>')}</p>`;
        }).join('');
    };

    // ì´ˆê¸°í™” - ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í›„ ì‹¤í–‰
    async function initData() {
        // ë¡œì»¬ íŒŒì¼ì¸ì§€ í™•ì¸ (file:// í”„ë¡œí† ì½œ)
        const isLocalFile = window.location.protocol === 'file:';
        
        if (!EMBEDDED_DATA) {
            if (isLocalFile) {
                console.log('âš ï¸ ë¡œì»¬ íŒŒì¼ ëª¨ë“œ: IndexedDBì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.');
                window.EMBEDDED_DATA = { imageUrls: {}, contents: {} };
            } else {
                console.log('ğŸ“¦ workbook-data.zip ë¡œë”© ì‹œì‘...');
                try {
                    const response = await fetch('./workbook-data.zip');
                    if (!response.ok) throw new Error('ZIP íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    
                    const imageUrls = {};
                    const textContents = [];
                    
                    // ZIP íŒŒì¼ ë‚´ìš© ì¶”ì¶œ
                    for (const [filename, file] of Object.entries(zip.files)) {
                        if (file.dir) continue;
                        
                        // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
                        if (/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(filename)) {
                            const blob = await file.async('blob');
                            const reader = new FileReader();
                            await new Promise((resolve) => {
                                reader.onload = (e) => {
                                    const fileName = filename.split('/').pop().split('\\').pop();
                                    imageUrls[fileName] = e.target.result;
                                    resolve();
                                };
                                reader.readAsDataURL(blob);
                            });
                        }
                        // í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
                        else if (filename.toLowerCase().endsWith('.txt')) {
                            const content = await file.async('text');
                            textContents.push(content);
                        }
                    }
                    
                    // í…ìŠ¤íŠ¸ë¥¼ ë‹¨ê³„ë³„ë¡œ íŒŒì‹±
                    const contents = {};
                    textContents.forEach(text => {
                        const sections = text.split(/\[\s*(\d+)\s*ë‹¨ê³„\s*\]|\[\s*(Intro|0)\s*\]/i);
                        
                        for (let i = 1; i < sections.length; i += 3) {
                            const marker = sections[i] || sections[i + 1];
                            const content = sections[i + 2];
                            let idx = -1;
                            
                            if (marker && (marker.toLowerCase().includes('intro') || marker === '0')) {
                                idx = 0;
                            } else if (marker) {
                                idx = parseInt(marker);
                            }
                            
                            if (idx >= 0 && content) {
                                contents[idx] = { title: `${idx}ë‹¨ê³„`, content: content.trim() };
                            }
                        }
                    });
                    
                    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    window.EMBEDDED_DATA = { imageUrls, contents };
                    
                    // IndexedDBì—ë„ ì €ì¥
                    await IDB.put('wb_images_v41', imageUrls);
                    await IDB.put('wb_contents_v41', contents);
                    
                    console.log('âœ… ZIP ë¡œë“œ ì™„ë£Œ! ì´ë¯¸ì§€:', Object.keys(imageUrls).length, 'ê°œ, í…ìŠ¤íŠ¸:', Object.keys(contents).length, 'ë‹¨ê³„');
                } catch (err) {
                    console.error('âŒ ZIP ë¡œë“œ ì‹¤íŒ¨:', err);
                    window.EMBEDDED_DATA = { imageUrls: {}, contents: {} };
                }
            }
        }
    }
    /*__DATA_END__*/

    const IDB_NAME = 'WorkbookDB_v1';
    const IDB = {
        open: () => new Promise((resolve, reject) => {
            const req = indexedDB.open(IDB_NAME, 1);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('store')) db.createObjectStore('store');
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        }),
        put: async (key, val) => {
            const db = await IDB.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('store', 'readwrite');
                tx.objectStore('store').put(val, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        },
        get: async (key) => {
            const db = await IDB.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('store', 'readonly');
                const req = tx.objectStore('store').get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
    };

    const { useState, useEffect, useRef, useMemo } = React;

const ETF_DB = {
        domestic_overseas: [
            { id: "360750", name: "TIGER ë¯¸êµ­S&P500", rate: 13.5, desc: "ë¯¸êµ­ ì‹œì¥ ì „ì²´ ì¶”ì¢…, ì¥ê¸° ìš°ìƒí–¥ì˜ ì •ì„" },
            { id: "367380", name: "ACE ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100", rate: 19.0, desc: "ë¯¸êµ­ ê¸°ìˆ  í˜ì‹ ì£¼ 100ê°œ, AI/ë°˜ë„ì²´/ë¹…í…Œí¬" },
            { id: "458730", name: "TIGER ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤", rate: 11.5, desc: "SCHDì™€ ë™ì¼, 10ë…„ ì´ìƒ ë°°ë‹¹ ì„±ì¥ ê¸°ì—…" },
            { id: "449150", name: "KODEX ë¯¸êµ­S&P500(H)", rate: 10.0, desc: "í™˜ìœ¨ ë³€ë™ì„± ì œê±°(í™˜í—¤ì§€), ì§€ìˆ˜ ìˆ˜ìµë§Œ ì¶”êµ¬" },
            { id: "381170", name: "TIGER ë¯¸êµ­í…Œí¬TOP10", rate: 20.0, desc: "ë‚˜ìŠ¤ë‹¥ ì‹œì´ ìƒìœ„ 10ê°œ(ì• í”Œ, ì—”ë¹„ë””ì•„ ë“±) ì§‘ì¤‘" }
        ],
        domestic: [
            { id: "069500", name: "KODEX 200", rate: 5.5, desc: "ëŒ€í•œë¯¼êµ­ ëŒ€í‘œ ëŒ€í˜•ì£¼ 200ê°œ, ê±°ë˜ëŸ‰ 1ìœ„" },
            { id: "102110", name: "TIGER ì½”ìŠ¤í”¼200", rate: 6.0, desc: "ìµœì € ë¹„ìš© ëŒ€í˜•ì£¼ íˆ¬ì, ì¥ê¸° íˆ¬ì ìœ ë¦¬" },
            { id: "229200", name: "KODEX ì½”ìŠ¤ë‹¥150", rate: 5.5, desc: "ì½”ìŠ¤ë‹¥ ê¸°ìˆ ì£¼/ì„±ì¥ì£¼, ë†’ì€ ë³€ë™ì„±" },
            { id: "161510", name: "PLUS ê³ ë°°ë‹¹ì£¼", rate: 8.5, desc: "êµ­ë‚´ ê³ ë°°ë‹¹ ìƒìœ„ 30ì¢…ëª©, í•˜ë½ì¥ ë°©ì–´" }, // ì´ë¦„ ë³€ê²½ë¨
            { id: "226490", name: "KBSTAR ì½”ìŠ¤í”¼", rate: 5.0, desc: "ì½”ìŠ¤í”¼ ì „ì²´ ì‹œì¥ íˆ¬ì, í•œêµ­ ê²½ì œ ë°˜ì˜" }
        ],
        overseas: [
            { id: "SPYM", name: "SPYM (S&P500)", rate: 13.0, desc: "ë¯¸êµ­ S&P500 ì¶”ì¢…, ìš´ìš©ë³´ìˆ˜ 0.02% ì´ˆì €ë ´ (êµ¬ SPLG)" },
            { id: "QQQM", name: "QQQM (Nasdaq100)", rate: 19.0, desc: "ë‚˜ìŠ¤ë‹¥ 100 ì¶”ì¢…, QQQì˜ ì €ë¹„ìš© ë²„ì „" },
            { id: "SCHD", name: "SCHD (Dividend)", rate: 11.5, desc: "ë¯¸êµ­ ë°°ë‹¹ì„±ì¥ì£¼, ì£¼ê°€ìƒìŠ¹+ë°°ë‹¹ì¦ê°€" },
            { id: "VTI", name: "VTI (Total Market)", rate: 12.0, desc: "ë¯¸êµ­ ì „ì²´ ì£¼ì‹ì‹œì¥(ì†Œí˜•ì£¼ í¬í•¨) íˆ¬ì" },
            { id: "JEPI", name: "JEPI (Covered Call)", rate: 9.0, desc: "ì €ë³€ë™ ëŒ€í˜•ì£¼+ì»¤ë²„ë“œì½œ, ì›”ë°°ë‹¹(ê³ ë°°ë‹¹)" },
            { id: "JEPQ", name: "JEPQ (Nasdaq Call)", rate: 13.5, desc: "ë‚˜ìŠ¤ë‹¥ ê¸°ë°˜ ì»¤ë²„ë“œì½œ, ì„±ì¥+ë°°ë‹¹ ë™ì‹œ ì¶”êµ¬" }
        ],
        irp_safe: [
            { id: "468300", name: "[ì•ˆì „] TIGER ë¯¸êµ­í…Œí¬TOP10ì±„ê¶Œí˜¼í•©", rate: 8.0, desc: "ì£¼ì‹ 40%(ë¹…í…Œí¬)+ì±„ê¶Œ 60%, ê³µê²©ì  ì•ˆì „ìì‚°" },
            { id: "440260", name: "[ì•ˆì „] ACE ë¯¸êµ­S&P500ì±„ê¶Œí˜¼í•©ì•¡í‹°ë¸Œ", rate: 6.0, desc: "ì£¼ì‹ 30%+ì±„ê¶Œ, S&P500 íˆ¬ì íš¨ê³¼" },
            { id: "445610", name: "[ì•ˆì „] ACE ì—”ë¹„ë””ì•„ì±„ê¶Œí˜¼í•©ë¸”ë£¸ë²„ê·¸", rate: 9.0, desc: "ì£¼ì‹ 30%(ì—”ë¹„ë””ì•„)+ì±„ê¶Œ, ë‹¨ì¼ì¢…ëª© ì§‘ì¤‘" },
            { id: "468290", name: "[ì•ˆì „] TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100ì±„ê¶Œí˜¼í•©", rate: 7.0, desc: "ì£¼ì‹ 40%(ë‚˜ìŠ¤ë‹¥)+ì±„ê¶Œ, ê¸°ìˆ ì£¼ ì„±ì¥ í–¥ìœ " },
            { id: "329750", name: "[ì•ˆì „] KODEX TRF3070", rate: 5.0, desc: "ì„ ì§„êµ­ì£¼ì‹ 30%+êµ­ë‚´ì±„ê¶Œ 70%, ê¸€ë¡œë²Œ ë¶„ì‚°" }
        ]
    };

    const RECOMMENDED_PORTFOLIOS = {
        "20ëŒ€": { pension: [{id: "367380", percent: 100}], isa: [{id: "367380", percent: 100}], irp: [{id: "367380", percent: 70}, {id: "440260", percent: 30}], general: [{id: "QQQM", percent: 100}] },
        "30ëŒ€": { pension: [{id: "367380", percent: 100}], isa: [{id: "367380", percent: 100}], irp: [{id: "367380", percent: 70}, {id: "440260", percent: 30}], general: [{id: "QQQM", percent: 100}] },
        "40ëŒ€": { pension: [{id: "367380", percent: 40}, {id: "360750", percent: 40}, {id: "458730", percent: 20}], isa: [{id: "367380", percent: 40}, {id: "360750", percent: 40}, {id: "458730", percent: 20}], irp: [{id: "367380", percent: 35}, {id: "360750", percent: 35}, {id: "440260", percent: 30}], general: [{id: "QQQM", percent: 40}, {id: "SPYM", percent: 40}, {id: "SCHD", percent: 20}] },
        "50ëŒ€": { pension: [{id: "360750", percent: 70}, {id: "458730", percent: 30}], isa: [{id: "360750", percent: 70}, {id: "458730", percent: 30}], irp: [{id: "360750", percent: 70}, {id: "440260", percent: 30}], general: [{id: "SPYM", percent: 70}, {id: "SCHD", percent: 30}] },
        "60ëŒ€": { pension: [{id: "360750", percent: 35}, {id: "458730", percent: 65}], isa: [{id: "360750", percent: 35}, {id: "458730", percent: 65}], irp: [{id: "360750", percent: 70}, {id: "440260", percent: 30}], general: [{id: "SPYM", percent: 35}, {id: "SCHD", percent: 65}] }
    };

    const DEFAULT_CONTENTS = {
        0: { title: "1ë‹¨ê³„. Intro", content: `<div class="text-center py-20"><h1 style="border:none">ë³´í†µì‚¬ëŒì˜ ê°€ì¥ ì‰¬ìš´ ì¬í…Œí¬</h1><p class="text-xl text-slate-600">ë…¸í›„ê¹Œì§€ ëˆ ê±±ì •ì—†ëŠ” ì‹œìŠ¤í…œ ë§Œë“¤ê¸°</p><div class="mt-10 p-6 bg-blue-50 rounded text-blue-800 text-sm">ğŸ‘ˆ ì™¼ìª½ ë©”ë‰´ í•˜ë‹¨ <strong>[ğŸ‘¨â€ğŸ« í†µí•© ì›ê³  ì—…ë¡œë“œ]</strong> ë²„íŠ¼ì„ ì´ìš©í•´<br>ë©”ëª¨ì¥ íŒŒì¼(.txt)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div></div>` },
    };

    const STEPS = ["Intro", "ë…¸í›„ìƒí™œ ê·¸ë ¤ë³´ê¸°", "ê¸°ë³¸ì •ë³´ ì…ë ¥", "ì–¼ë§ˆê°€ í•„ìš”í• ê¹Œ", "ì ë¦½ì‹ íˆ¬ìê³„íš", "ì€í‡´ì „ í¬íŠ¸í´ë¦¬ì˜¤", "ì—°ê¸ˆì¸ì¶œ ê³„íš", "ë‚´ íˆ¬ìì„±í–¥ íŒŒì•…", "ì€í‡´í›„ í¬íŠ¸í´ë¦¬ì˜¤", "ëŒ€ì±…ìˆ˜ë¦½", "ìš”ì•½"];
    const STEP_LABELS = STEPS.map((s, i) => `${i+1}ë‹¨ê³„. ${s}`);
    const AGE_GROUPS_KEYS = ["20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€"]; 

    const EXPENSE_DETAILS = [
        { cat: "ì£¼ê±°ë¹„", items: [ { key: "housing_maint", name: "ê´€ë¦¬ë¹„/ê³µê³¼ê¸ˆ", avg: "30ë§Œì›" }, { key: "housing_rent", name: "ì›”ì„¸/ì„ëŒ€ë£Œ", avg: "0ì›" }, { key: "housing_loan", name: "ì£¼íƒëŒ€ì¶œì´ì", avg: "0ì›" } ]},
        { cat: "ì‹ë¹„", items: [ { key: "food_grocery", name: "ì‹ì¬ë£Œë¹„", avg: "50ë§Œì›" }, { key: "food_out", name: "ì™¸ì‹ë¹„", avg: "20ë§Œì›" } ]},
        { cat: "ì˜ë£Œë¹„", items: [ { key: "med_insurance", name: "ë³´ì¥ì„± ë³´í—˜ë£Œ", avg: "30ë§Œì›" }, { key: "med_hospital", name: "ë³‘ì›/ì•½ì œë¹„", avg: "10ë§Œì›" } ]},
        { cat: "í™œë™ë¹„", items: [ { key: "trans_comm", name: "êµí†µ/í†µì‹ ë¹„", avg: "20ë§Œì›" }, { key: "leisure", name: "ì—¬ê°€/ì·¨ë¯¸", avg: "30ë§Œì›" }, { key: "social", name: "ê²½ì¡°ì‚¬/ëª¨ì„", avg: "20ë§Œì›" } ]},
        { cat: "ê¸°íƒ€", items: [ { key: "tax", name: "ì„¸ê¸ˆ/ê¸°íƒ€", avg: "10ë§Œì›" }, { key: "reserve", name: "ì˜ˆë¹„ë¹„", avg: "10ë§Œì›" } ]}
    ];
    const ALL_EXPENSE_KEYS = EXPENSE_DETAILS.flatMap(c => c.items.map(i => i.key));

    const AssetChart = ({ targetAmount, savedAmount, label1, label2 }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);
        useEffect(() => {
            if (!canvasRef.current) return;
            const ctx = canvasRef.current.getContext('2d');
            if (chartRef.current) chartRef.current.destroy();
            chartRef.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ìê¸ˆ ë¹„êµ'],
                    datasets: [
                        { label: label1, data: [targetAmount], backgroundColor: 'rgba(239, 68, 68, 0.5)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 },
                        { label: label2, data: [savedAmount], backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (v) => v / 10000 + 'ì–µ' } } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [targetAmount, savedAmount, label1, label2]);
        return <div style={{ height: '250px' }}><canvas ref={canvasRef}></canvas></div>;
    };

// [ìˆ˜ì • 1] ìë™ë¶„ë°° ê³„ì‚° í•¨ìˆ˜ (ìˆ«ì ë³€í™˜ ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
    const calculateDistributionLogic = (inputTotal) => {
        // ì…ë ¥ê°’ì„ ë¬´ì¡°ê±´ ìˆ«ìë¡œ ë³€í™˜ (ì˜¤ë¥˜ ë°©ì§€)
        let remaining = Number(inputTotal) || 0;
        
        // 1. ì—°ê¸ˆì €ì¶•1 (ìµœëŒ€ 50)
        let p1 = Math.min(remaining, 50);
        remaining = Math.max(0, remaining - p1);

        // 2. IRP (ìµœëŒ€ 25)
        let irp = Math.min(remaining, 25);
        remaining = Math.max(0, remaining - irp);

        // 3. ISA 1ì°¨ (ìµœëŒ€ 85)
        let isa1 = Math.min(remaining, 85);
        remaining = Math.max(0, remaining - isa1);

        // 4. ì—°ê¸ˆì €ì¶•2 (ìµœëŒ€ 75)
        let p2 = Math.min(remaining, 75);
        remaining = Math.max(0, remaining - p2);

        // 5. ISA 2ì°¨ (ìµœëŒ€ 81)
        let isa2 = Math.min(remaining, 81);
        remaining = Math.max(0, remaining - isa2);

        // 6. ì¼ë°˜ê³„ì¢Œ (ë‚˜ë¨¸ì§€ ì „ì•¡)
        let gen = remaining;

        // ë°˜í™˜: ISAëŠ” 1ì°¨+2ì°¨ í•©ì‚°í•˜ì—¬ ë°˜í™˜
        return { 
            pension1: p1, 
            irp: irp, 
            isa: isa1 + isa2, 
            pension2: p2, 
            general: gen, 
            other: 0 
        };
    };

    // --- ë©”ì¸ ì›Œí¬ë¶ ì»´í¬ë„ŒíŠ¸ ---
    const Workbook = () => {
        console.log("âœ… Workbook ì»´í¬ë„ŒíŠ¸ í˜¸ì¶œë¨!");
        console.log("ğŸ“Œ useState ì´ˆê¸°í™” ì‹œì‘");
        
        const [currentStep, setCurrentStep] = useState(0);
        const [viewMode, setViewMode] = useState('lecture'); 
        const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
        const fileInputRef = useRef(null);
        const contentInputRef = useRef(null);
        
        console.log("âœ… useState ì´ˆê¸°í™” ì™„ë£Œ, currentStep:", currentStep);
        
        // [ì¤‘ìš”] DEFAULT_USER_DATAë¥¼ ë¨¼ì € ì •ì˜
        const DEFAULT_USER_DATA = {
            dream: "", currentAge: 40, targetAge: 60, lifeAge: 90, inflation: 3,
            real_estate: 0, loan_collateral: 0, gold: 0, bitcoin: 0, cash: 0, 
            pension1: 0, pension2: 0, irp: 0, isa: 0, debt_credit: 0,
            pensions: { national:0, retirement:0, personal:0 },
            expenses: {}, expenseNotes: {}, 
            savingAmount: 50, investReturnRate: 6,
            ageStrategies: {}, portfolios: {},
            withdrawalPlan: {}, postRetirementReturnRate: 6,
            downsizingAge: 70, downsizingAmount: 0, useDownsizing: false,
            housingPensionAge: 75, housingPensionAmount: 0, useHousingPension: false
        };
        
        ALL_EXPENSE_KEYS.forEach(key => { if (DEFAULT_USER_DATA.expenses[key] === undefined) DEFAULT_USER_DATA.expenses[key] = 0; });
        AGE_GROUPS_KEYS.forEach(age => {
            if (!DEFAULT_USER_DATA.ageStrategies[age]) DEFAULT_USER_DATA.ageStrategies[age] = { monthlyTotal: 0, targetReturn: 6, autoDistribute: false, pension1: 0, irp: 0, isa: 0, pension2: 0, isa2: 0, general: 0, other: 0 };
            if (!DEFAULT_USER_DATA.portfolios[age]) DEFAULT_USER_DATA.portfolios[age] = { pension: [], irp: [], isa: [], general: [] };
        });

        console.log("ğŸ“Œ DEFAULT_USER_DATA ì´ˆê¸°í™” ì™„ë£Œ:", DEFAULT_USER_DATA);
        
        const [userData, setUserData] = React.useState(() => {
            console.log("ğŸ“Œ userData ì´ˆê¸°í™” ì‹œì‘");
            console.log("ğŸ“Œ EMBEDDED_DATA:", EMBEDDED_DATA ? "ì¡´ì¬" : "ì—†ìŒ");
            console.log("ğŸ“Œ DEFAULT_USER_DATA:", DEFAULT_USER_DATA ? "ì¡´ì¬" : "ì—†ìŒ");
            
            const initial = EMBEDDED_DATA ? EMBEDDED_DATA.userData : { ...DEFAULT_USER_DATA };
            
            console.log("ğŸ“Œ userData ì´ˆê¸°ê°’:", initial);
            console.log("ğŸ“Œ userData íƒ€ì…:", typeof initial);
            console.log("ğŸ“Œ userData.currentAge:", initial?.currentAge);
            
            // í™•ì‹¤í•˜ê²Œ DEFAULT_USER_DATA ë°˜í™˜
            return initial || { ...DEFAULT_USER_DATA };
        });
        const [contents, setContents] = useState(EMBEDDED_DATA ? EMBEDDED_DATA.contents : DEFAULT_CONTENTS);
        const [imageUrls, setImageUrls] = useState(EMBEDDED_DATA ? EMBEDDED_DATA.imageUrls : {});
        const [isLoaded, setIsLoaded] = useState(!!EMBEDDED_DATA);
        const [autoLoadStatus, setAutoLoadStatus] = useState('idle'); // 'idle', 'loading', 'success', 'error' 

        // [ìˆ˜ì •ë¨] ìë™ ë°ì´í„° ë¡œë”© (IndexedDB ìµœìš°ì„ , ê·¸ ë‹¤ìŒ EMBEDDED_DATA, ë§ˆì§€ë§‰ ZIP)
        useEffect(() => {
            const autoLoad = async () => {
                setAutoLoadStatus('loading');
                
                try {
                    // 1. ë¨¼ì € IndexedDB í™•ì¸ (ì‚¬ìš©ì ì—…ë¡œë“œ ë°ì´í„° ìš°ì„ !)
                    const savedData = await IDB.get('wb_data_v41');
                    const savedContents = await IDB.get('wb_contents_v41');
                    const savedImages = await IDB.get('wb_images_v41');
                    
                    console.log('ğŸ” IndexedDB í™•ì¸:', {
                        savedData: savedData ? 'ìˆìŒ' : 'ì—†ìŒ',
                        savedContents: savedContents ? `ìˆìŒ (${Object.keys(savedContents).length}ê°œ)` : 'ì—†ìŒ',
                        savedImages: savedImages ? `ìˆìŒ (${Object.keys(savedImages).length}ê°œ)` : 'ì—†ìŒ'
                    });
                    
                    // [í•µì‹¬ ìˆ˜ì •] DBì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš© (EMBEDDED_DATAë³´ë‹¤ ìš°ì„ !)
                    const hasContents = savedContents && Object.keys(savedContents).length > 0;
                    const hasImages = savedImages && Object.keys(savedImages).length > 0;
                    
                    if (hasContents || hasImages) {
                        console.log('âœ… IndexedDBì—ì„œ ì‚¬ìš©ì ì—…ë¡œë“œ ë°ì´í„° ë°œê²¬! (EMBEDDED_DATA ë¬´ì‹œ)');
                        if (savedData) {
                            console.log('ğŸ“Š savedData ë³‘í•© ì‹œì‘');
                            setUserData(prev => {
                                const merged = { ...DEFAULT_USER_DATA, ...prev, ...savedData };
                                console.log('ğŸ“Š ë³‘í•©ëœ userData:', merged);
                                return merged;
                            });
                        }
                        if (savedContents) {
                            console.log('ğŸ“ contents ë¡œë“œ:', Object.keys(savedContents).length, 'ê°œ');
                            setContents(savedContents);
                        }
                        if (savedImages) {
                            console.log('ğŸ–¼ï¸ images ë¡œë“œ:', Object.keys(savedImages).length, 'ê°œ');
                            setImageUrls(savedImages);
                        }
                        setAutoLoadStatus('success');
                        setIsLoaded(true);
                        return; // DBì—ì„œ ë¡œë“œ ì„±ê³µí•˜ë©´ ì¢…ë£Œ
                    }
                    
                    // 2. IndexedDBì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ EMBEDDED_DATA í™•ì¸
                    const currentEmbeddedData = window.EMBEDDED_DATA || EMBEDDED_DATA;
                    
                    if (currentEmbeddedData && (currentEmbeddedData.contents || currentEmbeddedData.imageUrls)) {
                        console.log('â„¹ï¸ IndexedDB ë¹„ì–´ìˆìŒ. EMBEDDED_DATA(ZIP) ì‚¬ìš©');
                        console.log('ğŸ“¦ currentEmbeddedData:', currentEmbeddedData);
                        
                        if (currentEmbeddedData.userData) {
                            setUserData(prev => ({ ...DEFAULT_USER_DATA, ...prev, ...currentEmbeddedData.userData }));
                        }
                        
                        const imgUrls = currentEmbeddedData.imageUrls || {};
                        
                        // ì´ë¯¸ì§€ ë¨¼ì € ì„¤ì •
                        if (currentEmbeddedData.imageUrls) {
                            console.log('ğŸ–¼ï¸ ZIP ì´ë¯¸ì§€ ì„¤ì •:', Object.keys(imgUrls).length, 'ê°œ');
                            setImageUrls(imgUrls);
                        }
                        
                        // contentsë¥¼ HTMLë¡œ í¬ë§·íŒ…
                        if (currentEmbeddedData.contents) {
                            console.log('ğŸ“ ZIP ì½˜í…ì¸  í¬ë§·íŒ… ì‹œì‘:', Object.keys(currentEmbeddedData.contents).length, 'ë‹¨ê³„');
                            const formattedContents = {};
                            Object.keys(currentEmbeddedData.contents).forEach(key => {
                                const item = currentEmbeddedData.contents[key];
                                if (item && item.content) {
                                    formattedContents[key] = {
                                        title: item.title,
                                        content: `<div class="smart-content fade-in">${formatTextToHtml(item.content, imgUrls)}</div>`
                                    };
                                }
                            });
                            setContents(formattedContents);
                            console.log('âœ… í¬ë§·íŒ… ì™„ë£Œ, IndexedDBì— ì €ì¥ ì¤‘...');
                            
                            // IndexedDBì— í¬ë§·íŒ…ëœ ë²„ì „ ì €ì¥
                            await IDB.put('wb_contents_v41', formattedContents);
                            await IDB.put('wb_images_v41', imgUrls);
                            console.log('ğŸ’¾ IndexedDB ì €ì¥ ì™„ë£Œ!');
                        }
                        
                        setAutoLoadStatus('success');
                        setIsLoaded(true);
                        return;
                    }
                    
                    // 3. IndexedDBë„ EMBEDDED_DATAë„ ì—†ìœ¼ë©´ ZIP íŒŒì¼ ì‹œë„
                    console.log('â„¹ï¸ IndexedDBì™€ EMBEDDED_DATA ëª¨ë‘ ì—†ìŒ. ZIP íŒŒì¼ í™•ì¸ ì¤‘...');
                    const response = await fetch('./workbook-data.zip');
                    if (!response.ok) throw new Error('ZIP íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();
                    
                    // 3. ZIP ì••ì¶• í•´ì œ
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    
                    // 4. í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
                    const textFiles = [];
                    const imageFiles = [];
                    
                    for (const [filename, file] of Object.entries(zip.files)) {
                        if (file.dir) continue;
                        
                        if (filename.toLowerCase().endsWith('.txt')) {
                            const content = await file.async('text');
                            textFiles.push({ name: filename, content });
                        } else if (/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(filename)) {
                            const blob = await file.async('blob');
                            imageFiles.push({ name: filename, blob });
                        }
                    }
                    
                    // 5. í…ìŠ¤íŠ¸ íŒŒì‹±
                    const newContents = { ...contents };
                    textFiles.forEach(({ name, content }) => {
                        const match = name.match(/(\d+)ë‹¨ê³„/);
                        if (match) {
                            const stepNum = parseInt(match[1]);
                            newContents[stepNum] = { title: `${stepNum}ë‹¨ê³„`, content: content };
                        }
                    });
                    
                    // 6. ì´ë¯¸ì§€ ì²˜ë¦¬
                    const newImageMap = {};
                    for (const { name, blob } of imageFiles) {
                        const reader = new FileReader();
                        await new Promise((resolve) => {
                            reader.onload = (e) => {
                                const fileName = name.split('/').pop().split('\\').pop();
                                const cleanName = fileName.replace(/\.[^/.]+$/, '').toLowerCase().replace(/[\s_\-()]+/g, '');
                                newImageMap[cleanName] = e.target.result;
                                resolve();
                            };
                            reader.readAsDataURL(blob);
                        });
                    }
                    
                    // 7. ì´ë¯¸ì§€ ë§¤ì¹­ ë° HTML ë³€í™˜
                    Object.keys(newContents).forEach(key => {
                        if (newContents[key] && newContents[key].content) {
                            newContents[key].content = formatTextToHtml(newContents[key].content, newImageMap);
                        }
                    });
                    
                    // 8. State ì—…ë°ì´íŠ¸
                    setContents(newContents);
                    setImageUrls(newImageMap);
                    
                    // [ìˆ˜ì •ë¨] IndexedDBì— ì €ì¥í•˜ì—¬ ë‹¤ìŒì—ë„ ìœ ì§€ë˜ë„ë¡ í•¨
                    await Promise.all([
                        IDB.put('wb_contents_v41', newContents),
                        IDB.put('wb_images_v41', newImageMap)
                    ]);
                    
                    setAutoLoadStatus('success');
                    console.log('âœ… ZIP íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ ë° IndexedDBì— ì €ì¥ ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    setAutoLoadStatus('error');
                } finally {
                    setIsLoaded(true);
                }
            };
            
            autoLoad();
        }, []);

        // ë°ì´í„° ìë™ ì €ì¥
        useEffect(() => {
            if (EMBEDDED_DATA || !isLoaded) return;
            const timer = setTimeout(() => { IDB.put('wb_data_v41', userData); }, 1000);
            return () => clearTimeout(timer);
        }, [userData, isLoaded]);

        useEffect(() => {
            if (EMBEDDED_DATA || !isLoaded) return;
            const timer = setTimeout(() => { IDB.put('wb_contents_v41', contents); }, 1000);
            return () => clearTimeout(timer);
        }, [contents, isLoaded]);

        // [ìˆ˜ì •ë¨] ì´ë¯¸ì§€ ìë™ ì €ì¥ ì¶”ê°€
        useEffect(() => {
            if (EMBEDDED_DATA || !isLoaded) return;
            const timer = setTimeout(() => { IDB.put('wb_images_v41', imageUrls); }, 1000);
            return () => clearTimeout(timer);
        }, [imageUrls, isLoaded]);

        const calculations = useMemo(() => {
            // ì•ˆì „ ì¥ì¹˜: userDataê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì‚¬ìš©
            const safeUserData = userData || DEFAULT_USER_DATA;
            console.log("ğŸ“Š calculations ì‹¤í–‰, userData:", safeUserData ? "ì¡´ì¬" : "ì—†ìŒ");
            
            if (!safeUserData) {
                console.error("âŒ userDataê°€ ì—†ìŠµë‹ˆë‹¤!");
                return {
                    netRealAsset: 0, netFinancialAsset: 0, totalNetWorth: 0,
                    totalMonthlyExpense: 0, yearsLeft: 0, retirementYears: 0, futureMonthlyExpense: 0,
                    npsRows: [], myNPS: 0, monthlyGap: 0, requiredLumpSum: 0,
                    futureSavings: 0, futureCurrentAssets: 0, totalPrepared: 0
                };
            }
            
            const netRealAsset = (safeUserData.real_estate || 0) - (safeUserData.loan_collateral || 0);
            const netFinancialAsset = ((safeUserData.bitcoin||0) + (safeUserData.cash||0) + (safeUserData.pension1||0) + (safeUserData.pension2||0) + (safeUserData.irp||0) + (safeUserData.isa||0)) - (safeUserData.debt_credit||0);
            const totalNetWorth = netRealAsset + netFinancialAsset;
            
            const totalMonthlyExpense = Object.values(safeUserData.expenses || {}).reduce((a, b) => a + b, 0);
            const yearsLeft = Math.max(0, (safeUserData.targetAge || 60) - (safeUserData.currentAge || 40));
            const retirementYears = Math.max(0, (safeUserData.lifeAge || 90) - (safeUserData.targetAge || 60));
            const futureMonthlyExpense = totalMonthlyExpense * Math.pow(1 + (safeUserData.inflation||3)/100, yearsLeft);

            const baseAmount = (safeUserData.pensions && safeUserData.pensions.national) || 0; 
            const npsRows = [];
            for (let age = 60; age <= 70; age++) {
                let rate = 0;
                if (age < 65) rate = (age - 65) * 6;
                if (age > 65) rate = (age - 65) * 7.2;
                const adjustedBase = baseAmount * (1 + rate / 100);
                const yearsToReceive = Math.max(0, age - (safeUserData.currentAge || 40));
                const inflationFactor = Math.pow(1 + (safeUserData.inflation||3)/100, yearsToReceive);
                const finalAmount = Math.round(adjustedBase * inflationFactor);
                npsRows.push({ age, rate, amount: finalAmount });
            }
            const targetNpsData = npsRows.find(r => r.age === (safeUserData.targetAge || 60));
            const myNPS = targetNpsData ? targetNpsData.amount : 0; 

            const monthlyGap = Math.max(0, futureMonthlyExpense - myNPS);
            const requiredLumpSum = monthlyGap * 12 * retirementYears;
            
            const globalMonthlyRate = ((safeUserData.investReturnRate || 6) / 100) / 12;
            const globalMonths = yearsLeft * 12;
            const safePrincipal = (safeUserData.bitcoin || 0) + (safeUserData.cash || 0); 
            const investPrincipal = netFinancialAsset - safePrincipal; 
            const fvInvest = investPrincipal * Math.pow(1 + globalMonthlyRate, globalMonths);
            const fvSafe = safePrincipal;
            const futureCurrentAssets = fvInvest + fvSafe; 
            const futureSavings = (safeUserData.savingAmount || 50) * ( (Math.pow(1 + globalMonthlyRate, globalMonths) - 1) / globalMonthlyRate );
            const totalPrepared = futureSavings + futureCurrentAssets;

            return {
                netRealAsset, netFinancialAsset, totalNetWorth,
                totalMonthlyExpense, yearsLeft, retirementYears, futureMonthlyExpense,
                npsRows, myNPS, monthlyGap, requiredLumpSum, 
                futureSavings, futureCurrentAssets, totalPrepared
            };
        }, [userData]);

        const ageIntervals = useMemo(() => {
            // ì•ˆì „ ì¥ì¹˜: userDataê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
            if (!userData) {
                console.warn("âš ï¸ ageIntervals: userDataê°€ ì—†ìŒ");
                return [];
            }
            
            const intervals = [];
            let start = userData.currentAge || 40;
            let totalYearsPassed = 0;
            let runningBalances = { pension1: userData.pension1 || 0, irp: userData.irp || 0, isa: userData.isa || 0, pension2: userData.pension2 || 0, general: 0, other: (userData.bitcoin || 0) + (userData.cash || 0) };
            
            let cumulativePrincipal = { 
                pension1: userData.pension1 || 0, 
                irp: userData.irp || 0, 
                isa: userData.isa || 0, 
                pension2: userData.pension2 || 0, 
                general: 0, 
                other: (userData.bitcoin || 0) + (userData.cash || 0) 
            };

            let globalYearCounter = 0; 

            while (start < (userData.targetAge || 60)) {
                let nextDecade = (Math.floor(start / 10) + 1) * 10;
                let end = nextDecade - 1;
                if (end >= userData.targetAge) end = userData.targetAge; 
                if (start > end) break;

                const ageKey = `${Math.floor(start/10)}0ëŒ€`;
                const strategy = userData.ageStrategies[ageKey] || { monthlyTotal: 0, targetReturn: 6, pension1:0, irp:0, isa:0, pension2:0, general:0, other:0 };
                const monthlyRate = (strategy.targetReturn / 100) / 12; 
                const yearsInInterval = end - start + 1;

                for (let y = 1; y <= yearsInInterval; y++) {
                    globalYearCounter++;
                    for (let m = 0; m < 12; m++) {
                        ['pension1', 'irp', 'isa', 'pension2', 'general'].forEach(key => {
                            let monthlyContrib = strategy[key] || 0;
                            cumulativePrincipal[key] += monthlyContrib; 
                            
                            let interest = runningBalances[key] * monthlyRate;
                            runningBalances[key] += interest + monthlyContrib;
                        });
                        let otherContrib = strategy.other || 0;
                        cumulativePrincipal.other += otherContrib;
                        runningBalances.other += otherContrib; 
                    }
                    if (globalYearCounter % 3 === 0) { // 3ë…„ ì£¼ê¸°ë¡œ ë³€ê²½
                        const isaTotal = runningBalances.isa;
                        const isaProfit = Math.max(0, isaTotal - cumulativePrincipal.isa);
                        
                        const taxableProfit = Math.max(0, isaProfit - 200); 
                        const tax = taxableProfit * 0.099; 
                        const transferAmount = isaTotal - tax;
                        
                        runningBalances.pension2 += transferAmount;
                        cumulativePrincipal.pension2 += transferAmount; 

                        runningBalances.isa = 0;
                        cumulativePrincipal.isa = 0;
                    }
                }
                const totalEndAsset = Object.values(runningBalances).reduce((a,b)=>a+b, 0);
                const realValue = totalEndAsset / Math.pow(1 + userData.inflation/100, totalYearsPassed + yearsInInterval);
                intervals.push({ 
                    range: `${start}ì„¸ ~ ${end}ì„¸`, ageKey: ageKey, startAge: start, endAge: end, 
                    monthlyTotal: strategy.monthlyTotal, targetReturn: strategy.targetReturn, 
                    endBalances: { ...runningBalances }, 
                    cumulativePrincipal: { ...cumulativePrincipal }, 
                    totalEndAsset: totalEndAsset, realAsset: realValue 
                });
                start = end + 1;
                totalYearsPassed += yearsInInterval;
            }
            return intervals;
        }, [userData]);

        // Loading Check
        if (!isLoaded) return <div className="flex h-screen items-center justify-center text-xl font-bold text-slate-500">ğŸ“š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>;

        const updateNum = (k, v) => setUserData(p => ({...p, [k]: Number(v)}));
        const updateStr = (k, v) => setUserData(p => ({...p, [k]: v}));
        const updateExpenseVal = (key, val) => setUserData(p => ({...p, expenses: {...p.expenses, [key]: Number(val)}}));
        const updateExpenseNote = (key, val) => setUserData(p => ({...p, expenseNotes: {...p.expenseNotes, [key]: val}}));
        const updatePension = (k, v) => setUserData(p => ({...p, pensions: {...p.pensions, [k]: Number(v)}}));
        
        const updateAgeStrategy = (ageKey, field, value) => {
            setUserData(prev => {
                const newStrategies = { ...prev.ageStrategies };
                const currentAgeData = { ...newStrategies[ageKey] };
                if (field === 'autoDistribute' && value === true) {
                    currentAgeData.autoDistribute = true;
                    const dist = calculateDistributionLogic(currentAgeData.monthlyTotal);
                    Object.assign(currentAgeData, dist);
                } else if (field === 'monthlyTotal' && currentAgeData.autoDistribute) {
                    currentAgeData.monthlyTotal = Number(value);
                    const dist = calculateDistributionLogic(Number(value));
                    Object.assign(currentAgeData, dist);
                } else {
                    if (field === 'monthlyTotal') currentAgeData[field] = Number(value);
                    else if (field === 'targetReturn') currentAgeData[field] = Number(value);
                    else if (field === 'autoDistribute') currentAgeData.autoDistribute = false;
                    else {
                        currentAgeData[field] = Number(value);
                        currentAgeData.autoDistribute = false;
                    }
                }
                newStrategies[ageKey] = currentAgeData;
                return { ...prev, ageStrategies: newStrategies };
            });
        };

        const updatePortfolio = (ageKey, accountType, newList) => {
            setUserData(prev => {
                const newPortfolios = { ...prev.portfolios };
                if (!newPortfolios[ageKey]) newPortfolios[ageKey] = { pension: [], irp: [], isa: [], general: [] };
                newPortfolios[ageKey][accountType] = newList;
                return { ...prev, portfolios: newPortfolios };
            });
        };

        const applyRecommended = () => {
            if(confirm("ê¸°ì¡´ì— ì…ë ¥í•œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ê³  ê¶Œì¥ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ì¬ì„¤ì •ë©ë‹ˆë‹¤.\nê³„ì† í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                setUserData(prev => {
                    const newPortfolios = { ...prev.portfolios };
                    AGE_GROUPS_KEYS.forEach(age => {
                        newPortfolios[age] = RECOMMENDED_PORTFOLIOS[age] 
                            ? JSON.parse(JSON.stringify(RECOMMENDED_PORTFOLIOS[age])) 
                            : { pension: [], irp: [], isa: [], general: [] };
                    });
                    return { ...prev, portfolios: newPortfolios };
                });
                alert("ê¶Œì¥ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };

        const handleSaveFile = () => {
            const blob = new Blob([JSON.stringify(userData)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url; link.download = `ë…¸í›„ì¤€ë¹„_ë°ì´í„°_${new Date().toLocaleDateString().replace(/\./g,'')}.json`; link.click();
        };
        const handleLoadClick = () => fileInputRef.current.click();
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
        const handleFileChange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { try { setUserData(JSON.parse(e.target.result)); alert("ë°ì´í„° ë¡œë“œ ì™„ë£Œ!"); } catch(err) { alert("íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜"); } };
            reader.readAsText(file); e.target.value = '';
        };
        const handleContentUploadClick = () => contentInputRef.current.click();
// [ìˆ˜ì •ë¨ 2] í…ìŠ¤íŠ¸ í¬ë§·íŒ… í•¨ìˆ˜ (ì´ˆê°•ë ¥ ì´ë¯¸ì§€ ë§¤ì¹­ + ì§„ë‹¨ í‘œì‹œ)
        const formatTextToHtml = (text, imgMap) => {
            let html = text.replace(/\r\n/g, "\n").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // ì´ë¯¸ì§€ ì¹˜í™˜ (í™•ì¥ì, ê³µë°± ë¬´ì‹œí•˜ê³  ì´ë¦„ë§Œ ê°™ìœ¼ë©´ ë§¤ì¹­)
            html = html.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, (m, f) => { 
                const rawName = f.trim();
                // ë¹„êµë¥¼ ìœ„í•´ ì´ë¦„ì—ì„œ í™•ì¥ì(.jpg ë“±)ì™€ ê³µë°±ì„ ëª¨ë‘ ì œê±°í•˜ê³  ì†Œë¬¸ìë¡œ ë³€í™˜
                const cleanTarget = rawName.replace(/\.[^/.]+$/, "").replace(/\s/g, "").toLowerCase();
                
                const uploadedFiles = Object.keys(imgMap);
                
                // ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì¤‘ì—ì„œ 'í•µì‹¬ ì´ë¦„'ì´ ê°™ì€ ê²ƒì„ ì°¾ìŒ
                const matchedKey = uploadedFiles.find(key => {
                    const cleanKey = key.replace(/\.[^/.]+$/, "").replace(/\s/g, "").toLowerCase();
                    return cleanKey === cleanTarget;
                });

                if (matchedKey) {
                    return `<img src="${imgMap[matchedKey]}" alt="${rawName}" class="mx-auto rounded-lg shadow-md my-8 transition-transform hover:scale-[1.02]" style="max-height: 500px; width: auto;" />`;
                } else {
                    // ëª» ì°¾ì•˜ì„ ë•Œ ë‚˜ì˜¤ëŠ” ì§„ë‹¨ ë°•ìŠ¤
                    return `
                        <div class="text-red-500 border-2 border-red-300 bg-red-50 p-4 rounded-lg text-center my-6 text-sm">
                            <strong class="text-lg block mb-2">âš ï¸ ì´ë¯¸ì§€ë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤</strong>
                            <div class="text-left bg-white p-2 rounded border text-slate-600 mb-2">
                                <div>ğŸ“ <strong>ì›ê³ ì— ì ì€ ê²ƒ:</strong> ${rawName}</div>
                                <div>ğŸ” <strong>ì°¾ëŠ” í•µì‹¬ ë‹¨ì–´:</strong> ${cleanTarget}</div>
                            </div>
                            <div class="text-left bg-blue-50 p-2 rounded border text-blue-800">
                                <div>ğŸ“‚ <strong>í˜„ì¬ ì €ì¥ëœ ì´ë¯¸ì§€ ëª©ë¡ (${uploadedFiles.length}ì¥):</strong></div>
                                <div class="text-xs mt-1 break-all">${uploadedFiles.length > 0 ? uploadedFiles.join(', ') : '(ì—†ìŒ. ì—…ë¡œë“œ ì‹œ ì‚¬ì§„ì„ ê°™ì´ ì„ íƒí•´ì£¼ì„¸ìš”!)'}</div>
                            </div>
                        </div>
                    `;
                }
            });

            // ë§í¬, ì œëª©, ìŠ¤íƒ€ì¼ ë“± ë‚˜ë¨¸ì§€ ë³€í™˜ ë¡œì§
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline decoration-2 hover:text-blue-800 font-bold transition-colors">$1</a>');
            html = html.replace(/(^|\n)!!![ \t]+(.*)/g, '\n<h1 class="text-3xl md:text-4xl font-black text-slate-900 mt-12 mb-8 pb-4 border-b-4 border-blue-500 leading-tight">$2</h1>\n');
            html = html.replace(/(^|\n)(##|Â¶)[ \t]+(.*)/g, '\n<h2 class="text-2xl md:text-3xl font-bold text-slate-800 mt-10 mb-5 pl-4 border-l-8 border-blue-600 leading-snug">$3</h2>\n');
            html = html.replace(/(^|\n)(###|â– )[ \t]+(.*)/g, '\n<h3 class="text-xl font-bold text-indigo-700 mt-8 mb-3 flex items-center gap-2"><span class="text-indigo-400 text-sm">â—</span> $3</h3>\n');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-700 font-extrabold bg-blue-50 px-1 py-0.5 rounded border border-blue-100">$1</strong>');
            html = html.replace(/\^\^(.*?)\^\^/g, '<span class="bg-yellow-200 text-yellow-900 px-1 py-0.5 rounded font-bold shadow-sm" style="box-decoration-break: clone;">$1</span>');
            html = html.replace(/(^|\n)-[ \t]+(.*)/g, '\n<li class="mb-2 text-lg text-slate-700 pl-2 border-l-2 border-slate-200 hover:border-blue-400 transition-colors">$2</li>\n');

            return html.split(/\n\s*\n/).map(p => {
                const t = p.trim(); 
                if(!t) return "";
                if(t.startsWith('<h') || t.startsWith('<img') || t.startsWith('<div')) return t;
                if(t.startsWith('<li')) return `<ul class="list-none my-6 space-y-1">${t}</ul>`;
                return `<p class="text-lg leading-relaxed text-slate-700 mb-6 text-justify break-keep font-medium">${t.replace(/\n/g, '<br>')}</p>`;
            }).join('');
        };
// [ìˆ˜ì •ë¨ 3] íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜ (ëŒ€ëŸ‰ íŒŒì¼ìš©: ìˆœì°¨ ì²˜ë¦¬ + ë©”ëª¨ë¦¬ ë³´í˜¸)
        const handleContentFiles = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // ë¡œë”© ë©”ì‹œì§€ ë„ìš°ê¸°
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loading-overlay';
            loadingMsg.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;font-size:1.2rem;text-align:center;">
                    <span style="font-size:3rem;margin-bottom:20px;">ğŸ¢</span>
                    <span id="loading-text">íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>ì–‘ì´ ë§ìœ¼ë©´ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦½ë‹ˆë‹¤.</span>
                </div>`;
            document.body.appendChild(loadingMsg);
            const loadingText = document.getElementById('loading-text');

            setTimeout(async () => {
                try {
                    let allFiles = [...files];
                    
                    // ZIP íŒŒì¼ ì²˜ë¦¬
                    const zipFiles = files.filter(f => f.name.toLowerCase().endsWith('.zip'));
                    if (zipFiles.length > 0) {
                        if (loadingText) loadingText.innerHTML = 'ğŸ“¦ ì••ì¶• íŒŒì¼ì„ í’€ê³  ìˆìŠµë‹ˆë‹¤...';
                        
                        for (const zipFile of zipFiles) {
                            const arrayBuffer = await zipFile.arrayBuffer();
                            const zip = await JSZip.loadAsync(arrayBuffer);
                            
                            const extractedFiles = [];
                            for (const [filename, file] of Object.entries(zip.files)) {
                                if (file.dir) continue; // í´ë”ëŠ” ê±´ë„ˆë›°ê¸°
                                
                                const blob = await file.async('blob');
                                const newFile = new File([blob], filename, { type: blob.type });
                                extractedFiles.push(newFile);
                            }
                            
                            allFiles = allFiles.filter(f => f !== zipFile).concat(extractedFiles);
                        }
                    }
                    
                    // 1. íŒŒì¼ ë¶„ë¥˜
                    const textFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.txt'));
                    const imageFiles = allFiles.filter(f => f.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name));

                    let newImageMap = { ...imageUrls }; // ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€
                    let successCount = 0;
                    let failCount = 0;

                    // 2. [í•µì‹¬ ë³€ê²½] ì´ë¯¸ì§€ë¥¼ í•œ ì¥ì”© ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ (ë©”ëª¨ë¦¬ í­ì£¼ ë°©ì§€)
                    for (let i = 0; i < imageFiles.length; i++) {
                        const file = imageFiles[i];
                        
                        // ì§„í–‰ìƒí™© í‘œì‹œ ì—…ë°ì´íŠ¸
                        if (loadingText) loadingText.innerHTML = `ì´ë¯¸ì§€ ì €ì¥ ì¤‘... (${i + 1} / ${imageFiles.length})<br><span style="font-size:0.8rem; opacity:0.7;">${file.name}</span>`;

                        try {
                            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì´ìƒì€ ê²½ê³  í›„ ê±´ë„ˆë›°ê±°ë‚˜ ì²˜ë¦¬)
                            if (file.size > 10 * 1024 * 1024) {
                                console.warn(`âš ï¸ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤(10MB ì´ˆê³¼): ${file.name}`);
                            }
                            
                            const base64Data = await fileToBase64(file);
                            newImageMap[file.name] = base64Data;
                            successCount++;
                            
                            // ë¸Œë¼ìš°ì €ê°€ ìˆ¨ ì‰´ í‹ˆì„ ì£¼ê¸° (ëŒ€ëŸ‰ ì²˜ë¦¬ ì‹œ í•„ìˆ˜)
                            if (i % 10 === 0) await new Promise(r => setTimeout(r, 10)); 

                        } catch (err) {
                            console.error(`ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨: ${file.name}`, err);
                            failCount++;
                        }
                    }

                    // 3. í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
                    let newContents = { ...contents };
                    let textUpdateCount = 0;

                    if (textFiles.length > 0) {
                        if (loadingText) loadingText.innerHTML = "ì›ê³  ë‚´ìš©ì„ ë°˜ì˜í•˜ëŠ” ì¤‘...";
                        for (const file of textFiles) {
                            const text = await file.text();
                            const sections = text.split(/\[\s*(\d+)\s*ë‹¨ê³„\s*\]|\[\s*(Intro|0)\s*\]/i);
                            
                            if (sections.length > 1) {
                                for (let i = 1; i < sections.length; i += 3) {
                                    const marker = sections[i] || sections[i + 1];
                                    const content = sections[i + 2];
                                    let idx = -1;
                                    if (marker && (marker.toLowerCase().includes('intro') || marker === '0')) idx = 0;
                                    else if (marker) idx = parseInt(marker) - 1;

                                    if (idx >= 0 && idx < STEPS.length && content) {
                                        // ì—¬ê¸°ì„œ ì´ë¯¸ì§€ë¥¼ ë°”ë¡œ ì—°ê²°
                                        newContents[idx] = { 
                                            title: STEP_LABELS[idx], 
                                            content: `<div class="smart-content fade-in">${formatTextToHtml(content, newImageMap)}</div>` 
                                        };
                                        textUpdateCount++;
                                    }
                                }
                            } else {
                                // í†µíŒŒì¼ì´ ì•„ë‹ ê²½ìš° (ê¸°ì¡´ ë¡œì§)
                                const match = file.name.match(/(\d+)/);
                                let idx = -1;
                                if (file.name.toLowerCase().includes('intro')) idx = 0;
                                else if (match) idx = parseInt(match[1]) - 1;
                                if (idx >= 0 && idx < STEPS.length) {
                                    newContents[idx] = { 
                                        title: STEP_LABELS[idx], 
                                        content: `<div class="smart-content fade-in">${formatTextToHtml(text, newImageMap)}</div>` 
                                    };
                                    textUpdateCount++;
                                }
                            }
                        }
                    }

                    // 4. ì €ì¥ ë° ì™„ë£Œ
                    if (loadingText) loadingText.innerHTML = "ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘...";
                    
                    setImageUrls(newImageMap);
                    setContents(newContents);

                    // [ìˆ˜ì •ë¨] IndexedDB ì €ì¥ - userDataë„ í•¨ê»˜ ì €ì¥!
                    await Promise.all([
                        IDB.put('wb_data_v41', userData),           // âœ… ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì¶”ê°€
                        IDB.put('wb_images_v41', newImageMap),
                        IDB.put('wb_contents_v41', newContents)
                    ]);

                    alert(`âœ… ì²˜ë¦¬ ì™„ë£Œ!\n------------------\nğŸ“· ì´ë¯¸ì§€: ${successCount}ì¥ ì €ì¥ ì„±ê³µ ` + (failCount > 0 ? `(${failCount}ì¥ ì‹¤íŒ¨)` : "") + `\nğŸ“ ì›ê³ : ${textUpdateCount}ê°œ ì±•í„° ì—…ë°ì´íŠ¸\n\nğŸ’¾ ë°ì´í„°ê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì–´ ë‹¤ìŒì—ë„ ìœ ì§€ë©ë‹ˆë‹¤!`);

                } catch (err) {
                    alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message + "\n(ì´ë¯¸ì§€ ìš©ëŸ‰ì´ ë„ˆë¬´ ì»¤ì„œ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)");
                } finally {
                    const loading = document.getElementById('loading-overlay');
                    if (loading) loading.remove();
                    e.target.value = '';
                }
            }, 100);
        };
const handleReset = () => { 
    if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ê³  ì²˜ìŒ ìƒíƒœë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
        setUserData(DEFAULT_USER_DATA); // ì—¬ê¸°ê°€ í•µì‹¬! ë¹ˆ ê°’ì´ ì•„ë‹ˆë¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
        setCurrentStep(0); 
        window.scrollTo(0,0);
    } 
};
        
        // --- PortfolioBuilder ì»´í¬ë„ŒíŠ¸ ---
        const PortfolioBuilder = ({ ageKey, accountType, title, availableETFs, portfolioData, onUpdate, targetReturn, isIRP = false }) => {
            const currentList = portfolioData || [];
            
            const calculatedReturn = currentList.reduce((acc, item) => {
                const etf = availableETFs.find(e => e.id === item.id);
                return acc + (etf ? etf.rate * (item.percent / 100) : 0);
            }, 0);

            const totalPercent = currentList.reduce((acc, item) => acc + item.percent, 0);

            const safeAssetPercent = currentList.reduce((acc, item) => {
                const etf = availableETFs.find(e => e.id === item.id);
                return acc + (etf && etf.name.startsWith("[ì•ˆì „]") ? item.percent : 0);
            }, 0);

            const addETF = (e) => {
                const etfId = e.target.value;
                if (!etfId) return;
                if (currentList.find(i => i.id === etfId)) return alert("ì´ë¯¸ ì¶”ê°€ëœ ì¢…ëª©ì…ë‹ˆë‹¤.");
                onUpdate(ageKey, accountType, [...currentList, { id: etfId, percent: 0 }]);
                e.target.value = "";
            };

            const updatePercent = (id, val) => {
                const newList = currentList.map(item => item.id === id ? { ...item, percent: Number(val) } : item);
                onUpdate(ageKey, accountType, newList);
            };

            const removeETF = (id) => {
                const newList = currentList.filter(item => item.id !== id);
                onUpdate(ageKey, accountType, newList);
            };

            return (
                <div className="bg-white border rounded-xl p-4 shadow-sm mb-4">
                    <div className="flex justify-between items-center mb-3 pb-2 border-b">
                        <h4 className="font-bold text-slate-700">{title}</h4>
                        <div className="text-sm">
                            <span className="text-slate-500 mr-2">ì˜ˆìƒ ìˆ˜ìµë¥ :</span>
                            <span className={`font-bold ${calculatedReturn >= targetReturn ? 'text-green-600' : 'text-red-500'}`}>
                                {calculatedReturn.toFixed(1)}%
                            </span>
                            <span className="text-xs text-slate-400 ml-1">(ëª©í‘œ: {targetReturn}%)</span>
                        </div>
                    </div>

                    <div className="mb-3">
                        <select className="w-full p-2 border rounded text-sm" onChange={addETF}>
                            <option value="">+ ETF ì¢…ëª© ì¶”ê°€í•˜ê¸°</option>
                            {availableETFs.map(etf => (
                                <option key={etf.id} value={etf.id}>[{etf.rate}%] {etf.name}</option>
                            ))}
                        </select>
                    </div>

                    <div className="space-y-2">
                        {currentList.map(item => {
                            const etf = availableETFs.find(e => e.id === item.id);
                            return (
                                <div key={item.id} className="flex items-center gap-2 text-sm bg-slate-50 p-2 rounded">
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-800">{etf?.name}</div>
                                        <div className="text-xs text-slate-500">{etf?.desc}</div>
                                    </div>
                                    <div className="w-20">
                                        <input type="number" value={item.percent} onChange={(e)=>updatePercent(item.id, e.target.value)} className="w-full border rounded p-1 text-right" placeholder="0" />
                                    </div>
                                    <span className="text-xs text-slate-500">%</span>
                                    <button onClick={()=>removeETF(item.id)} className="text-red-400 hover:text-red-600 px-1">âœ•</button>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="mt-2 flex flex-col items-end">
                        <div className="text-xs">
                            <span className={totalPercent !== 100 ? "text-red-500 font-bold" : "text-green-600 font-bold"}>
                                í•©ê³„: {totalPercent}%
                            </span>
                        </div>
                        {isIRP && safeAssetPercent < 30 && (
                            <div className="text-red-500 font-bold text-xs mt-1">
                                âš ï¸ ì•ˆì „ìì‚° ë¹„ìœ¨ì´ 30%ë¥¼ ë„˜ì–´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: {safeAssetPercent}%)
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const renderPracticeContent = () => {
            try {
                console.log("ğŸ¯ renderPracticeContent ì‹œì‘, currentStep:", currentStep);
                console.log("ğŸ“Š userData ìƒíƒœ:", userData ? "ì¡´ì¬" : "ì—†ìŒ");
                console.log("ğŸ“Š calculations ìƒíƒœ:", calculations ? "ì¡´ì¬" : "ì—†ìŒ");
                
                // [ìˆ˜ì •ë¨] calculations ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const safeCalc = calculations || {};
                const totalMonthlyExpense = safeCalc.totalMonthlyExpense || 0;
                const futureMonthlyExpense = safeCalc.futureMonthlyExpense || 0;
                const myNPS = safeCalc.myNPS || 0;
                const monthlyGap = safeCalc.monthlyGap || 0;
                const requiredLumpSum = safeCalc.requiredLumpSum || 0;
                const futureSavings = safeCalc.futureSavings || 0;
                const futureCurrentAssets = safeCalc.futureCurrentAssets || 0;
                const totalPrepared = safeCalc.totalPrepared || 0;
                const yearsLeft = safeCalc.yearsLeft || 0;
                const retirementYears = safeCalc.retirementYears || 0;
                const npsRows = safeCalc.npsRows || [];

                console.log("âœ… ë³€ìˆ˜ ì´ˆê¸°í™” ì™„ë£Œ");

                // ... ê¸°ì¡´ ì½”ë“œ (Step 0 ~ Step 5) ...
// â–¼â–¼â–¼ Intro ë‹¨ê³„: ê°„ë‹¨í•œ ì‹œì‘ í˜ì´ì§€ â–¼â–¼â–¼
                if (currentStep === 0) {
                    console.log("ğŸ“ Intro ë Œë”ë§");

                return (
                    <div className="text-center py-8 fade-in flex flex-col items-center justify-center min-h-screen px-4">
                        <div className="mb-12">
                            <div className="mb-6 animate-bounce"><span className="text-8xl">ğŸ‰</span></div>
                            <h1 className="text-4xl md:text-5xl font-black mb-6 text-slate-800 leading-tight">
                                ë³´í†µì‚¬ëŒì˜ ì¬í…Œí¬ ì‚¬ê´€í•™êµ
                            </h1>
                            <p className="text-2xl text-blue-600 font-bold mb-8">
                                ë…¸í›„ê¹Œì§€ ëˆ ê±±ì •ì—†ëŠ” ì‹œìŠ¤í…œ ë§Œë“¤ê¸°
                            </p>
                            <div className="max-w-2xl mx-auto p-6 bg-blue-50 rounded-xl border-2 border-blue-200">
                                <p className="text-lg text-slate-700 leading-relaxed">
                                    ğŸ‘ˆ ì™¼ìª½ ë©”ë‰´ í•˜ë‹¨ <strong className="text-blue-600">[ğŸ‘¨â€ğŸ« í†µí•© íŒŒì¼ ì—…ë¡œë“œ]</strong> ë²„íŠ¼ì„ ì´ìš©í•´<br/>
                                    ë©”ëª¨ì¥ íŒŒì¼(.txt)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
                                </p>
                            </div>
                        </div>

                        <div className="w-full max-w-md">
                            <button 
                                onClick={handleNext}
                                className="w-full px-12 py-6 rounded-2xl font-black text-2xl shadow-2xl transition-all flex items-center justify-center gap-3 transform hover:-translate-y-1 bg-gradient-to-r from-blue-600 to-indigo-700 text-white hover:shadow-3xl cursor-pointer"
                            >
                                <span>ì‹œì‘í•˜ê¸°</span> 
                                <span>â†’</span>
                            </button>
                        </div>
                    </div>
                );
            }
            // â–²â–²â–² Intro ë‹¨ê³„ ë â–²â–²â–²
            if (currentStep === 1 || STEPS[currentStep] === "ë…¸í›„ìƒí™œ") {
                console.log("ğŸ“ğŸ“ğŸ“ 1ë‹¨ê³„ (ë…¸í›„ìƒí™œ) ë Œë”ë§ ì‹œì‘ ğŸ“ğŸ“ğŸ“");
                console.log("ğŸ“Š userData:", userData);
                
                // [ì¤‘ìš”] userData ì•ˆì „ ì²˜ë¦¬
                const safeUserData = userData || { ...DEFAULT_USER_DATA };
                console.log("ğŸ“Š safeUserData:", safeUserData);
                
                // ë°ì´í„° ì—…ë°ì´íŠ¸ í—¬í¼
                const handleInput = (key, value) => {
                    console.log(`ğŸ“ handleInput í˜¸ì¶œ: ${key} = ${value}`);
                    setUserData(prev => ({ ...(prev || DEFAULT_USER_DATA), [key]: value }));
                };

                console.log("âœ… 1ë‹¨ê³„ return ì‹œì‘");
                return (
                        <div className="fade-in space-y-10 pb-10">
                        {/* ìƒë‹¨ í—¤ë” */}
                        <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl">
                            <h2 className="text-3xl font-bold mb-4">ğŸ¨ ë…¸í›„ í’ê²½ ìŠ¤ì¼€ì¹˜</h2>
                            <p className="opacity-90 text-lg leading-relaxed">
                                í–‰ë³µí•œ ì œ2ì˜ ì¸ìƒì€ ë§‰ì—°í•œ ê¸°ëŒ€ê°€ ì•„ë‹Œ, êµ¬ì²´ì ì¸ ìƒìƒì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.<br/>
                                ëˆ ê±±ì • ì´ì „ì— ë¨¼ì €, ì•„ë˜ 4ê°€ì§€ í…Œë§ˆë¥¼ í†µí•´ <strong>ë‚´ê°€ ì§„ì •ìœ¼ë¡œ ì‚´ê³  ì‹¶ì€ ì‚¶ì˜ í’ê²½</strong>ì„ ìƒìƒí•˜ê²Œ ê·¸ë ¤ë³´ì„¸ìš”.
                            </p>
                        </div>

                        {/* Theme 1. ê´€ê³„ì™€ ê³ ë… */}
                        <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold text-2xl text-slate-800 mb-8 border-b-2 border-slate-100 pb-4 flex items-center gap-3">
                                <span className="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-black">Theme 1</span>
                                ê´€ê³„ì™€ ê³ ë… (ëˆ„êµ¬ì™€ í•¨ê»˜ í•  ê²ƒì¸ê°€?)
                            </h3>
                            <div className="space-y-10">
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q1. ì§„ì •í•œ ì¹œêµ¬</label>
                                    <p className="text-base text-slate-600 mb-3">ì§€ê¸ˆ ë‹¹ì¥ ì•½ì† ì—†ì´ ì „í™”í•´ì„œ "ë°¥ ë¨¹ì"ê³  í•  ìˆ˜ ìˆëŠ” ì¹œêµ¬ 3ëª…ì˜ ì´ë¦„ì„ ì ì–´ë³´ì„¸ìš”.</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: í™ê¸¸ë™, ê¹€ì² ìˆ˜, ì´ì˜í¬"
                                        value={userData?.q_friends || ''} onChange={(e) => handleInput('q_friends', e.target.value)} />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <label className="block text-xl font-bold text-slate-800 mb-2">Q2. ë¶€ë¶€ ê´€ê³„ (ê±°ë¦¬ë‘ê¸°)</label>
                                        <p className="text-base text-slate-600 mb-3">ë°°ìš°ìì™€ í•˜ë£¨ 24ì‹œê°„ì„ ë³´ë‚¸ë‹¤ë©´, 'ë‚˜ë§Œì˜ ì‹œê°„'ì€ ëª‡ ì‹œê°„ í•„ìš”í• ê¹Œìš”?</p>
                                        <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            placeholder="ì˜ˆ: í•˜ë£¨ 3ì‹œê°„ì€ ì„œì¬ì—ì„œ í˜¼ì..."
                                            value={userData?.q_spouse_alone || ''} onChange={(e) => handleInput('q_spouse_alone', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-xl font-bold text-slate-800 mb-2">Q3. ë¶€ë¶€ ê´€ê³„ (í•¨ê»˜í•˜ê¸°)</label>
                                        <p className="text-base text-slate-600 mb-3">ë°°ìš°ìì™€ ë‹¨ë‘˜ì´ í•œ ë‹¬ ì‚´ê¸°ë¥¼ ë– ë‚œë‹¤ë©´, ì–´ëŠ ì§€ì—­ìœ¼ë¡œ ê°€ê³  ì‹¶ë‚˜ìš”?</p>
                                        <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                            placeholder="ì˜ˆ: ì œì£¼ë„, ë‚¨í•´, ì¹˜ì•™ë§ˆì´..."
                                            value={userData?.q_spouse_travel || ''} onChange={(e) => handleInput('q_spouse_travel', e.target.value)} />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q4. ê³ ë…ë ¥ (Solitude)</label>
                                    <p className="text-base text-slate-600 mb-3">ì¼ì£¼ì¼ ë™ì•ˆ ì•„ë¬´ë„ ë§Œë‚˜ì§€ ì•Šê³  í˜¼ì ì§€ë‚´ì•¼ í•œë‹¤ë©´, ë¬´ì—‡ì„ í•˜ë©° ì‹œê°„ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ë°€ë¦° ëŒ€í•˜ì†Œì„¤ ì½ê¸°, ë„·í”Œë¦­ìŠ¤ ì •ì£¼í–‰..."
                                        value={safeUserData.q_solitude || ''} onChange={(e) => handleInput('q_solitude', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q5. ìë…€ì™€ì˜ ê±°ë¦¬</label>
                                    <p className="text-base text-slate-600 mb-3">ìë…€(ë˜ëŠ” ì†ì£¼)ì™€ëŠ” ì¼ì£¼ì¼ì— ëª‡ ë²ˆ ì •ë„ ì—°ë½í•˜ê±°ë‚˜ ë§Œë‚˜ëŠ” ê²ƒì´ ì ë‹¹í•˜ë‹¤ê³  ìƒê°í•˜ë‚˜ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ì „í™”ëŠ” ì£¼ 1íšŒ, ë§Œë‚¨ì€ ì›” 1íšŒ"
                                        value={safeUserData.q_children || ''} onChange={(e) => handleInput('q_children', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {/* Theme 2. ì‹œê°„ê³¼ ì·¨ë¯¸ */}
                        <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold text-2xl text-slate-800 mb-8 border-b-2 border-slate-100 pb-4 flex items-center gap-3">
                                <span className="bg-green-100 text-green-600 px-3 py-1 rounded text-sm font-black">Theme 2</span>
                                ì‹œê°„ê³¼ ì·¨ë¯¸ (ë¬´ì—‡ì„ í•˜ë©° ë³´ë‚¼ ê²ƒì¸ê°€?)
                            </h3>
                            <div className="space-y-10">
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q6. ëª°ì…ì˜ ì¦ê±°ì›€</label>
                                    <p className="text-base text-slate-600 mb-3">ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥´ê³  ì§‘ì¤‘í•  ìˆ˜ ìˆëŠ”, ë‚˜ë§Œì˜ ì·¨ë¯¸ í™œë™ì´ ìˆë‚˜ìš”? (ì—†ë‹¤ë©´ ë°°ìš°ê³  ì‹¶ì€ ê²ƒì€?)</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ëª©ê³µ, í…ƒë°­ ê°€ê¾¸ê¸°, ìˆ˜ì˜..."
                                        value={userData.q_hobby || ''} onChange={(e) => handleInput('q_hobby', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q7. ë²„í‚·ë¦¬ìŠ¤íŠ¸</label>
                                    <p className="text-base text-slate-600 mb-3">ì²´ë ¥ê³¼ ëˆì´ í—ˆë½í•œë‹¤ë©´, ì£½ê¸° ì „ì— ê¼­ í•œë²ˆ í•´ë³´ê³  ì‹¶ì€ í•œ ê°€ì§€ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ì‚°í‹°ì•„ê³  ìˆœë¡€ê¸¸ ê±·ê¸°, ì˜¤ë¡œë¼ ë³´ê¸°..."
                                        value={userData.q_bucket || ''} onChange={(e) => handleInput('q_bucket', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q8. ë°°ì›€ì˜ ì—´ì •</label>
                                    <p className="text-base text-slate-600 mb-3">ì€í‡´ í›„ ìƒˆë¡­ê²Œ ë„ì „í•´ì„œ ìê²©ì¦ì„ ë”°ê±°ë‚˜ ê¹Šì´ ê³µë¶€í•´ë³´ê³  ì‹¶ì€ ë¶„ì•¼ê°€ ìˆë‚˜ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ë°”ë¦¬ìŠ¤íƒ€ ìê²©ì¦, ê³µì¸ì¤‘ê°œì‚¬, ì„œì–‘ë¯¸ìˆ ì‚¬..."
                                        value={userData.q_learning || ''} onChange={(e) => handleInput('q_learning', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {/* Theme 3. ê³µê°„ê³¼ í™˜ê²½ */}
                        <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold text-2xl text-slate-800 mb-8 border-b-2 border-slate-100 pb-4 flex items-center gap-3">
                                <span className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm font-black">Theme 3</span>
                                ê³µê°„ê³¼ í™˜ê²½ (ì–´ë””ì„œ ì‚´ ê²ƒì¸ê°€?)
                            </h3>
                            <div className="space-y-10">
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q9. ê±°ì£¼ì§€</label>
                                    <p className="text-base text-slate-600 mb-3">í˜„ì¬ ì‚¬ëŠ” ê³³ì—ì„œ ê³„ì† ì‚´ê³  ì‹¶ë‚˜ìš”, ì•„ë‹ˆë©´ ê·€ë†/ê·€ì´Œì´ë‚˜ ì‹¤ë²„íƒ€ìš´ ë“± ìƒˆë¡œìš´ ê³³ìœ¼ë¡œ ì´ì‚¬í•˜ê³  ì‹¶ë‚˜ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: í˜„ì¬ ì•„íŒŒíŠ¸ ìœ ì§€, ê°•ì›ë„ë¡œ ê·€ì´Œ..."
                                        value={userData.q_residence || ''} onChange={(e) => handleInput('q_residence', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q10. ê³µê°„ì˜ ì˜ë¯¸</label>
                                    <p className="text-base text-slate-600 mb-3">ë‚´ ì§‘ì—ì„œ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ê³µê°„(ì„œì¬, ë² ë€ë‹¤, ì£¼ë°© ë“±)ì€ ì–´ë””ì´ë©°, ê·¸ê³³ì„ ì–´ë–»ê²Œ ê¾¸ë¯¸ê³  ì‹¶ë‚˜ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ë² ë€ë‹¤ë¥¼ ë¯¸ë‹ˆ ì •ì›ê³¼ í‹°íƒ€ì„ ê³µê°„ìœ¼ë¡œ..."
                                        value={userData.q_space || ''} onChange={(e) => handleInput('q_space', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {/* Theme 4. ê°€ì¹˜ì™€ ìì•„ì‹¤í˜„ */}
                        <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold text-2xl text-slate-800 mb-8 border-b-2 border-slate-100 pb-4 flex items-center gap-3">
                                <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm font-black">Theme 4</span>
                                ê°€ì¹˜ì™€ ìì•„ì‹¤í˜„ (ì–´ë–¤ ì‚¬ëŒìœ¼ë¡œ ë‚¨ì„ ê²ƒì¸ê°€?)
                            </h3>
                            <div className="space-y-10">
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q11. ë‚˜ëˆ”ê³¼ ë´‰ì‚¬</label>
                                    <p className="text-base text-slate-600 mb-3">ë‚´ê°€ ê°€ì§„ ì¬ëŠ¥ì´ë‚˜ ê²½í—˜ ì¤‘, ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ë¬´ë£Œë¡œ ê°€ë¥´ì³ì£¼ê±°ë‚˜ ë² í’€ ìˆ˜ ìˆëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: ì—…ë¬´ ë©˜í† ë§, í•œê¸€ êµìœ¡ ë´‰ì‚¬..."
                                        value={userData.q_volunteer || ''} onChange={(e) => handleInput('q_volunteer', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q12. ê±´ê°• ëª©í‘œ</label>
                                    <p className="text-base text-slate-600 mb-3">ë‚´ ë°œë¡œ ê±¸ì–´ì„œ ì—¬í–‰í•  ìˆ˜ ìˆëŠ” ë‚˜ì´ë¥¼ ëª‡ ì„¸ê¹Œì§€ë¡œ ëª©í‘œí•˜ê³  ê³„ì‹ ê°€ìš”?</p>
                                    <input type="text" className="w-full border border-slate-300 rounded-lg p-4 text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="ì˜ˆ: 85ì„¸ê¹Œì§€ëŠ” ê±°ëœ¬í•˜ê²Œ!"
                                        value={userData.q_health_age || ''} onChange={(e) => handleInput('q_health_age', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xl font-bold text-slate-800 mb-2">Q13. ë¬˜ë¹„ëª… (Self-Epitaph)</label>
                                    <p className="text-base text-slate-600 mb-3">í›—ë‚  ì‚¬ëŒë“¤ì´ ë‹¹ì‹ ì„ ì–´ë–¤ ì‚¬ëŒìœ¼ë¡œ ê¸°ì–µí•´ì£¼ê¸¸ ë°”ë¼ë‚˜ìš”? (í•œ ë¬¸ì¥ìœ¼ë¡œ ì ì–´ë³´ì„¸ìš”)</p>
                                    <textarea className="w-full border border-slate-300 rounded-lg p-4 h-24 text-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                                        placeholder="ì˜ˆ: ë”°ëœ»í•œ ë¯¸ì†Œë¡œ ì´ì›ƒì—ê²Œ í˜ì´ ë˜ì–´ì£¼ì—ˆë˜ ì‚¬ëŒ, ì—¬ê¸° ì ë“¤ë‹¤."
                                        value={userData.q_epitaph || ''} onChange={(e) => handleInput('q_epitaph', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {/* ë§ˆì§€ë§‰ ì„¹ì…˜: ìƒìƒê³¼ ë‹¤ì§ (ì¥ë¬¸í˜•) */}
                        <div className="bg-indigo-50 p-8 rounded-xl border border-indigo-100 shadow-md">
                            <h3 className="font-bold text-2xl text-indigo-900 mb-8 border-b border-indigo-200 pb-4 flex items-center gap-2">
                                <span>ğŸ’­</span> ë¯¸ë˜ì˜ ë‚˜ë¥¼ ìƒìƒí•˜ê¸°
                            </h3>
                            <div className="space-y-10">
                                <div>
                                    <label className="block text-xl font-bold text-indigo-900 mb-2">
                                        Q14. ì€í‡´ í›„ ë‚˜ì˜ ì¼ìƒ (Daily Routine)
                                    </label>
                                    <p className="text-base text-indigo-700 mb-3">
                                        ì€í‡´ í›„ ë§ì´í•  í‰ë²”í•œ í•˜ë£¨ë¥¼ ì•„ì¹¨ ê¸°ìƒë¶€í„° ì ë“¤ ë•Œê¹Œì§€ ìƒìƒí•´ì„œ ì ì–´ë³´ì„¸ìš”.
                                    </p>
                                    <textarea 
                                        className="w-full border border-indigo-200 rounded-lg p-5 h-48 focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-lg leading-relaxed bg-white"
                                        placeholder="ì˜ˆ: ì•„ì¹¨ 7ì‹œì— ì¼ì–´ë‚˜ì„œ ê°€ë³ê²Œ ë’·ì‚°ì„ ì‚°ì±…í•˜ê³ , ì˜¤ì „ì—ëŠ” ë„ì„œê´€ì— ê°€ì„œ ì±…ì„ ì½ìŠµë‹ˆë‹¤. ì ì‹¬ì€..."
                                        value={userData.q_routine_essay || ''}
                                        onChange={(e) => handleInput('q_routine_essay', e.target.value)}
                                    />
                                </div>

                                <div>
                                    <label className="block text-xl font-bold text-indigo-900 mb-2">
                                        Q15. ë‚´ê°€ ìƒê°í•˜ëŠ” ì´ìƒì ì¸ ë…¸í›„ìƒí™œ
                                    </label>
                                    <p className="text-base text-indigo-700 mb-3">
                                        ì¬ì •ì ì¸ ê²ƒì„ ë„˜ì–´, ì–´ë–¤ íƒœë„ì™€ ëª¨ìŠµìœ¼ë¡œ ë…¸í›„ë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ ê°€ì¥ ì´ìƒì ì¼ê¹Œìš”?
                                    </p>
                                    <textarea 
                                        className="w-full border border-indigo-200 rounded-lg p-5 h-48 focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-lg leading-relaxed bg-white"
                                        placeholder="ì˜ˆ: ìë…€ë“¤ì—ê²Œ ì˜ì¡´í•˜ì§€ ì•Šê³  ë…ë¦½ì ì´ë©°, ì†Œì†Œí•œ ì¼ìƒì—ì„œ í–‰ë³µì„ ì°¾ê³  ë² í‘¸ëŠ” ì‚¶..."
                                        value={userData.q_ideal_life || ''}
                                        onChange={(e) => handleInput('q_ideal_life', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>

                    </div>
                );
            }
            // [3ë‹¨ê³„] ê¸°ë³¸ì •ë³´ ì…ë ¥ (ìˆ˜ì •ë¨: ì•ˆë‚´ ë¬¸êµ¬ ìƒì„¸í™”)
            // ----------------------------------------------------------------------
            if (currentStep === 2) {
                return (
                    <div className="fade-in space-y-12 pb-10">
                        {/* ì„¹ì…˜ 1: ê¸°ë³¸ ì •ë³´ */}
                        <div>
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 mb-8 rounded-r-lg shadow-sm">
                                <h3 className="text-lg font-bold text-blue-900 mb-2">ğŸ“‹ 1. ì¸ìƒ ì‹œê°„í‘œ ì„¤ì •</h3>
                                <p className="text-blue-800 leading-relaxed">
                                    ë³¸ê²©ì ì¸ ë…¸í›„ ì„¤ê³„ë¥¼ ìœ„í•´, ê°€ì¥ ê¸°ì´ˆì ì¸ ì‹œê°„í‘œë¥¼ ì„¤ì •í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.<br/>
                                    <strong>í˜„ì¬ ë‚˜ì´</strong>ì™€ <strong>ì€í‡´ ëª©í‘œ ë‚˜ì´</strong>, ê·¸ë¦¬ê³  ë‚´ê°€ ì˜ˆìƒí•˜ëŠ” <strong>ê¸°ëŒ€ ìˆ˜ëª…</strong>ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br/>
                                    ì´ ì •ë³´ëŠ” ì•ìœ¼ë¡œ ì§„í–‰ë  ëª¨ë“  ì‹œë®¬ë ˆì´ì…˜ì˜ ê¸°ì¤€ì ì´ ë©ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                <div className="input-group">
                                    <label>í˜„ì¬ ë‚˜ì´</label>
                                    <input type="number" value={userData?.currentAge || 40} onChange={(e)=>updateNum('currentAge', e.target.value)} />
                                </div>
                                <div className="input-group">
                                    <label>ì€í‡´ ëª©í‘œ ë‚˜ì´</label>
                                    <input type="number" value={userData?.targetAge || 60} onChange={(e)=>updateNum('targetAge', e.target.value)} />
                                </div>
                                <div className="input-group">
                                    <label>ê¸°ëŒ€ ìˆ˜ëª…</label>
                                    <input type="number" value={userData?.lifeAge || 90} onChange={(e)=>updateNum('lifeAge', e.target.value)} />
                                </div>
                                <div className="input-group">
                                    <label>ì˜ˆìƒ ë¬¼ê°€ìƒìŠ¹ë¥ (%)</label>
                                    <input type="number" value={userData?.inflation || 3} onChange={(e)=>updateNum('inflation', e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {/* ì„¹ì…˜ 2: ìì‚° í˜„í™© */}
                        <div>
                            <div className="bg-green-50 border-l-4 border-green-500 p-6 mb-8 rounded-r-lg shadow-sm">
                                <h3 className="text-lg font-bold text-green-900 mb-2">ğŸ’° 2. í˜„ì¬ ìì‚° ì ê²€</h3>
                                <p className="text-green-800 leading-relaxed">
                                    í˜„ì¬ ë³´ìœ í•˜ê³  ìˆëŠ” ìì‚° í˜„í™©ì„ ê¼¼ê¼¼í•˜ê²Œ í™•ì¸í•´ ë³¼ ì‹œê°„ì…ë‹ˆë‹¤.<br/>
                                    ë¶€ë™ì‚°ê³¼ ê°™ì€ <strong>ì‹¤ë¬¼ìì‚°</strong>ê³¼ ì˜ˆê¸ˆ, ì—°ê¸ˆ, ì£¼ì‹ ë“±ì˜ <strong>ê¸ˆìœµìì‚°</strong>ì„ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br/>
                                    ì •í™•í•œ ì…ë ¥ì´ ë”ìš± ì •êµí•œ ë…¸í›„ ì¤€ë¹„ ì§„ë‹¨ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.
                                </p>
                            </div>
                            
                            <h4 className="font-bold text-xl mb-4 text-slate-700 flex items-center gap-2">
                                <span>ğŸ </span> ì‹¤ë¬¼ìì‚° (ë§Œì›)
                            </h4>
                            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="input-group">
                                        <label>ë³´ìœ  ë¶€ë™ì‚° (ì‹œì„¸)</label>
                                        <input type="number" placeholder="0" value={userData?.real_estate || 0} onChange={(e)=>updateNum('real_estate', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>ê¸ˆ (Gold)</label>
                                        <input type="number" placeholder="0" value={userData?.gold || 0} onChange={(e)=>updateNum('gold', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label className="text-red-500">ë‹´ë³´ëŒ€ì¶œ (-)</label>
                                        <input type="number" placeholder="0" className="text-red-500 font-bold" value={userData?.loan_collateral || 0} onChange={(e)=>updateNum('loan_collateral', e.target.value)} />
                                    </div>
                                </div>
                            </div>

                            <h4 className="font-bold text-xl mb-4 text-slate-700 flex items-center gap-2">
                                <span>ğŸ’°</span> ê¸ˆìœµìì‚° (ë§Œì›)
                            </h4>
                            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
                                    <div className="input-group">
                                        <label>ë¹„íŠ¸ì½”ì¸</label>
                                        <input type="number" placeholder="0" value={userData?.bitcoin || 0} onChange={(e)=>updateNum('bitcoin', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>ì˜ˆê¸ˆ/í˜„ê¸ˆ</label>
                                        <input type="number" placeholder="0" value={userData?.cash || 0} onChange={(e)=>updateNum('cash', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>ì—°ê¸ˆì €ì¶•1(ì„¸ì•¡ê³µì œ)</label>
                                        <input type="number" placeholder="0" value={userData?.pension1 || 0} onChange={(e)=>updateNum('pension1', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>ì—°ê¸ˆì €ì¶•2(ì¶”ê°€ë‚©ì…)</label>
                                        <input type="number" placeholder="0" value={userData?.pension2 || 0} onChange={(e)=>updateNum('pension2', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>IRP</label>
                                        <input type="number" placeholder="0" value={userData?.irp || 0} onChange={(e)=>updateNum('irp', e.target.value)} />
                                    </div>
                                    <div className="input-group">
                                        <label>ISA</label>
                                        <input type="number" placeholder="0" value={userData?.isa || 0} onChange={(e)=>updateNum('isa', e.target.value)} />
                                    </div>
                                    <div className="input-group col-span-2 md:col-span-2">
                                        <label className="text-red-500">ê¸ˆìœµë¶€ì±„ (-)</label>
                                        <input type="number" placeholder="0" className="text-red-500 font-bold" value={userData?.debt_credit || 0} onChange={(e)=>updateNum('debt_credit', e.target.value)} />
                                    </div>
                                </div>
                                <div className="border-t pt-4 flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                                    <span className="font-bold text-gray-600">ê¸ˆìœµìì‚° ìˆœìì‚°</span>
                                    <span className="font-black text-2xl text-blue-600">
                                        {((calculations && calculations.netFinancialAsset) || 0).toLocaleString()} <span className="text-base font-normal text-gray-500">ë§Œì›</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
// [ìˆ˜ì •ëœ 4ë‹¨ê³„] ì–¼ë§ˆê°€ í•„ìš”í• ê¹Œ (NPS ì •ë°€ ë¡œì§ + Step-down ë²„íŠ¼ ë³µêµ¬ ì™„ë£Œ)
            if (currentStep === 3) {
                const inflationRate = userData?.inflation || 3;
                const totalMonthlyExpense = (calculations && calculations.totalMonthlyExpense) || 0;
                const futureMonthlyExpense = (calculations && calculations.futureMonthlyExpense) || 0;

                // [ì¤‘ìš”] userData ì•ˆì „ ì²˜ë¦¬
                const safeUserData = userData || { ...DEFAULT_USER_DATA };
                
                // 1. ë³€ìˆ˜ ì„¤ì • (êµ­ë¯¼ì—°ê¸ˆ)
                const npsTiming = safeUserData.npsTiming ? Number(safeUserData.npsTiming) : 0; // -5 ~ +5
                const receiptAge = 65 + npsTiming; // ì‹¤ì œ ì—°ê¸ˆ ê°œì‹œ ë‚˜ì´
                const retireAge = safeUserData.targetAge || 60; // ì€í‡´ ë‚˜ì´
                const currentAge = safeUserData.currentAge || 40; // í˜„ì¬ ë‚˜ì´

                // 2. ì¡°ì •ë¥  ê³„ì‚° (-6% ~ +7.2%)
                const baseNPS = Number(safeUserData.pensions?.national) || 0; // 65ì„¸ ê¸°ì¤€ í˜„ì¬ê°€ì¹˜
                let adjustRate = 0;
                if (npsTiming < 0) adjustRate = npsTiming * 0.06; 
                else if (npsTiming > 0) adjustRate = npsTiming * 0.072; 
                
                // 3. [ë¡œì§ 1] ìˆ˜ë ¹ ê°œì‹œ ì‹œì ì˜ ì—°ê¸ˆì•¡ ê³„ì‚° (ë¯¸ë˜ê°€ì¹˜)
                // ê³µì‹: (ê¸°ë³¸ì•¡ * ì¡°ì •ë¥ ) * (1 + ë¬¼ê°€ìƒìŠ¹ë¥ )^(ìˆ˜ë ¹ê°œì‹œë‚˜ì´ - í˜„ì¬ë‚˜ì´)
                const yearsToReceipt = Math.max(0, receiptAge - currentAge);
                const npsAtReceiptStart = (baseNPS * (1 + adjustRate)) * Math.pow(1 + inflationRate / 100, yearsToReceipt);

                // 4. [ë¡œì§ 2 & 3] ì€í‡´ ì‹œì ì˜ ì—°ê¸ˆ ìˆ˜ë ¹ì•¡ ê²°ì •
                let npsAtRetirement = 0;
                let statusMessage = "";
                let statusColor = "text-slate-500";

                if (retireAge < receiptAge) {
                    // [ë¡œì§ 3] ì€í‡´ê°€ ë” ë¹ ë¦„ -> ì€í‡´ ì‹œì ì—” ì—°ê¸ˆ 0ì›
                    npsAtRetirement = 0;
                    statusMessage = `ì€í‡´(${retireAge}ì„¸) ì‹œì ì—ëŠ” ì—°ê¸ˆì´ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤. (${receiptAge}ì„¸ë¶€í„° ìˆ˜ë ¹ ì‹œì‘)`;
                    statusColor = "text-red-500";
                } else {
                    // [ë¡œì§ 2] ì€í‡´ê°€ ë” ëŠ¦ìŒ (ì´ë¯¸ ë°›ê³  ìˆìŒ) -> ìˆ˜ë ¹ ê°œì‹œì•¡ì— ì€í‡´ ì‹œì ê¹Œì§€ì˜ ë¬¼ê°€ìƒìŠ¹ ë°˜ì˜
                    // ì¶”ê°€ ìƒìŠ¹ ê¸°ê°„ = ì€í‡´ë‚˜ì´ - ìˆ˜ë ¹ê°œì‹œë‚˜ì´
                    const yearsFromReceiptToRetire = retireAge - receiptAge;
                    npsAtRetirement = npsAtReceiptStart * Math.pow(1 + inflationRate / 100, yearsFromReceiptToRetire);
                    statusMessage = `ì€í‡´(${retireAge}ì„¸) ì‹œì  ì˜ˆìƒ ìˆ˜ë ¹ì•¡ (ë¬¼ê°€ìƒìŠ¹ ë°˜ì˜ë¨)`;
                    statusColor = "text-blue-600";
                }

                // 5. ë¶€ì¡± ê¸ˆì•¡ ê³„ì‚° (ì€í‡´ ì‹œì  ìƒí™œë¹„ - ì€í‡´ ì‹œì  ì—°ê¸ˆ)
                const futureMonthlyGap = Math.max(0, futureMonthlyExpense - npsAtRetirement);

                // Step-down ë³€ìˆ˜
                const isStepDown = userData.useStepDown || false;

                return (
                    <div className="fade-in space-y-10">
                        {/* 1. ë…¸í›„ ì›” ìƒí™œë¹„ ê³„ì‚° */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-slate-900 text-white p-6 md:p-8">
                                <h2 className="text-3xl font-bold mb-6">1. ë…¸í›„ ì›” ìƒí™œë¹„ ê³„ì‚°</h2>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <p className="opacity-90 text-base mb-6 leading-relaxed">
                                        í˜„ì¬ ë‚´ ìƒí™œë¹„ íŒ¨í„´ì„ ê¸°ì¤€ìœ¼ë¡œ, ì€í‡´ í›„ í•œ ë‹¬ì— ëŒ€ëµ ì–¼ë§ˆê°€ í•„ìš”í• ì§€ ê³„ì‚°í•´ ë³´ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.<br className="hidden md:block"/>
                                        ì‚¬ì¹˜ìŠ¤ëŸ¬ìš´ ìƒí™œì´ ì•„ë‹Œ, <strong>í˜„ì¬ì˜ ìƒí™œ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ë¹„ìš©</strong>ì„ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”.
                                    </p>
                                    <div className="flex items-start gap-4 bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                                        <span className="text-2xl">ğŸ’¡</span>
                                        <div>
                                            <strong className="block text-yellow-400 mb-2">í†µê³„ë¡œ ë³´ëŠ” ë…¸í›„ ìƒí™œë¹„ (ë¶€ë¶€ 2ì¸ ê¸°ì¤€)</strong>
                                            <ul className="text-slate-300 text-sm space-y-1">
                                                <li>- ìµœì†Œ ìƒí™œë¹„: <span className="font-bold text-white">ì›” ì•½ 250ë§Œì›</span></li>
                                                <li>- ì ì • ìƒí™œë¹„: <span className="font-bold text-yellow-300">ì›” ì•½ 350ë§Œì›</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* ìƒì„¸ ì…ë ¥ í…Œì´ë¸” */}
                            <div className="p-4 md:p-6 overflow-x-auto">
                                <table className="expense-table min-w-[700px] w-full text-sm text-left border-collapse">
                                    <colgroup>
                                        <col width="12%"/><col width="20%"/><col width="18%"/><col width="30%"/><col width="20%"/>
                                    </colgroup>
                                    <thead>
                                        <tr className="bg-slate-100 text-slate-700 border-b border-slate-300">
                                            <th className="p-3 font-bold text-center border-r border-slate-200">êµ¬ë¶„</th>
                                            <th className="p-3 font-bold text-center border-r border-slate-200">í•­ëª©</th>
                                            <th className="p-3 font-bold text-center border-r border-slate-200">í‰ê· ê°’(ì°¸ê³ )</th>
                                            <th className="p-3 font-bold text-center border-r border-slate-200">ë©”ëª¨</th>
                                            <th className="p-3 font-bold text-center">ê¸ˆì•¡(ë§Œì›)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {EXPENSE_DETAILS.map((cat) => (
                                            cat.items.map((item, idx) => (
                                                <tr key={item.key} className="hover:bg-blue-50 transition-colors">
                                                    {idx === 0 && (
                                                        <td rowSpan={cat.items.length} className="p-3 font-bold text-slate-700 bg-slate-50 border-r border-slate-200 text-center align-middle">
                                                            {cat.cat}
                                                        </td>
                                                    )}
                                                    <td className="p-3 text-slate-700 border-r border-slate-200 align-middle">{item.name}</td>
                                                    <td className="p-3 text-xs text-slate-500 border-r border-slate-200 align-middle text-center">{item.avg}</td>
                                                    <td className="p-2 border-r border-slate-200 align-middle">
                                                        <textarea 
                                                            value={userData.expenseNotes?.[item.key] || ""} 
                                                            onChange={(e) => updateExpenseNote(item.key, e.target.value)}
                                                            placeholder="ë‚´ìš© ë©”ëª¨"
                                                            className="w-full p-2 border border-slate-200 rounded text-xs focus:ring-1 focus:ring-blue-500 outline-none resize-none"
                                                            style={{ minHeight: '38px', lineHeight: '1.5' }}
                                                        />
                                                    </td>
                                                    <td className="p-2 align-middle">
                                                        <input 
                                                            type="number" 
                                                            value={userData.expenses[item.key] || 0} 
                                                            onChange={(e) => updateExpenseVal(item.key, e.target.value)}
                                                            className="w-full p-2 border border-blue-200 rounded text-right font-bold text-slate-800 bg-blue-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"
                                                        />
                                                    </td>
                                                </tr>
                                            ))
                                        ))}
                                    </tbody>
                                </table>

                                {/* í•©ê³„ ë° ë¯¸ë˜ê°€ì¹˜ ê²°ê³¼ ë°•ìŠ¤ */}
                                <div className="mt-8 bg-indigo-50 p-6 rounded-2xl border border-indigo-100 text-center space-y-6 shadow-inner">
                                    <div className="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-8">
                                        <div className="text-sm text-indigo-500 font-bold">í˜„ì¬ ê°€ì¹˜ ê¸°ì¤€ í•©ê³„</div>
                                        <div className="text-3xl font-black text-indigo-900">
                                            ì›” {totalMonthlyExpense.toLocaleString()} <span className="text-lg font-medium text-indigo-600">ë§Œì›</span>
                                        </div>
                                    </div>
                                    <div className="w-full h-px bg-indigo-200/50"></div>
                                    <div className="relative">
                                        <div className="text-sm text-indigo-800 mb-3 leading-relaxed">
                                            ë¬¼ê°€ìƒìŠ¹ë¥  <span className="font-bold bg-indigo-100 px-1 rounded">{inflationRate}%</span>ë¥¼ ê³ ë ¤í–ˆì„ ë•Œ,<br/>
                                            ë‚´ ì€í‡´ì‹œì ì¸ <span className="font-bold text-indigo-700">{userData.targetAge}ì„¸</span>ì— í•„ìš”í•œ ê¸ˆì•¡ì€
                                        </div>
                                        <div className="bg-white inline-block px-8 py-4 rounded-2xl shadow-lg border border-indigo-100 transform transition hover:scale-105">
                                            <span className="text-4xl font-black text-pink-600 drop-shadow-sm">
                                                {Math.round(futureMonthlyExpense).toLocaleString()}
                                            </span>
                                            <span className="text-xl font-bold text-slate-600 ml-1">ë§Œì›</span>
                                        </div>
                                    </div>
                                </div>

                                {/* â–¼â–¼â–¼ [ë³µêµ¬ëœ ë¶€ë¶„] Step-down ì„ íƒ ë²„íŠ¼ â–¼â–¼â–¼ */}
                                <div className="mt-6 bg-slate-50 border border-slate-200 p-6 rounded-xl shadow-sm">
                                    <div className="flex items-center gap-2 mb-3">
                                        <span className="text-2xl">ğŸ“‰</span>
                                        <h3 className="font-bold text-slate-800 text-lg">ë‚˜ì´ê°€ ë“¤ìˆ˜ë¡ ì†Œë¹„ë¥¼ ì¤„ì´ì‹œê² ìŠµë‹ˆê¹Œ? (Step-down)</h3>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <label className={`cursor-pointer p-4 rounded-xl border-2 flex flex-col gap-2 transition-all ${!isStepDown ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-slate-200 bg-white hover:bg-slate-50'}`}>
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="radio" 
                                                    name="stepdown_opt" 
                                                    checked={!isStepDown} 
                                                    onChange={() => setUserData(p => ({...p, useStepDown: false}))} 
                                                    className="w-5 h-5 text-blue-600 focus:ring-blue-500" 
                                                />
                                                <span className={`font-bold text-lg ${!isStepDown ? 'text-blue-700' : 'text-slate-700'}`}>ìœ ì§€í•˜ê¸° (Standard)</span>
                                            </div>
                                            <p className="text-sm text-slate-500 pl-8 leading-relaxed">
                                                ë¬¼ê°€ìƒìŠ¹ë¥ ë§Œí¼ ìƒí™œë¹„ê°€ ê³„ì† ì˜¤ë¦…ë‹ˆë‹¤.<br/>
                                                (ê±´ê°•, ê°„ë³‘ë¹„ ì¦ê°€ ë“±ì„ ê³ ë ¤í•˜ì—¬ ì†Œë¹„ ìˆ˜ì¤€ ìœ ì§€)
                                            </p>
                                        </label>

                                        <label className={`cursor-pointer p-4 rounded-xl border-2 flex flex-col gap-2 transition-all ${isStepDown ? 'border-indigo-500 bg-indigo-50 shadow-md' : 'border-slate-200 bg-white hover:bg-slate-50'}`}>
                                            <div className="flex items-center gap-3">
                                                <input 
                                                    type="radio" 
                                                    name="stepdown_opt" 
                                                    checked={isStepDown} 
                                                    onChange={() => setUserData(p => ({...p, useStepDown: true}))} 
                                                    className="w-5 h-5 text-indigo-600 focus:ring-indigo-500" 
                                                />
                                                <span className={`font-bold text-lg ${isStepDown ? 'text-indigo-700' : 'text-slate-700'}`}>ë‹¨ê³„ì ìœ¼ë¡œ ì¤„ì´ê¸°</span>
                                            </div>
                                            <div className="text-sm text-slate-500 pl-8 leading-relaxed">
                                                <p className="mb-1">í™œë™ëŸ‰ ê°ì†Œì— ë§ì¶° ëª©í‘œ ê¸ˆì•¡ì„ ì¶•ì†Œí•©ë‹ˆë‹¤.</p>
                                                <div className="flex gap-2 text-xs font-bold text-indigo-600 bg-white inline-block p-1 rounded border border-indigo-100">
                                                    <span>70ëŒ€(90%)</span>
                                                    <span>â†’</span>
                                                    <span>80ëŒ€(80%)</span>
                                                    <span>â†’</span>
                                                    <span>90ëŒ€(70%)</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {/* â–²â–²â–² [ë³µêµ¬ ì™„ë£Œ] â–²â–²â–² */}

                            </div>
                        </div>

                        {/* 2. ê³µì  ì—°ê¸ˆ í™•ì¸ ë° ì¡°ì ˆ */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-green-50 p-6 border-b border-green-200">
                                <h2 className="text-xl font-bold text-green-800 mb-2">2. ê³µì  ì—°ê¸ˆ í™•ì¸</h2>
                                <p className="text-green-900 text-sm leading-relaxed mb-4">
                                    í†µí•©ì—°ê¸ˆí¬í„¸ì—ì„œ <strong>65ì„¸ ì‹œì (ì •ìƒìˆ˜ë ¹)</strong> ê¸°ì¤€ ì˜ˆìƒ ì—°ê¸ˆì•¡(í˜„ì¬ê°€ì¹˜)ì„ ì…ë ¥í•˜ì„¸ìš”.<br/>
                                    ì•„ë˜ ìŠ¬ë¼ì´ë“œì—ì„œ ìˆ˜ë ¹ ì‹œê¸°ë¥¼ ì¡°ì ˆí•˜ë©´ <strong>ì€í‡´ ì‹œì  ê¸°ì¤€</strong>ì˜ ì‹¤ì œ ìˆ˜ë ¹ì•¡ì„ ì •í™•íˆ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.
                                </p>
                                <a href="https://www.fss.or.kr/fss/lifeplan/lifeplanIndex/index.do?menuNo=201101" target="_blank" className="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow transition transform hover:-translate-y-0.5">ğŸ”— í†µí•©ì—°ê¸ˆí¬í„¸ ì¡°íšŒí•˜ê¸°</a>
                            </div>
                            <div className="p-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div className="input-group">
                                        <label className="text-blue-700 font-bold">ğŸ›ï¸ êµ­ë¯¼ì—°ê¸ˆ (65ì„¸ ê¸°ì¤€ ì›” ìˆ˜ë ¹ì•¡, í˜„ì¬ê°€ì¹˜)</label>
                                        <input type="number" value={userData.pensions.national} onChange={(e)=>updatePension('national', e.target.value)} placeholder="ì˜ˆ: 100" className="bg-blue-50 border-blue-200 focus:border-blue-500" />
                                    </div>
                                    <div className="input-group">
                                        <label>ğŸ’¼ í‡´ì§ì—°ê¸ˆ (ì¼ì‹œê¸ˆ ì´ì•¡)</label>
                                        <input type="number" value={userData.pensions.retirement} onChange={(e)=>updatePension('retirement', e.target.value)} placeholder="0" />
                                    </div>
                                </div>

                                {/* êµ­ë¯¼ì—°ê¸ˆ ì‹œê¸° ì¡°ì ˆ ìŠ¬ë¼ì´ë” */}
                                <div className="bg-slate-50 border rounded-lg p-5 mb-8">
                                    <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <span>â±ï¸</span> êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ ì‹œê¸° ì¡°ì ˆ
                                    </h4>
                                    
                                    <div className="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-900">
                                        <strong>ğŸ’¡ ìˆ˜ë ¹ ì‹œê¸°ë³„ ì¦ê° ê·œì¹™</strong>
                                        <ul className="list-disc pl-5 mt-2 space-y-1">
                                            <li>65ì„¸ë³´ë‹¤ 1ë…„ ë¹¨ë¦¬ ë°›ìœ¼ë©´: <strong className="text-red-600">-6% ê°ì•¡</strong> (ìµœëŒ€ 5ë…„, -30%)</li>
                                            <li>65ì„¸ë³´ë‹¤ 1ë…„ ëŠ¦ê²Œ ë°›ìœ¼ë©´: <strong className="text-blue-600">+7.2% ì¦ì•¡</strong> (ìµœëŒ€ 5ë…„, +36%)</li>
                                        </ul>
                                    </div>

                                    <div className="px-2">
                                        <div className="flex justify-between text-xs text-slate-500 font-bold mb-2">
                                            <span className="text-red-500">â—€ ì¡°ê¸°ìˆ˜ë ¹ (-5ë…„)</span>
                                            <span className="text-slate-700">ì •ìƒìˆ˜ë ¹ (65ì„¸)</span>
                                            <span className="text-blue-500">ì—°ê¸°ì—°ê¸ˆ (+5ë…„) â–¶</span>
                                        </div>
                                        
                                        {/* ìŠ¬ë¼ì´ë” ì¸í’‹ */}
                                        <input 
                                            type="range" 
                                            min="-5" max="5" step="1" 
                                            value={npsTiming} 
                                            onChange={(e) => updateNum('npsTiming', e.target.value)}
                                            className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                        />

                                        {/* ëˆˆê¸ˆ í‘œì‹œ */}
                                        <div className="grid grid-cols-11 text-[10px] md:text-xs text-slate-400 mt-2 w-full">
                                            <div className="text-left">-30%</div>
                                            <div className="text-center">-24%</div>
                                            <div className="text-center">-18%</div>
                                            <div className="text-center">-12%</div>
                                            <div className="text-center">-6%</div>
                                            <div className="text-center text-slate-800 font-bold">0%</div>
                                            <div className="text-center">+7.2%</div>
                                            <div className="text-center">+14%</div>
                                            <div className="text-center">+21%</div>
                                            <div className="text-center">+28%</div>
                                            <div className="text-right">+36%</div>
                                        </div>
                                    </div>

                                    <div className="mt-6 flex flex-col md:flex-row items-center justify-center gap-6 bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                        <div className="text-center">
                                            <div className="text-xs text-slate-500 mb-1">ì„ íƒí•œ ìˆ˜ë ¹ ì‹œê¸°</div>
                                            <div className="font-bold text-lg text-slate-700">
                                                {npsTiming === 0 ? "65ì„¸ (ì •ìƒ)" : 
                                                 npsTiming < 0 ? `${65 + npsTiming}ì„¸ (${Math.abs(npsTiming)}ë…„ ì¡°ê¸°)` : 
                                                 `${65 + npsTiming}ì„¸ (${npsTiming}ë…„ ì—°ê¸°)`}
                                            </div>
                                        </div>
                                        <div className="hidden md:block w-px h-10 bg-slate-200"></div>
                                        <div className="text-center">
                                            <div className="text-xs text-slate-500 mb-1 flex items-center justify-center gap-1">
                                                <span>ì€í‡´ì‹œì ({userData.targetAge}ì„¸) ìˆ˜ë ¹ì•¡</span>
                                            </div>
                                            <div className={`font-black text-2xl ${retireAge < receiptAge ? 'text-red-500' : 'text-blue-600'}`}>
                                                {Math.round(npsAtRetirement).toLocaleString()} <span className="text-base font-normal text-slate-500">ë§Œì›</span>
                                            </div>
                                            <div className={`text-[11px] mt-1 ${statusColor} font-medium`}>
                                                {statusMessage}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8 bg-blue-600 text-white p-6 rounded-xl shadow-lg leading-relaxed">
                                    <p className="text-lg font-medium mb-4">
                                        "ë‚´ ì€í‡´ë‚˜ì´ <strong>{retireAge}ì„¸</strong> ê¸°ì¤€ìœ¼ë¡œ ì›” <strong>{Math.round(futureMonthlyExpense).toLocaleString()}ë§Œì›</strong>ì´ í•„ìš”í•œë°,<br/>
                                        ì€í‡´ ì‹œì ì˜ ë‚´ êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ì•¡ì€ <strong>{Math.round(npsAtRetirement).toLocaleString()}ë§Œì›</strong>ì…ë‹ˆë‹¤."
                                    </p>
                                    
                                    <p className="text-2xl font-bold text-yellow-300 mb-4">
                                        {futureMonthlyGap > 0 ? `${Math.round(futureMonthlyGap).toLocaleString()}ë§Œì›ì´ ëª¨ìë¼ë„¤ìš”. ğŸ˜¢` : `${Math.abs(Math.round(futureMonthlyGap)).toLocaleString()}ë§Œì›ì´ ë‚¨ë„¤ìš”! ğŸ‰`}
                                    </p>
                                    <p className="opacity-90">
                                        "ì, ìš°ë¦¬ëŠ” ì´ì œ ë‹¤ë¥¸ ìì‚°ì„ í™œìš©í•´ì„œ ì´ ëª¨ìë¼ëŠ” ë¶€ë¶„ì„ ì–´ë–»ê²Œ ì±„ìš¸ì§€ ê³„íší•´ì•¼ í•©ë‹ˆë‹¤.<br/>ì§€ê¸ˆë¶€í„° ì €ë‘ í•¨ê»˜ ê³„íší•´ ë³¼ê¹Œìš”?"
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
// ----------------------------------------------------------------------
// [ìˆ˜ì •ëœ 5ë‹¨ê³„] ì ë¦½ì‹ íˆ¬ìê³„íš (ë‹¤ìš´ì‚¬ì´ì§• ìê¸ˆ ë°˜ì˜ ë¡œì§ ì¶”ê°€)
            if (currentStep === 4 || STEPS[currentStep] === "ì ë¦½ì‹ íˆ¬ìê³„íš") {
                // --- [ë‚´ë¶€ ë¡œì§] ì‹œë®¬ë ˆì´ì…˜ ê³„ì‚° ì—”ì§„ ---
                const currentAge = userData?.currentAge || 40;
                const targetAge = userData?.targetAge || 60;
                const lifeAge = userData?.lifeAge || 90;
                
                // 3. ì—°ë ¹ëŒ€ êµ¬ê°„ ìƒì„±
                let intervals = [];
                let sAge = currentAge;
                while (sAge < targetAge) {
                    let eAge = Math.floor(sAge / 10) * 10 + 9;
                    if (eAge >= targetAge) eAge = targetAge;
                    if (sAge > eAge) break;
                    intervals.push({ startAge: sAge, endAge: eAge, ageKey: `${Math.floor(sAge/10)}0ëŒ€` });
                    sAge = eAge + 1;
                }

                // [ì¤‘ìš”] userData ì•ˆì „ ì²˜ë¦¬
                const safeUserData = userData || { ...DEFAULT_USER_DATA };
                
                // 4. ìì‚° ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°ê°’
                const initialGeneral = Number(safeUserData.initialAssets || 0);
                let runningBal = { 
                    pension1: Number(safeUserData.pension1||0), pension2: Number(safeUserData.pension2||0), 
                    irp: Number(safeUserData.irp||0), isa: Number(safeUserData.isa||0), 
                    general: initialGeneral, 
                    other: (Number(safeUserData.bitcoin||0) + Number(safeUserData.cash||0)) - Number(safeUserData.debt_credit||0) 
                };
                let runningPrincipal = { ...runningBal }; 
                let isaMonthCounter = 0;

                // [ì¶”ê°€ëœ ë³€ìˆ˜] ë‹¤ìš´ì‚¬ì´ì§• ì •ë³´
                const useDownsizing = userData.useDownsizing || false;
                const downsizingAge = Number(userData.downsizingAge) || 65;
                const downsizingAmount = Number(userData.downsizingAmount) || 0;

                // 5. êµ¬ê°„ë³„ ì‹œë®¬ë ˆì´ì…˜
                const ageIntervals = intervals.map(iv => {
                    const months = (iv.endAge - iv.startAge + 1) * 12;
                    const st = userData.ageStrategies?.[iv.ageKey] || { monthlyTotal: 0, targetReturn: 6, autoDistribute: false };
                    const mRate = (st.targetReturn || 0) / 100 / 12;

                    let contrib = { pension1:0, pension2:0, irp:0, isa:0, general:0, other:0 };
                    
                    if (st.autoDistribute) {
                        let rem = Number(st.monthlyTotal) || 0;
                        const assign = (limit) => { let v = Math.min(rem, limit); rem = Math.max(0, rem - v); return v; };
                        contrib.pension1 = assign(50);
                        contrib.irp = assign(25);
                        contrib.isa = assign(85);
                        contrib.pension2 = assign(75);
                        contrib.isa += assign(81);
                        contrib.general = rem;
                    } else {
                        contrib.pension1 = Number(st.pension1)||0; 
                        contrib.pension2 = Number(st.pension2)||0;
                        contrib.irp = Number(st.irp)||0; 
                        contrib.isa = Number(st.isa)||0;
                        contrib.general = Number(st.general)||0; 
                        contrib.other = Number(st.other)||0;
                    }

                    for (let m = 0; m < months; m++) {
                        // (1) ì´ì ë° ì ë¦½
                        ['pension1','pension2','irp','isa','general'].forEach(k => {
                            runningBal[k] = runningBal[k] * (1 + mRate);
                            runningBal[k] += contrib[k];
                            runningPrincipal[k] += contrib[k];
                        });
                        runningBal.other += contrib.other;
                        runningPrincipal.other += contrib.other;

                        // (2) ISA 5ë…„ ë§Œê¸° ë¡œì§
                        isaMonthCounter++;
                        if (isaMonthCounter === 60) { 
                            const isaTotal = runningBal.isa;
                            const isaPrincipal = runningPrincipal.isa;
                            
                            if (isaTotal > 0) {
                                const profit = Math.max(0, isaTotal - isaPrincipal);
                                let tax = 0;
                                if (profit > 200) {
                                    tax = (profit - 200) * 0.099;
                                }
                                const transferAmount = isaTotal - tax;
                                runningBal.pension2 += transferAmount;
                                runningPrincipal.pension2 += transferAmount; 
                                runningBal.isa = 0;
                                runningPrincipal.isa = 0; 
                            }
                            isaMonthCounter = 0;
                        }

                        // (3) [í•µì‹¬ ì¶”ê°€] ë‹¤ìš´ì‚¬ì´ì§• ìê¸ˆ ì¼ì‹œë¶ˆ íˆ¬ì… ë¡œì§
                        // í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì¸ ë‚˜ì´ ê³„ì‚°
                        const currentSimAge = iv.startAge + Math.floor(m / 12);
                        // í•´ë‹¹ ë‚˜ì´ì˜ ì²« ë‹¬(m%12===0)ì—ë§Œ íˆ¬ì… (ì—° 1íšŒ)
                        if (useDownsizing && currentSimAge === downsizingAge && m % 12 === 0 && iv.startAge <= downsizingAge && iv.endAge >= downsizingAge) {
                            // ì´ë¯¸ íˆ¬ì…í–ˆëŠ”ì§€ ì²´í¬í•˜ëŠ” í”Œë˜ê·¸ê°€ í•„ìš”í•˜ì§€ë§Œ, 
                            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ 'í•´ë‹¹ ë‚˜ì´ì˜ ì²« ë‹¬' ì¡°ê±´ìœ¼ë¡œ 1íšŒë§Œ ì‹¤í–‰ë˜ê²Œ í•¨.
                            // ë‹¨, êµ¬ê°„ì´ ë°”ë€Œì–´ì„œ ì´ˆê¸°í™”ë˜ëŠ” mì´ ì•„ë‹ˆë¼ ì ˆëŒ€ì ì¸ ì—°ë„ë¥¼ ë”°ì ¸ì•¼ í•˜ëŠ”ë°,
                            // ìœ„ ì¡°ê±´ (m % 12 === 0)ì€ ë§¤ë…„ 1ì›”ì„ ì˜ë¯¸í•˜ë¯€ë¡œ, 
                            // downsizingAgeê°€ ì´ êµ¬ê°„ ì•ˆì— í¬í•¨ë˜ë©´ ì •í™•íˆ í•œ ë²ˆ(ê·¸ ë‚˜ì´ì˜ 1ì›”) ì‹¤í–‰ë¨.
                            
                            const amountP2 = Math.min(downsizingAmount, 10000); // 1ì–µì›ê¹Œì§€ ì—°ê¸ˆì €ì¶•2
                            const amountGen = Math.max(0, downsizingAmount - 10000); // ë‚˜ë¨¸ì§€ëŠ” ì¼ë°˜ê³„ì¢Œ

                            runningBal.pension2 += amountP2;
                            runningPrincipal.pension2 += amountP2;
                            
                            runningBal.general += amountGen;
                            runningPrincipal.general += amountGen;
                        }
                    }

                    // í•©ê³„ ê³„ì‚°
                    const totalEndAsset = runningBal.pension1 + runningBal.pension2 + runningBal.irp + runningBal.isa + runningBal.general + runningBal.other;

                    return { 
                        ...iv, 
                        totalEndAsset: totalEndAsset,
                        endBalances: { ...runningBal }, 
                        cumulativePrincipal: { ...runningPrincipal } 
                    };
                });

                // ë°ì´í„° ì—…ë°ì´íŠ¸ í—¬í¼
                const updateAgeStrategy = (ageKey, field, val) => {
                    setUserData(prev => {
                        const strategies = prev.ageStrategies || {};
                        const currentSt = { ...(strategies[ageKey] || { monthlyTotal:0, targetReturn:6, autoDistribute:false }) };
                        if (field === 'autoDistribute') currentSt.autoDistribute = val;
                        else currentSt[field] = Number(val);

                        if (currentSt.autoDistribute) {
                            const dist = calculateDistributionLogic(currentSt.monthlyTotal);
                            Object.assign(currentSt, dist); 
                        }
                        return { ...prev, ageStrategies: { ...strategies, [ageKey]: currentSt } };
                    });
                };

                return (
                    <div className="fade-in space-y-6">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-6 shadow-sm">
                            <p className="text-blue-900 font-medium leading-relaxed">
                                "ì, ì•ì—ì„œ ì‚´í´ë³´ì•˜ë“¯ì´ êµ­ë¯¼ì—°ê¸ˆ ë§Œìœ¼ë¡œ ìƒí™œë¹„ê°€ ë¶€ì¡±í•˜ë‹¤ë©´ ì€í‡´ì‹œì ê¹Œì§€ ë” ë§ì€ ìì‚°ì„ ëª¨ì•„ì•¼ í•©ë‹ˆë‹¤.<br/>
                                ì•„ë˜ì—ì„œ <strong>ì—°ë ¹ëŒ€ë³„ ì ë¦½ì‹ íˆ¬ì ê³„íš</strong>ì„ ì„¸ì›Œë³´ì„¸ìš”."
                            </p>
                        </div>

                        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mt-8">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 border-b pb-2">ğŸ“… í˜„ì¬ ëª¨ì•„ë†“ì€ ê¸ˆìœµìì‚° (3ë‹¨ê³„ ì…ë ¥ê°’)</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-600 mb-4">
                                <div><span className="block text-xs text-slate-400">ë¹„íŠ¸ì½”ì¸ (ê¸°íƒ€)</span><strong className="text-slate-800 text-lg">{(Number(userData.bitcoin)||0).toLocaleString()}</strong></div>
                                <div><span className="block text-xs text-slate-400">ì˜ˆê¸ˆ/í˜„ê¸ˆ (ê¸°íƒ€)</span><strong className="text-slate-800 text-lg">{(Number(userData.cash)||0).toLocaleString()}</strong></div>
                                <div><span className="block text-xs text-slate-400">ì—°ê¸ˆì €ì¶•1</span><strong className="text-slate-800 text-lg">{(Number(userData.pension1)||0).toLocaleString()}</strong></div>
                                <div><span className="block text-xs text-slate-400">ì—°ê¸ˆì €ì¶•2</span><strong className="text-slate-800 text-lg">{(Number(userData.pension2)||0).toLocaleString()}</strong></div>
                                <div><span className="block text-xs text-slate-400">IRP</span><strong className="text-slate-800 text-lg">{(Number(userData.irp)||0).toLocaleString()}</strong></div>
                                <div><span className="block text-xs text-slate-400">ISA</span><strong className="text-slate-800 text-lg">{(Number(userData.isa)||0).toLocaleString()}</strong></div>
                                <div className="col-span-2 md:col-span-2 text-red-500"><span className="block text-xs text-red-300">ê¸ˆìœµë¶€ì±„ (-)</span><strong className="text-lg">{(Number(userData.debt_credit)||0).toLocaleString()}</strong></div>
                            </div>
                            <div className="bg-slate-50 p-3 rounded text-center border">
                                <span className="text-slate-500 mr-2">ìˆœ ê¸ˆìœµìì‚° í•©ê³„:</span>
                                <span className="font-bold text-xl text-blue-600">
                                    {(Number(userData.bitcoin) + Number(userData.cash) + Number(userData.pension1) + Number(userData.pension2) + Number(userData.irp) + Number(userData.isa) - Number(userData.debt_credit)).toLocaleString()} ë§Œì›
                                </span>
                            </div>
                        </div>

                        {/* ë‹¤ìš´ì‚¬ì´ì§• ë°˜ì˜ ì•Œë¦¼ */}
                        {useDownsizing && (
                            <div className="bg-green-50 border border-green-200 p-4 rounded-lg flex items-center gap-3 animate-pulse">
                                <span className="text-2xl">ğŸ </span>
                                <div className="text-sm text-green-800">
                                    <strong>[ëŒ€ì±… ì ìš©ë¨]</strong> {downsizingAge}ì„¸ ì‹œì ì— ì£¼íƒ ë‹¤ìš´ì‚¬ì´ì§• ì°¨ì•¡ <strong>{downsizingAmount.toLocaleString()}ë§Œì›</strong>ì´ ì¶”ê°€ ì ë¦½ë©ë‹ˆë‹¤.<br/>
                                    (ì—°ê¸ˆì €ì¶•2: {Math.min(downsizingAmount, 10000).toLocaleString()}ë§Œì› / ì¼ë°˜ê³„ì¢Œ: {Math.max(0, downsizingAmount-10000).toLocaleString()}ë§Œì›)
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-6 rounded-xl border shadow-sm mt-8">
                            <div className="border-b pb-4 mb-6">
                                <h3 className="text-lg font-bold text-slate-800 mb-2">ğŸ“… ì—°ë ¹ëŒ€ë³„ ì ë¦½ ê³„íš</h3>
                                <div className="text-sm text-slate-600 space-y-1">
                                    <p className="text-red-600 font-bold">âœ” ì—°ë ¹ëŒ€ë³„ë¡œ ë§¤ì›” ì–¼ë§ˆì”© ì ë¦½í•  ìˆ˜ ìˆì„ì§€, ëª©í‘œìˆ˜ìµë¥ ì€ ì–¼ë§ˆë¡œ í• ì§€ ë¹ˆ ì¹¸ì„ ì±„ì›Œë³´ì„¸ìš”.</p>
                                    <p className="text-red-600 font-bold">âœ” [ì ˆì„¸ ìë™ë¶„ë°°]ë¥¼ ì²´í¬í•˜ë©´: ì—°ê¸ˆì €ì¶•50 â†’ IRP25 â†’ ISA85 â†’ ì—°ê¸ˆì €ì¶•75 â†’ ISA81 â†’ ì¼ë°˜ê³„ì¢Œ ìˆœì„œë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                                    <p className="text-purple-600 font-bold">âœ” ISA ê³„ì¢ŒëŠ” ë§¤ 5ë…„ë§ˆë‹¤ ë§Œê¸° í•´ì§€ë˜ì–´ ì—°ê¸ˆì €ì¶•2ë¡œ ìë™ ì´ì²´ë˜ë©°, ì´ë•Œ ìˆ˜ìµ 200ë§Œì› ì´ˆê³¼ë¶„ì— ëŒ€í•´ 9.9% ì„¸ê¸ˆì„ ë–¼ê³  ì…ê¸ˆë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>

                            <div className="space-y-6">
                                {ageIntervals.map((interval, index) => {
                                    const st = userData.ageStrategies?.[interval.ageKey] || { monthlyTotal: 0, targetReturn: 6, autoDistribute: false };
                                    
                                    const totalRounded = Math.round(interval.totalEndAsset);
                                    const assetEok = Math.floor(totalRounded / 10000);
                                    const assetMan = totalRounded % 10000;

                                    const renderAccountCell = (name, total, principal) => (
                                        <div>
                                            <span className="block text-slate-600 text-[10px] mb-1">{name}</span>
                                            <span className="text-blue-600 font-bold text-sm block">{Math.round(total).toLocaleString()}</span>
                                            <div className="text-[9px] text-slate-400 mt-1 bg-slate-100 rounded p-1">
                                                <div>ì›ê¸ˆ {Math.round(principal).toLocaleString()}</div>
                                                <div className="text-red-400">ìˆ˜ìµ +{Math.round(Math.max(0, total - principal)).toLocaleString()}</div>
                                            </div>
                                        </div>
                                    );

                                    return (
                                        <div key={index} className="bg-slate-50 border border-slate-200 rounded-xl p-5 relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 pl-3">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-slate-800 text-white px-4 py-2 rounded-lg text-center shadow">
                                                        <span className="block text-xs opacity-70">{interval.ageKey}</span>
                                                        <span className="font-bold text-lg">{interval.startAge} ~ {interval.endAge}ì„¸</span>
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <div className="flex items-center gap-2">
                                                            <label className="text-xs text-slate-500 font-bold w-20">ë§¤ì›” ì ë¦½</label>
                                                            <input type="number" value={st.monthlyTotal} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'monthlyTotal', e.target.value)} className="w-24 p-1 border rounded text-right font-bold text-blue-600"/><span className="text-sm text-slate-600">ë§Œì›</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <label className="text-xs text-slate-500 font-bold w-20">ëª©í‘œ ìˆ˜ìµë¥ </label>
                                                            <input type="number" value={st.targetReturn} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'targetReturn', e.target.value)} className="w-24 p-1 border rounded text-right font-bold text-red-500"/><span className="text-sm text-slate-600">%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="bg-white p-3 rounded-lg border shadow-sm flex-1 w-full md:w-auto text-right">
                                                    <div className="text-xs text-slate-700 font-bold mb-1">{interval.endAge}ì„¸ ì‹œì  ì˜ˆìƒ ìì‚°</div>
                                                    <div>
                                                        <span className="text-xs text-slate-600 mr-2">í‰ê°€ì•¡</span>
                                                        <span className="text-lg font-black text-blue-700">
                                                            {assetEok > 0 ? `${assetEok.toLocaleString()}ì–µ ` : ''}{assetMan.toLocaleString()}ë§Œì›
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="pl-3 mb-4 bg-white border rounded p-2 text-xs text-slate-600 grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                                                <div className="font-bold text-slate-800 col-span-3 md:col-span-6 border-b pb-1 mb-1">ğŸ“Š {interval.endAge}ì„¸ ì‹œì  ê³„ì¢Œë³„ ì˜ˆìƒ ì”ê³  (í‰ê°€ì•¡)</div>
                                                {renderAccountCell("ì—°ê¸ˆì €ì¶•1", interval.endBalances.pension1, interval.cumulativePrincipal.pension1)}
                                                {renderAccountCell("IRP", interval.endBalances.irp, interval.cumulativePrincipal.irp)}
                                                {renderAccountCell("ISA", interval.endBalances.isa, interval.cumulativePrincipal.isa)}
                                                {renderAccountCell("ì—°ê¸ˆì €ì¶•2", interval.endBalances.pension2, interval.cumulativePrincipal.pension2)}
                                                {renderAccountCell("ì¼ë°˜ê³„ì¢Œ", interval.endBalances.general, interval.cumulativePrincipal.general)}
                                                {renderAccountCell("ê¸°íƒ€", interval.endBalances.other, interval.cumulativePrincipal.other)}
                                            </div>
                                            <div className="pl-3 mb-2 flex items-center justify-between">
                                                <span className="text-xs font-bold text-slate-500">ğŸ”» ì›” ì ë¦½ì•¡ ê³„ì¢Œë³„ ìƒì„¸ ë°°ë¶„</span>
                                                <div className="flex items-center gap-1 bg-yellow-100 px-2 py-1 rounded border border-yellow-200">
                                                    <input type="checkbox" id={`auto-${index}`} checked={st.autoDistribute} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'autoDistribute', e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                                    <label htmlFor={`auto-${index}`} className="text-xs font-bold text-red-800 cursor-pointer select-none">âš¡ ì ˆì„¸ ìë™ë¶„ë°° (í´ë¦­)</label>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm pl-3">
                                                <div><label className="block text-slate-400 text-[10px] mb-1">ì—°ê¸ˆì €ì¶•1</label><input type="number" value={st.pension1} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'pension1', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                                <div><label className="block text-slate-400 text-[10px] mb-1">IRP</label><input type="number" value={st.irp} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'irp', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                                <div><label className="block text-slate-400 text-[10px] mb-1">ISA</label><input type="number" value={st.isa} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'isa', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                                <div><label className="block text-slate-400 text-[10px] mb-1">ì—°ê¸ˆì €ì¶•2</label><input type="number" value={st.pension2} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'pension2', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                                <div><label className="block text-slate-400 text-[10px] mb-1">ì¼ë°˜ê³„ì¢Œ</label><input type="number" value={st.general} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'general', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                                <div><label className="block text-slate-400 text-[10px] mb-1">ê¸°íƒ€</label><input type="number" value={st.other} onChange={(e)=>updateAgeStrategy(interval.ageKey, 'other', e.target.value)} className="w-full p-2 border rounded text-right bg-white focus:bg-blue-50"/></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }
if (currentStep === 5) {
                // ê³„ì¢Œë³„ íˆ¬ìê°€ëŠ¥ ETF ëª©ë¡ ë§¤í•‘
                const PENSION_ISA_ETFS = [...ETF_DB.domestic, ...ETF_DB.domestic_overseas];
                const IRP_ETFS = [...ETF_DB.domestic, ...ETF_DB.domestic_overseas, ...ETF_DB.irp_safe];
                const GENERAL_ETFS = [...ETF_DB.overseas];

                return (
                    <div className="fade-in space-y-8">
                        <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl">
                            <h2 className="text-2xl font-bold mb-2">ğŸ›’ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±í•˜ê¸°</h2>
                            <p className="opacity-80">5ë‹¨ê³„ì—ì„œ ì„¤ì •í•œ ëª©í‘œ ìˆ˜ìµë¥ ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´, ê° ê³„ì¢Œë³„ë¡œ ì–´ë–¤ ETFë¥¼ ë‹´ì„ì§€ ê²°ì •í•´ ë´…ì‹œë‹¤.</p>
                            <div className="mt-6 pt-6 border-t border-slate-700">
                                <button onClick={applyRecommended} className="bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 px-6 rounded-lg shadow-lg flex items-center gap-2 mx-auto transition transform hover:-translate-y-1">
                                    <span>âœ¨ ê¶Œì¥ í¬íŠ¸í´ë¦¬ì˜¤ í•œë²ˆì— ì ìš©í•˜ê¸°</span>
                                </button>
                                <p className="text-center text-sm text-slate-400 mt-3 bg-slate-800 p-2 rounded inline-block mx-auto block max-w-2xl">
                                    "ë‚˜ì´ê°€ ì–´ë¦´ìˆ˜ë¡ ì„±ì¥í˜•ETF ë¹„ì¤‘ì´ ë†’ê²Œ, ì€í‡´ì‹œê¸°ê°€ ê°€ê¹Œì›Œ ì§ˆìˆ˜ë¡ ì•ˆì •ì ì¸ ë°°ë‹¹ì„ ëŠ˜ë ¤ê°€ëŠ” ê²ƒìœ¼ë¡œ ê³„íší•©ë‹ˆë‹¤."
                                </p>
                            </div>
                        </div>

                        {/* ì—°ë ¹ëŒ€ íƒ­ */}
                        <div className="flex border-b overflow-x-auto">
                            {AGE_GROUPS_KEYS.map((age, idx) => (
                                <button key={age} onClick={() => {
                                    const element = document.getElementById(`tab-${age}`);
                                    if (element) {
                                        element.scrollIntoView({ behavior: 'smooth' });
                                    } else {
                                        alert("í•´ë‹¹ ì—°ë ¹ëŒ€ëŠ” í˜„ì¬ ì„¤ì •ëœ ë‚˜ì´ë³´ë‹¤ ì´ì „ì…ë‹ˆë‹¤.");
                                    }
                                }} className="px-6 py-3 font-bold text-slate-600 hover:text-blue-600 whitespace-nowrap">
                                    {age}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-12">
                            {AGE_GROUPS_KEYS.map((age) => {
                                const targetReturn = userData.ageStrategies[age]?.targetReturn || 0;
                                const portfolios = userData.portfolios[age] || { pension: [], irp: [], isa: [], general: [] };
                                
                                // ë‚˜ì´ëŒ€ê°€ í˜„ì¬ ë‚˜ì´ë³´ë‹¤ ì–´ë¦¬ë©´ ìŠ¤í‚µ (ì˜µì…˜)
                                const ageNum = parseInt(age);
                                if (ageNum < Math.floor((userData?.currentAge || 40) / 10) * 10) return null;

                                return (
                                    <div key={age} id={`tab-${age}`} className="border-t pt-8 first:border-0 first:pt-0">
                                        <h3 className="text-2xl font-black text-slate-800 mb-4 flex items-center gap-2">
                                            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded text-lg">{age}</span>
                                            íˆ¬ì ì „ëµ
                                        </h3>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <PortfolioBuilder 
                                                ageKey={age} accountType="pension" title="ì—°ê¸ˆì €ì¶• í¬íŠ¸í´ë¦¬ì˜¤" 
                                                availableETFs={PENSION_ISA_ETFS} portfolioData={portfolios.pension} 
                                                onUpdate={updatePortfolio} targetReturn={targetReturn}
                                            />
                                            <PortfolioBuilder 
                                                ageKey={age} accountType="isa" title="ISA í¬íŠ¸í´ë¦¬ì˜¤" 
                                                availableETFs={PENSION_ISA_ETFS} portfolioData={portfolios.isa} 
                                                onUpdate={updatePortfolio} targetReturn={targetReturn}
                                            />
                                            <PortfolioBuilder 
                                                ageKey={age} accountType="irp" title="IRP í¬íŠ¸í´ë¦¬ì˜¤ (ì•ˆì „ìì‚° 30% í•„ìˆ˜)" 
                                                availableETFs={IRP_ETFS} portfolioData={portfolios.irp} 
                                                onUpdate={updatePortfolio} targetReturn={targetReturn}
                                                isIRP={true}
                                            />
                                            <PortfolioBuilder 
                                                ageKey={age} accountType="general" title="ì¼ë°˜ê³„ì¢Œ í¬íŠ¸í´ë¦¬ì˜¤ (í•´ì™¸ìƒì¥)" 
                                                availableETFs={GENERAL_ETFS} portfolioData={portfolios.general} 
                                                onUpdate={updatePortfolio} targetReturn={targetReturn}
                                            />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }
// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] 7ë‹¨ê³„: ì—°ê¸ˆì¸ì¶œ ê³„íš (ê²°ê³¼ ë°•ìŠ¤ì— í˜„ì¬ê°€ì¹˜ í‘œê¸° ì¶”ê°€) â–¼â–¼â–¼
            if (currentStep === 6) {
                // ==================================================================================
                // [1] ê³„ì‚° ì—”ì§„ & ê¸°ë³¸ ì„¤ì •
                // ==================================================================================

                // 1. ê¸°ì´ˆ ë°ì´í„°
                const sumOfDetailExpenses = Object.values(userData.expenses || {}).reduce((a, b) => a + b, 0);
                const baseMonthlyExpense = sumOfDetailExpenses > 0 ? sumOfDetailExpenses : (Number(userData.totalMonthlyExpense) || 300);
                
                const { currentAge, targetAge, lifeAge, inflation } = userData;
                const inflationRate = (inflation || 0) / 100;

                // êµ­ë¯¼ì—°ê¸ˆ ì„¤ì •
                const npsTiming = userData.npsTiming ? Number(userData.npsTiming) : 0;
                const receiptAge = 65 + npsTiming; 
                
                let npsAdjustRate = 0;
                if (npsTiming < 0) npsAdjustRate = npsTiming * 0.06;
                else if (npsTiming > 0) npsAdjustRate = npsTiming * 0.072;
                
                const baseNPS = Number(userData.pensions.national || 0); 
                const adjustedBaseNPS = baseNPS * (1 + npsAdjustRate);   

                // ë‹¤ìš´ì‚¬ì´ì§• ì„¤ì •
                const useDownsizing = userData.useDownsizing || false;
                const downsizingAge = userData.downsizingAge ? Number(userData.downsizingAge) : 65;
                const downsizingAmount = userData.downsizingAmount ? Number(userData.downsizingAmount) : 0;

                // ì„¸ê¸ˆ ê³„ì‚° í—¬í¼
                const getTaxDetails = (age, type, withdrawalYear, annualAmount = 0) => {
                    let taxes = [];
                    if (annualAmount <= 0) return { totalTax: 0, details: [] };

                    if (type === 'RETIRE') { 
                        const baseRate = 0.05; 
                        let rate = withdrawalYear <= 10 ? baseRate * 0.7 : baseRate * 0.6;
                        const taxAmt = Math.round(annualAmount * rate);
                        taxes.push({ name: 'í‡´ì§ì†Œë“ì„¸', amount: taxAmt, rate: rate });
                        return { totalTax: taxAmt, details: taxes };
                    }
                    if (type === 'P2') return { totalTax: 0, details: [] }; 

                    if (type === 'TAXABLE') { 
                        if (annualAmount > 1500) {
                            const taxAmt = Math.round(annualAmount * 0.165);
                            taxes.push({ name: 'ê¸°íƒ€ì†Œë“ì„¸(16.5%)', amount: taxAmt });
                        } else {
                            let rate = 0.055;
                            if (age >= 80) rate = 0.033;
                            else if (age >= 70) rate = 0.044;
                            const taxAmt = Math.round(annualAmount * rate);
                            taxes.push({ name: 'ì—°ê¸ˆì†Œë“ì„¸', amount: taxAmt });
                        }
                    }
                    const totalTax = taxes.reduce((acc, cur) => acc + cur.amount, 0);
                    return { totalTax, details: taxes };
                };

                // --------------------------------------------------------------------------------
                // [ìì‚° ì¶•ì  ì‹œë®¬ë ˆì´ì…˜] (5ë‹¨ê³„ ë¡œì§ ì ìš©)
                // --------------------------------------------------------------------------------
                let intervals = [];
                let sAge = currentAge;
                while (sAge < targetAge) {
                    let eAge = Math.floor(sAge / 10) * 10 + 9;
                    if (eAge >= targetAge) eAge = targetAge; 
                    if (sAge > eAge) break;
                    intervals.push({ startAge: sAge, endAge: eAge, ageKey: `${Math.floor(sAge/10)}0ëŒ€` });
                    sAge = eAge + 1;
                }

                // [ì¤‘ìš”] userData ì•ˆì „ ì²˜ë¦¬
                const safeUserData = userData || { ...DEFAULT_USER_DATA };
                
                const initialGeneral = Number(safeUserData.initialAssets || 0);
                
                let runningBal = { 
                    pension1: Number(safeUserData.pension1||0), pension2: Number(safeUserData.pension2||0),
                    irp: Number(safeUserData.irp||0), isa: Number(safeUserData.isa||0),
                    general: initialGeneral,
                    other: (Number(userData.bitcoin||0) + Number(userData.cash||0)) - Number(userData.debt_credit||0) 
                };
                let runningPrincipal = { ...runningBal }; 
                let isaMonthCounter = 0;

                intervals.forEach(iv => {
                    const months = (iv.endAge - iv.startAge + 1) * 12;
                    const st = userData.ageStrategies?.[iv.ageKey] || { monthlyTotal: 0, targetReturn: 6, autoDistribute: false };
                    const mRate = (st.targetReturn || 0) / 100 / 12;

                    let contrib = { pension1:0, pension2:0, irp:0, isa:0, general:0, other:0 };
                    if (st.autoDistribute) {
                        let rem = Number(st.monthlyTotal) || 0;
                        const assign = (limit) => { let v = Math.min(rem, limit); rem = Math.max(0, rem - v); return v; };
                        contrib.pension1 = assign(50); contrib.irp = assign(25); contrib.isa = assign(85);
                        contrib.pension2 = assign(75); contrib.isa += assign(81); contrib.general = rem;
                    } else {
                        contrib.pension1 = Number(st.pension1)||0; contrib.pension2 = Number(st.pension2)||0;
                        contrib.irp = Number(st.irp)||0; contrib.isa = Number(st.isa)||0;
                        contrib.general = Number(st.general)||0; contrib.other = Number(st.other)||0;
                    }

                    for (let m = 0; m < months; m++) {
                        // (1) ì´ì ë° ì ë¦½
                        ['pension1','pension2','irp','isa','general'].forEach(k => {
                            runningBal[k] = runningBal[k] * (1 + mRate);
                            runningBal[k] += contrib[k];
                            runningPrincipal[k] += contrib[k];
                        });
                        runningBal.other += contrib.other;
                        runningPrincipal.other += contrib.other;

                        // (2) ISA 5ë…„ ë§Œê¸° ë¡œì§
                        isaMonthCounter++;
                        if (isaMonthCounter === 60) {
                            const isaTotal = runningBal.isa;
                            const isaPrincipal = runningPrincipal.isa;
                            if (isaTotal > 0) {
                                const profit = Math.max(0, isaTotal - isaPrincipal);
                                let tax = 0;
                                if (profit > 200) tax = (profit - 200) * 0.099;
                                
                                const transferAmount = isaTotal - tax;
                                runningBal.pension2 += transferAmount;
                                runningPrincipal.pension2 += transferAmount; 
                                runningBal.isa = 0;
                                runningPrincipal.isa = 0;
                            }
                            isaMonthCounter = 0;
                        }

                        // (3) ì€í‡´ ì „ ë‹¤ìš´ì‚¬ì´ì§• ë¡œì§
                        const currentSimAge = iv.startAge + Math.floor(m / 12);
                        if (useDownsizing && currentSimAge === downsizingAge && m % 12 === 0 && currentSimAge < targetAge) {
                            const amountP2 = Math.min(downsizingAmount, 10000); 
                            const amountGen = Math.max(0, downsizingAmount - 10000); 
                            runningBal.pension2 += amountP2;
                            runningPrincipal.pension2 += amountP2;
                            runningBal.general += amountGen;
                            runningPrincipal.general += amountGen;
                        }
                    }
                });

                // ì€í‡´ ì‹œì  ìì‚° í™•ì •
                const retirementPensionFinal = Number(userData.pensions?.retirement || 0);
                const retirementPensionInitial = retirementPensionFinal;

                const p2Principal = runningPrincipal.pension2; 
                const retirePrincipal = Math.round(retirementPensionFinal);
                const p1IrpPrincipal = runningPrincipal.pension1 + runningPrincipal.irp;
                const totalBalance = Object.values(runningBal).reduce((a,b)=>a+b, 0) + retirementPensionFinal;
                const totalPrincipalSum = Object.values(runningPrincipal).reduce((a,b)=>a+b, 0) + retirementPensionInitial;
                const investmentReturns = Math.max(0, totalBalance - totalPrincipalSum);

                const annualGrowthRate = (userData.postRetirementReturnRate || 5) / 100;
                
                // ==============================================================================
                // [í†µí•© ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ - ì¸ì¶œê¸°] 
                // ==============================================================================
                
                let simulationResults = []; 
                let finalBalances = { p2: 0, retire: 0, taxable: 0, pool: 0, total: 0 }; 
                let detectedShortageAge = null; 

                {
                    // ìì‚° ì´ˆê¸°í™”
                    let currentP2Balance = p2Principal; // 1ìˆœìœ„
                    let currentRetireBalance = retirePrincipal; // 2ìˆœìœ„
                    let currentP1Balance = p1IrpPrincipal + investmentReturns; // 3ìˆœìœ„
                    
                    // [í•µì‹¬] 5ë‹¨ê³„ì—ì„œ ë„˜ì–´ì˜¨ ì¼ë°˜/ê¸°íƒ€/ISA ì”ì•¡ì„ ëª©ëˆ(Pool) ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •
                    let currentPool = runningBal.isa + runningBal.general + runningBal.other;

                    const startAge = 55;
                    const endAge = userData.lifeAge;

                    for (let age = startAge; age <= endAge; age++) {
                        const isRetired = age >= userData.targetAge;
                        const withdrawalYear = isRetired ? (age - userData.targetAge + 1) : 0;

                        // 0. [ì€í‡´ í›„ ë‹¤ìš´ì‚¬ì´ì§• ìê¸ˆ íˆ¬ì…]
                        if (useDownsizing && age === downsizingAge && age >= targetAge) {
                            currentPool += downsizingAmount; 
                        }

                        // 1. [ê¸°ë³¸ ì¸ì¶œ ì ë¦½]
                        let baseWithdrawP1 = 0;
                        let baseTaxP1 = 0;
                        if (age >= 55 && currentP1Balance > 0) {
                            baseWithdrawP1 = Math.min(1500, currentP1Balance);
                            currentP1Balance -= baseWithdrawP1;
                            const taxObj = getTaxDetails(age, 'TAXABLE', withdrawalYear, baseWithdrawP1);
                            baseTaxP1 = taxObj.totalTax;
                            currentPool += (baseWithdrawP1 - baseTaxP1);
                        }

                        let baseWithdrawP2 = 0;
                        if (isRetired && currentP2Balance > 0) {
                            baseWithdrawP2 = Math.min(12, currentP2Balance);
                            currentP2Balance -= baseWithdrawP2;
                            currentPool += baseWithdrawP2;
                        }

                        // 2. [ë¶€ì¡± ìê¸ˆ ê³„ì‚°]
                        const yearsSinceCurrent = Math.max(0, age - currentAge);
                        const inflationFactor = Math.pow(1 + inflationRate, yearsSinceCurrent);
                        
                        // Step-down ì ìš©
                        let annualExpenseFuture = (baseMonthlyExpense * 12) * inflationFactor;
                        if (userData.useStepDown) {
                            if (age >= 90) annualExpenseFuture *= 0.7;
                            else if (age >= 80) annualExpenseFuture *= 0.8;
                            else if (age >= 70) annualExpenseFuture *= 0.9;
                        }

                        let annualNPSFuture = 0;
                        if (age >= receiptAge) {
                            const yearsTo65 = Math.max(0, 65 - currentAge);
                            const inflationTo65 = Math.pow(1 + inflationRate, yearsTo65);
                            const yearsPostReceipt = Math.max(0, age - receiptAge);
                            const inflationPostReceipt = Math.pow(1 + inflationRate, yearsPostReceipt);
                            annualNPSFuture = (adjustedBaseNPS * 12) * inflationTo65 * inflationPostReceipt;
                        }

                        let annualShortfall = 0;
                        if (isRetired) {
                            annualShortfall = Math.max(0, annualExpenseFuture - annualNPSFuture);
                        }

                        // 3. [ë¶€ì¡±ë¶„ ì±„ìš°ê¸°]
                        let remainingShortfall = annualShortfall;
                        
                        let usedPool = 0;
                        let usedP2_Deficit = 0;
                        let usedRetire_Deficit = 0;
                        let usedP1_Excess = 0;
                        
                        // (1) Pool ìš°ì„  ì‚¬ìš© (ë‹¤ìš´ì‚¬ì´ì§• + ì¼ë°˜ê³„ì¢Œ í¬í•¨)
                        if (remainingShortfall > 0 && currentPool > 0) {
                            usedPool = Math.min(currentPool, remainingShortfall);
                            currentPool -= usedPool;
                            remainingShortfall -= usedPool;
                        }

                        // (2) 1ìˆœìœ„ (P2)
                        if (remainingShortfall > 0 && currentP2Balance > 0) {
                            usedP2_Deficit = Math.min(currentP2Balance, remainingShortfall);
                            currentP2Balance -= usedP2_Deficit;
                            remainingShortfall -= usedP2_Deficit;
                        }

                        // (3) 2ìˆœìœ„ (í‡´ì§ì—°ê¸ˆ) - ì¸ì¶œí•œë„ ì ìš©
                        let taxRetire_Deficit = 0;
                        if (remainingShortfall > 0 && currentRetireBalance > 0) {
                            let withdrawLimit = currentRetireBalance;
                            if (withdrawalYear >= 1 && withdrawalYear <= 10) {
                                withdrawLimit = (currentRetireBalance / (11 - withdrawalYear)) * 1.2;
                            }

                            const estTaxRate = 0.05; 
                            const grossNeeded = remainingShortfall / (1 - estTaxRate);
                            let withdrawAttempt = Math.min(currentRetireBalance, withdrawLimit, grossNeeded);
                            
                            const taxObj = getTaxDetails(age, 'RETIRE', withdrawalYear, withdrawAttempt);
                            let netWithdraw = withdrawAttempt - taxObj.totalTax;
                            
                            currentRetireBalance -= withdrawAttempt;
                            usedRetire_Deficit = withdrawAttempt;
                            taxRetire_Deficit = taxObj.totalTax;
                            
                            currentPool += netWithdraw;
                            let useNow = Math.min(currentPool, remainingShortfall);
                            currentPool -= useNow;
                            remainingShortfall -= useNow;
                        }

                        // (4) 3ìˆœìœ„ (P1) ì´ˆê³¼ ì¸ì¶œ
                        let taxP1_Excess_Adjustment = 0;
                        if (remainingShortfall > 0 && currentP1Balance > 0) {
                            const taxPenalty = (1500 * 0.165) - baseTaxP1; 
                            const grossNeeded = (remainingShortfall + taxPenalty) / 0.835;
                            
                            usedP1_Excess = Math.min(currentP1Balance, grossNeeded);
                            currentP1Balance -= usedP1_Excess;
                            
                            const totalP1Withdraw = baseWithdrawP1 + usedP1_Excess;
                            const totalTax = totalP1Withdraw * 0.165;
                            const additionalTax = totalTax - baseTaxP1;
                            
                            const netInput = usedP1_Excess - additionalTax;
                            currentPool += netInput;
                            
                            let useNow = Math.min(currentPool, remainingShortfall);
                            currentPool -= useNow;
                            remainingShortfall -= useNow;
                            
                            taxP1_Excess_Adjustment = additionalTax;
                        }

                        // 4. [ê²°ê³¼ ê¸°ë¡ ë° ìì‚° ì„±ì¥]
                        const finalRemaining = remainingShortfall;
                        const isAdequate = isRetired && finalRemaining < 10;
                        if (isRetired && finalRemaining >= 10 && detectedShortageAge === null) {
                            detectedShortageAge = age;
                        }

                        const totalInputP1 = baseWithdrawP1 + usedP1_Excess;
                        const totalInputP2 = baseWithdrawP2 + usedP2_Deficit;
                        const totalInputRetire = usedRetire_Deficit;
                        const finalTaxP1 = baseTaxP1 + taxP1_Excess_Adjustment;
                        const finalTaxRetire = taxRetire_Deficit;

                        simulationResults.push({
                            age,
                            isRetired,
                            annualShortfall, 
                            finalRemaining,
                            currentPoolDisplay: currentPool,
                            isAdequate,
                            
                            inputTaxable: totalInputP1, 
                            inputP2: totalInputP2, 
                            inputRetire: totalInputRetire,
                            
                            netTaxable: totalInputP1 - finalTaxP1, 
                            netP2: totalInputP2, 
                            netRetire: totalInputRetire - finalTaxRetire,
                            
                            taxDetails: {
                                taxable: [{ name: usedP1_Excess > 0 ? 'ê¸°íƒ€ì†Œë“ì„¸(16.5%)' : 'ì—°ê¸ˆì†Œë“ì„¸', amount: Math.round(finalTaxP1) }],
                                retire: [{ name: 'í‡´ì§ì†Œë“ì„¸', amount: Math.round(finalTaxRetire) }],
                                p2: []
                            }
                        });

                        const gr = 1 + annualGrowthRate;
                        
                        if (currentPool > 0) currentPool *= gr;
                        if (currentP1Balance > 0) currentP1Balance *= gr;
                        if (currentP2Balance > 0) currentP2Balance *= gr;
                        if (currentRetireBalance > 0) currentRetireBalance *= gr;

                        if (age === userData.lifeAge) {
                            finalBalances = { 
                                p2: Math.max(0, currentP2Balance), 
                                retire: Math.max(0, currentRetireBalance), 
                                taxable: Math.max(0, currentP1Balance), 
                                pool: Math.max(0, currentPool) 
                            };
                            finalBalances.total = finalBalances.retire + finalBalances.taxable + finalBalances.pool + finalBalances.p2;
                        }
                    }
                }

                // ëª©ëˆ ì¶©ë‹¹ ì‹œë®¬ë ˆì´ì…˜ (í™”ë©´ í•˜ë‹¨ í…Œì´ë¸”ìš©)
                const simLumpSumRate = userData.lumpSumReturnRate !== undefined ? Number(userData.lumpSumReturnRate) : 3.0;
                let currentSimLumpSum = runningBal.isa + runningBal.general + runningBal.other; // 5ë‹¨ê³„ì—ì„œ ê³„ì‚°ëœ ìµœì¢… ëª©ëˆ
                let lumpSumSimulationRows = []; 
                let lumpSumDepletionAge = null; 

                simulationResults.forEach(res => {
                    const grLump = 1 + (simLumpSumRate/100);

                    if (!res.isRetired) {
                        currentSimLumpSum *= grLump;
                        return;
                    }

                    const needed = res.finalRemaining; 
                    let withdrawn = 0;

                    if (needed > 0 && currentSimLumpSum > 0) {
                        withdrawn = Math.min(currentSimLumpSum, needed);
                        currentSimLumpSum -= withdrawn;
                    }

                    const finalShort = needed - withdrawn;

                    if (finalShort >= 120 && lumpSumDepletionAge === null) {
                        lumpSumDepletionAge = res.age;
                    }

                    if (currentSimLumpSum > 0) currentSimLumpSum *= grLump;

                    lumpSumSimulationRows.push({
                        age: res.age,
                        shortfall: Math.round(needed),
                        withdraw: Math.round(withdrawn),    
                        finalShort: Math.round(finalShort), 
                        balance: Math.round(currentSimLumpSum) 
                    });
                });

                const updateWithdrawalPlan = (age, field, val) => {
                    setUserData(prev => ({
                        ...prev,
                        withdrawalPlan: {
                            ...prev.withdrawalPlan,
                            [age]: { ...(prev.withdrawalPlan[age] || {}), [field]: Number(val) }
                        }
                    }));
                };
                const updateNum = (k, v) => setUserData(p => ({...p, [k]: Number(v)}));
                
                // [ì¶”ê°€] í˜„ì¬ê°€ì¹˜ ê³„ì‚° íŒ©í„° (ê¸°ëŒ€ìˆ˜ëª… ê¸°ì¤€)
                const lAge = Number(lifeAge);
                const discountFactor = Math.pow(1 + inflationRate, lAge - Number(currentAge));

                // [ì¶”ê°€] ê¸ˆì•¡ í‘œì‹œ í—¬í¼ í•¨ìˆ˜ (í˜„ì¬ê°€ì¹˜ í¬í•¨)
                const renderMoneyWithPV = (amount, colorClass) => {
                    const pv = Math.round(amount / discountFactor);
                    const eok = Math.floor(amount / 10000);
                    const man = Math.round(amount % 10000);
                    
                    const pvEok = Math.floor(pv / 10000);
                    const pvMan = Math.round(pv % 10000);

                    return (
                        <div className="text-right">
                            <div className={`font-black text-lg ${colorClass}`}>
                                {eok > 0 ? `${eok}ì–µ ` : ''}{man.toLocaleString()}ë§Œ
                            </div>
                            <div className="text-xs text-slate-400 font-normal mt-1">
                                (í˜„ì¬ê°€ì¹˜: {pvEok > 0 ? `${pvEok}ì–µ ` : ''}{pvMan.toLocaleString()}ë§Œ)
                            </div>
                        </div>
                    );
                };

                // ==================================================================================
                // [2] í™”ë©´ ê·¸ë¦¬ê¸°
                // ==================================================================================
                return (
                    <div className="fade-in space-y-8">
                        <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                            <h2 className="text-2xl font-bold text-slate-800 mb-4">ğŸ’° ì€í‡´ì‹œì  ë‚´ ê³„ì¢Œì— ìŒ“ì¸ ì—°ê¸ˆê³¼ í‡´ì§ê¸ˆ í˜„í™©</h2>
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <p className="text-slate-700 leading-relaxed text-sm">
                                    ë‚´ ì€í‡´ì‹œì ì— ì—°ê¸ˆê³„ì¢Œì— ìŒ“ì—¬ìˆëŠ” ê¸ˆì•¡ì…ë‹ˆë‹¤. (5ë‹¨ê³„ ì ë¦½ ê³„íš + 10ë‹¨ê³„ ë‹¤ìš´ì‚¬ì´ì§• ë°˜ì˜ ê²°ê³¼)
                                </p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-slate-50 p-4 rounded-xl border border-blue-200">
                                    <div className="text-xs text-slate-500 mb-1 font-bold">1ìˆœìœ„ (ë¶€ì¡±ë¶„ ìš°ì„ )</div>
                                    <div className="text-sm text-slate-600 mb-1">ì—°ê¸ˆì €ì¶•2 ì›ê¸ˆ</div>
                                    <div className="text-xl font-bold text-blue-600">{Math.round(p2Principal).toLocaleString()} ë§Œì›</div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-green-200">
                                    <div className="text-xs text-slate-500 mb-1 font-bold">2ìˆœìœ„ (1ìˆœìœ„ ê³ ê°ˆ ì‹œ)</div>
                                    <div className="text-sm text-slate-600 mb-1">í‡´ì§ì—°ê¸ˆ</div>
                                    <div className="text-xl font-bold text-green-600">{Math.round(retirePrincipal).toLocaleString()} ë§Œì›</div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-orange-200 col-span-2">
                                    <div className="text-xs text-slate-500 mb-1 font-bold">3ìˆœìœ„ (ë§¤ë…„ 1500ë§Œ ì„ ì¸ì¶œ)</div>
                                    <div className="text-sm text-slate-600 mb-1">ì—°ê¸ˆì €ì¶•1/IRPì›ê¸ˆ + ìˆ˜ìµê¸ˆ</div>
                                    <div className="text-xl font-bold text-purple-600">{Math.round(p1IrpPrincipal + investmentReturns).toLocaleString()} ë§Œì›</div>
                                </div>
                            </div>
                            <div className="text-right border-t pt-4">
                                <div className="mb-1">
                                    <span className="text-slate-500 mr-2">ì´ ì—°ê¸ˆ ìì‚° í•©ê³„:</span>
                                    <span className="text-2xl font-black text-slate-800">{Math.round(totalBalance).toLocaleString()} ë§Œì›</span>
                                </div>
                            </div>

                            <div className="mt-6 bg-slate-100 p-4 rounded-xl">
                                <label className="block text-sm font-bold text-slate-700 mb-2">
                                    ğŸ“ˆ ì€í‡´ í›„ ì—°ê¸ˆ ìš´ìš© ìˆ˜ìµë¥  (ë§¤ë…„ ì”ì•¡ ì„±ì¥)
                                </label>
                                <div className="flex items-center gap-4">
                                    <input 
                                        type="range" 
                                        min="2" max="15" step="0.5" 
                                        value={userData.postRetirementReturnRate || 5} 
                                        onChange={(e) => updateNum('postRetirementReturnRate', e.target.value)}
                                        className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                    />
                                    <div className="font-bold text-blue-600 text-lg whitespace-nowrap">
                                        {userData.postRetirementReturnRate || 5}%
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-2">
                                    * ì„¤ì •í•œ ìˆ˜ìµë¥ ë§Œí¼ ë‚¨ì€ ì—°ê¸ˆ ì”ì•¡ê³¼ ì¸ì¶œ ë³´ê´€ê¸ˆì´ ë§¤ë…„ ì„±ì¥í•©ë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                        
                        {/* ë‹¤ìš´ì‚¬ì´ì§• ë°˜ì˜ ì•Œë¦¼ */}
                        {useDownsizing && (
                            <div className="bg-green-50 border border-green-200 p-4 rounded-lg flex items-center gap-3 animate-pulse">
                                <span className="text-2xl">ğŸ </span>
                                <div className="text-sm text-green-800">
                                    <strong>[ëŒ€ì±… ì ìš©ë¨]</strong> {downsizingAge}ì„¸ ì‹œì ì— ì£¼íƒ ë‹¤ìš´ì‚¬ì´ì§• ì°¨ì•¡ <strong>{downsizingAmount.toLocaleString()}ë§Œì›</strong>ì´ ì¸ì¶œí›„ ë³´ìœ ê¸ˆ(Pool)ì— ì¶”ê°€ë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-6 rounded-xl border shadow-sm overflow-hidden">
                            <div className="mb-6">
                                <h3 className="text-xl font-bold text-slate-800 mb-2">ğŸ“… ì—°ê¸ˆ ì¸ì¶œ ì‹œë®¬ë ˆì´ì…˜</h3>
                                <div className="mt-3 bg-indigo-50 border border-indigo-200 rounded-lg p-4 text-sm text-slate-700 leading-relaxed max-w-2xl">
                                    <h4 className="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                                        ğŸ’¡ ì‚¬ìš©ì ì •ì˜ ì¸ì¶œ ì „ëµ ì ìš©ë¨
                                    </h4>
                                    <ol className="list-decimal pl-5 space-y-1 text-xs">
                                        <li><strong>3ìˆœìœ„ ì„ ì¸ì¶œ:</strong> 55ì„¸ë¶€í„° ë§¤ë…„ 1,500ë§Œì›ì”© ì¸ì¶œí•˜ì—¬ ë³´ìœ ê¸ˆ(Pool)ì— ì ë¦½í•©ë‹ˆë‹¤.</li>
                                        <li><strong>ë³´ìœ ê¸ˆ ìš°ì„  ì‚¬ìš©:</strong> ì€í‡´ í›„ ìƒí™œë¹„ ë¶€ì¡± ì‹œ ì ë¦½ëœ ë³´ìœ ê¸ˆì„ ë¨¼ì € ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
                                        <li><strong>1ìˆœìœ„(P2) ì‚¬ìš©:</strong> ë³´ìœ ê¸ˆ ê³ ê°ˆ ì‹œ 1ìˆœìœ„ ê¸ˆì•¡ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
                                        <li><strong>2ìˆœìœ„(í‡´ì§) ì‚¬ìš©:</strong> 1ìˆœìœ„ ê³ ê°ˆ ì‹œ í‡´ì§ì—°ê¸ˆì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (10ë…„ê°„ ì¸ì¶œí•œë„ ì ìš©)</li>
                                        <li><strong>3ìˆœìœ„ ì´ˆê³¼ ì‚¬ìš©:</strong> ìµœí›„ì˜ ìˆ˜ë‹¨ìœ¼ë¡œ 3ìˆœìœ„ë¥¼ ì¶”ê°€ ì¸ì¶œí•©ë‹ˆë‹¤. (ì „ì•¡ 16.5% ê³¼ì„¸)</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto max-h-[600px]">
                                <table className="w-full text-sm text-center border-collapse">
                                    <thead className="bg-slate-100 text-slate-700 sticky top-0 z-10">
                                        <tr>
                                            <th className="p-3 border">ë‚˜ì´</th>
                                            <th className="p-3 border bg-red-50 text-red-700">í•„ìš”í•œ ê¸ˆì•¡<br/>(ìƒí™œë¹„-êµ­ë¯¼ì—°ê¸ˆ)</th>
                                            <th className="p-3 border text-purple-700">3ìˆœìœ„<br/>(ì„ ì¸ì¶œ+ì´ˆê³¼)</th>
                                            <th className="p-3 border text-blue-700">1ìˆœìœ„<br/>(ë¶€ì¡±ë¶„)</th>
                                            <th className="p-3 border text-green-700">2ìˆœìœ„<br/>(í‡´ì§ì—°ê¸ˆ)</th>
                                            <th className="p-3 border bg-slate-200">ë¶€ì¡±í•œ ê¸ˆì•¡</th>
                                            <th className="p-3 border bg-blue-50">ì¸ì¶œí›„<br/>ë³´ìœ ê¸ˆ(Pool)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {simulationResults.map((row) => (
                                            <tr key={row.age} className={`hover:bg-slate-50 ${row.age === userData.targetAge ? "bg-yellow-100 border-y-2 border-yellow-400" : ""}`}>
                                                <td className="p-2 border">
                                                    {row.age}ì„¸
                                                </td>
                                                
                                                <td className="p-2 border font-bold text-red-600 bg-red-50">
                                                    {row.isRetired ? Math.round(row.annualShortfall).toLocaleString() : "-"}
                                                </td>

                                                <td className="p-1 border">
                                                    <div className="flex flex-col">
                                                        <span className={`text-sm font-bold ${row.inputTaxable > 1500 ? 'text-red-500' : 'text-purple-600'}`}>
                                                            {Math.round(row.inputTaxable).toLocaleString()}
                                                        </span>
                                                        <span className="text-xs text-slate-400">ì„¸í›„ {Math.round(row.netTaxable).toLocaleString()}</span>
                                                        <span className="text-[9px] text-green-600 font-bold">
                                                            {row.taxDetails.taxable.map(t => <div key={t.name}>{t.name} {t.amount.toLocaleString()}</div>)}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="p-1 border">
                                                    <div className="flex flex-col">
                                                        <span className="text-sm font-bold text-blue-600">{Math.round(row.inputP2).toLocaleString()}</span>
                                                        <span className="text-[10px] text-slate-400">ì„¸í›„ {Math.round(row.netP2).toLocaleString()}</span>
                                                    </div>
                                                </td>
                                                <td className="p-1 border">
                                                    <div className="flex flex-col">
                                                        <span className="text-sm font-bold text-green-600">{Math.round(row.inputRetire).toLocaleString()}</span>
                                                        <span className="text-[10px] text-green-600 font-bold">
                                                            {row.taxDetails.retire.map(t => <div key={t.name}>{t.name} {t.amount.toLocaleString()}</div>)}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className={`p-2 border font-bold ${!row.isAdequate ? 'text-red-500' : 'text-slate-400'}`}>
                                                    {row.isRetired && !row.isAdequate ? Math.round(row.finalRemaining).toLocaleString() : "-"}
                                                </td>
                                                <td className={`p-2 border font-bold bg-blue-50 ${row.currentPoolDisplay < 0 ? 'text-red-600' : 'text-blue-700'}`}>
                                                    {row.age >= 55 ? Math.round(row.currentPoolDisplay).toLocaleString() : "-"}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-slate-50 p-4 text-xs text-right text-slate-500 border-t">
                                * ì¸ì¶œí›„ ë³´ìœ ê¸ˆ: ì—°ê¸ˆê³„ì¢Œì—ì„œ ì¸ì¶œí•˜ì—¬ ì„¸ê¸ˆì„ ì œí•˜ê³  ì‹¤ì œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëŒ€ê¸° ìê¸ˆì…ë‹ˆë‹¤. (ë‹¤ìš´ì‚¬ì´ì§•, ëª©ëˆ í¬í•¨)
                            </div>
                        </div>

                        {/* ======================= ê²°ê³¼ ìš”ì•½ ë°•ìŠ¤ (í˜„ì¬ê°€ì¹˜ ì¶”ê°€ë¨) ======================= */}
                        <div className="mt-8 border-4 border-slate-200 bg-white p-8 rounded-2xl text-center shadow-xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400"></div>
                            <div className="mb-6">
                                <p className="text-xl md:text-2xl font-black text-slate-800 leading-relaxed break-keep">
                                    "í˜„ì¬ê°€ì¹˜ ê¸°ì¤€ ë§¤ì›” <span className="text-blue-600 underline decoration-4 decoration-blue-100">{baseMonthlyExpense.toLocaleString()}ë§Œì›</span>ì˜ ìƒí™œë¹„ë¥¼ ì“¸ ê²½ìš°,<br/>
                                    {detectedShortageAge ? (
                                        <>
                                            <span className="text-red-600 bg-red-50 px-2 border border-red-200 rounded mx-1">{detectedShortageAge}ì„¸</span>
                                            ë¶€í„° ë…¸í›„ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤." ğŸ˜¢
                                        </>
                                    ) : (
                                        <>
                                            <span className="text-blue-600 bg-blue-50 px-2 border border-blue-200 rounded mx-1">ê¸°ëŒ€ìˆ˜ëª…({userData.lifeAge}ì„¸)</span>
                                            ê¹Œì§€ ì•ˆì •ì ì¸ ë…¸í›„ ìƒí™œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤." ğŸ‰
                                        </>
                                    )}
                                </p>
                            </div>

                            {finalBalances.total > 0 && (
                                <div className="bg-slate-50 rounded-xl border border-slate-200 p-6 text-left inline-block w-full max-w-3xl mt-4">
                                    <h4 className="text-center font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200">
                                        ğŸ ê¸°ëŒ€ìˆ˜ëª…({userData.lifeAge}ì„¸) ì¢…ë£Œ ì‹œ ë‚¨ëŠ” ê³„ì¢Œë³„ ì˜ˆìƒ ì”ì•¡
                                    </h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div className="flex flex-col p-3 bg-white rounded border border-slate-100">
                                            <div className="flex justify-between items-start">
                                                <span className="text-slate-500 font-medium pt-1">í‡´ì§ì—°ê¸ˆ (ì”ì•¡)</span>
                                                {renderMoneyWithPV(finalBalances.retire, "text-green-600")}
                                            </div>
                                        </div>
                                        <div className="flex flex-col p-3 bg-white rounded border border-slate-100">
                                            <div className="flex justify-between items-start">
                                                <span className="text-slate-500 font-medium pt-1">ì—°ê¸ˆì €ì¶•1/IRP (ë¯¸ì¸ì¶œ ì”ì•¡)</span>
                                                {renderMoneyWithPV(finalBalances.taxable, "text-purple-600")}
                                            </div>
                                        </div>
                                        <div className="flex flex-col p-3 bg-white rounded border border-slate-100">
                                            <div className="flex justify-between items-start">
                                                <span className="text-slate-500 font-medium pt-1">ì—°ê¸ˆì €ì¶•2 (ë¯¸ì¸ì¶œ ì”ì•¡)</span>
                                                {renderMoneyWithPV(finalBalances.p2, "text-blue-600")}
                                            </div>
                                        </div>
                                        <div className="flex flex-col p-3 bg-white rounded border border-slate-100">
                                            <div className="flex justify-between items-start">
                                                <span className="text-slate-500 font-medium pt-1">ì¸ì¶œë³´ìœ ê¸ˆ (Pool ì”ì•¡)</span>
                                                {renderMoneyWithPV(finalBalances.pool, "text-indigo-600")}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-3 border-t border-slate-300">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="font-bold text-slate-700">ì´ í•©ê³„</span>
                                            {renderMoneyWithPV(finalBalances.total, "text-slate-900")}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="block mt-6">
                                <p className="text-sm font-medium text-slate-500">
                                    ì—°ê¸ˆë§Œìœ¼ë¡œ ìƒí™œë¹„ê°€ ì¶©ë‹¹ë˜ì§€ ì•Šì„ ê²½ìš°, ISA/ì¼ë°˜ê³„ì¢Œì— ëª¨ì•„ë†“ì€ ëˆì„ í™œìš©í•´ì„œ ìƒí™œë¹„ë¥¼ ì¶©ë‹¹í•´ ë³¼ê¹Œìš”?
                                </p>
                            </div>
                        </div>
                        {/* ========================================================================= */}

                        <div className="mt-12 bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                            <div className="flex items-center gap-3 mb-4">
                                <span className="text-3xl">ğŸ’°</span>
                                <h2 className="text-2xl font-bold text-slate-800">ISAì™€ ì¼ë°˜ê³„ì¢Œì— ìŒ“ì¸ ëª©ëˆìœ¼ë¡œ í˜„ê¸ˆíë¦„ ë§Œë“¤ê¸°</h2>
                            </div>
                            
                            <div className="bg-indigo-50 border border-indigo-200 rounded-xl p-6 text-center mb-8">
                                <h3 className="text-indigo-900 font-bold mb-2">
                                    ì€í‡´ì‹œì ì¸ <span className="text-indigo-600 text-xl">{userData.targetAge}ì„¸</span>ì— ISA ê³„ì¢Œì™€ ì¼ë°˜ê³„ì¢Œì— ëª¨ì¼ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ê¸ˆì•¡
                                </h3>
                                <div className="text-4xl font-black text-indigo-700 my-4">
                                    {Math.round((runningBal.isa + runningBal.general + runningBal.other) / 10000).toLocaleString()}ì–µ {Math.round((runningBal.isa + runningBal.general + runningBal.other) % 10000).toLocaleString()}ë§Œì›
                                </div>
                                <div className="flex justify-center gap-4 text-sm text-slate-500">
                                    <span>ISA: {Math.round(runningBal.isa).toLocaleString()}ë§Œì›</span>
                                    <span>+</span>
                                    <span>ì¼ë°˜ê³„ì¢Œ: {Math.round(runningBal.general).toLocaleString()}ë§Œì›</span>
                                    <span>+</span>
                                    <span>ê¸°íƒ€: {Math.round(runningBal.other).toLocaleString()}ë§Œì›</span>
                                </div>
                            </div>

                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                <div className="mb-6">
                                    <label className="block text-sm font-bold text-slate-700 mb-2">
                                        ğŸ“ˆ ì€í‡´ í›„ ëª©ëˆ ìš´ìš© ëª©í‘œ ìˆ˜ìµë¥  (1% ~ 10%)
                                    </label>
                                    <div className="flex items-center gap-4">
                                        <input 
                                            type="range" 
                                            min="1" max="10" step="0.5" 
                                            value={simLumpSumRate} 
                                            onChange={(e) => updateNum('lumpSumReturnRate', e.target.value)}
                                            className="w-full md:w-64 h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                        />
                                        <span className="font-bold text-indigo-600 text-lg">{simLumpSumRate}%</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2">
                                        * ëª©ëˆ(ISA, ì¼ë°˜ê³„ì¢Œ ë“±)ì„ ë§¤ë…„ ì´ ìˆ˜ìµë¥ ë¡œ ìš´ìš©í•˜ë©° ë¶€ì¡±í•œ ìƒí™œë¹„ë¥¼ ì¸ì¶œí•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                                    </p>
                                </div>

                                <button 
                                    onClick={() => updateNum('showLumpSumSimulation', 1)}
                                    className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2"
                                >
                                    <span>ğŸ‘‰ ëª©ëˆìœ¼ë¡œ ë¶€ì¡±í•œ ìƒí™œë¹„ë¥¼ ì¶©ë‹¹í•˜ì (ê²°ê³¼ ë³´ê¸°)</span>
                                </button>
                            </div>

                            {userData.showLumpSumSimulation && (
                                <div className="mt-8 fade-in">
                                    <div className="overflow-x-auto max-h-[500px] border rounded-xl shadow-sm">
                                        <table className="w-full text-sm text-center border-collapse">
                                            <thead className="bg-indigo-50 text-indigo-900 sticky top-0 z-10">
                                                <tr>
                                                    <th className="p-3 border">ë‚˜ì´</th>
                                                    <th className="p-3 border bg-red-50 text-red-700">ì—°ê¸ˆ í™œìš© í›„<br/>ë¶€ì¡±í•œ ê¸ˆì•¡</th>
                                                    <th className="p-3 border bg-white text-indigo-700">ëª©ëˆì—ì„œ ì¸ì¶œ<br/>(ISA/ì¼ë°˜/ê¸°íƒ€)</th>
                                                    <th className="p-3 border bg-gray-100 text-gray-500">ìµœì¢… ë¶€ì¡±ì•¡</th>
                                                    <th className="p-3 border bg-blue-50 text-blue-900">ëª©ëˆ ì”ì•¡<br/>(ìˆ˜ìµë¥  {simLumpSumRate}% ë°˜ì˜)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-indigo-50">
                                                {lumpSumSimulationRows.map((row) => (
                                                    <tr key={row.age} className="hover:bg-indigo-50/30">
                                                        <td className="p-2 border font-medium">{row.age}ì„¸</td>
                                                        <td className="p-2 border font-bold text-red-600">
                                                            {row.shortfall > 0 ? row.shortfall.toLocaleString() : "-"}
                                                        </td>
                                                        <td className="p-2 border font-bold text-indigo-600">
                                                            {row.withdraw > 0 ? `+ ${row.withdraw.toLocaleString()}` : "-"}
                                                        </td>
                                                        <td className={`p-2 border font-bold ${row.finalShort > 0 ? 'text-red-500 bg-red-50' : 'text-gray-400 bg-gray-50'}`}>
                                                            {row.finalShort > 0 ? `-${row.finalShort.toLocaleString()}` : "í•´ê²°ë¨"}
                                                        </td>
                                                        <td className="p-2 border font-bold text-blue-800">
                                                            {row.balance.toLocaleString()}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="mt-6 p-6 bg-slate-800 text-white rounded-xl text-center shadow-lg">
                                        {lumpSumDepletionAge ? (
                                            <>
                                                <p className="text-red-300 font-bold mb-1">ğŸš¨ ì£¼ì˜ í•„ìš”</p>
                                                <p className="text-xl">
                                                    ëª©ëˆê¹Œì§€ ëª¨ë‘ í™œìš©í•´ë„ <span className="text-yellow-400 font-black text-2xl">{lumpSumDepletionAge}ì„¸</span> ë¶€í„°ëŠ” ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.
                                                </p>
                                            </>
                                        ) : (
                                            <>
                                                <p className="text-green-300 font-bold mb-1">âœ… ë…¸í›„ ì¤€ë¹„ ì™„ë£Œ</p>
                                                <p className="text-xl">
                                                    ì—°ê¸ˆê³¼ ëª©ëˆì„ í•©ì¹˜ë‹ˆ <span className="text-yellow-400 font-black">í‰ìƒ(ê¸°ëŒ€ìˆ˜ëª…ê¹Œì§€)</span> ìƒí™œë¹„ ê±±ì •ì´ ì—†ìŠµë‹ˆë‹¤!
                                                </p>
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
// ----------------------------------------------------------------------
// 8ë‹¨ê³„ (Index 7): ë‚´ íˆ¬ìì„±í–¥ íŒŒì•… (ìˆ˜ì •ë¨: ì§„ë‹¨ ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸ ë° ì¡°ì–¸ ê°•í™”)
            if (currentStep === 7 || STEPS[currentStep] === "ë‚´ íˆ¬ìì„±í–¥ íŒŒì•…") {
                // 20ë¬¸í•­ ë°ì´í„° ì •ì˜ (ê¸°ì¡´ ìœ ì§€)
                const QUESTIONS = [
                    // PART 1. ìœ„ê¸° ìƒí™©ì—ì„œì˜ ë°˜ì‘ (ê³µí¬ ì§€ìˆ˜)
                    { id: 1, part: "PART 1. ìœ„ê¸° ìƒí™©ì—ì„œì˜ ë°˜ì‘", q: "[í­ë½ì¥ì˜ ì•„ì¹¨] ê°„ë°¤ì— ë¯¸êµ­ ì¦ì‹œê°€ í­ë½í–ˆê³  í•œêµ­ ì£¼ì‹ë„ 5% ë„˜ê²Œ ë¹ ì§€ê³  ìˆë‹¤ëŠ” ì†ë³´ê°€ ë‚˜ì˜µë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì²« ë°˜ì‘ì€?", options: [
                        { val: 1, text: "A. (ê°€ìŠ´ì´ ì² ë í•˜ë©°) ë‹¹ì¥ ì¦ê¶Œ ì•±ì„ ì¼œì„œ ì§€ê¸ˆì´ë¼ë„ ì „ëŸ‰ ë§¤ë„í•´ì•¼ í• ì§€ ê³ ë¯¼í•œë‹¤." },
                        { val: 3, text: "B. (ê±±ì •ì€ ë˜ì§€ë§Œ) ì¼ì‹œì ì¸ í˜„ìƒì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë©°ì¹  ë” ê´€ë§í•˜ê¸°ë¡œ í•œë‹¤." },
                        { val: 5, text: "C. (ì˜¤íˆë ¤ ê¸°íšŒë‹¤) í‰ì†Œ ëˆˆì—¬ê²¨ë³´ë˜ ìš°ëŸ‰ì£¼ë¥¼ ì‹¸ê²Œ ì‚´ ê¸°íšŒë¼ ìƒê°í•˜ê³  ì˜ˆìˆ˜ê¸ˆì„ í™•ì¸í•œë‹¤." }
                    ]},
                    { id: 2, part: "PART 1. ìœ„ê¸° ìƒí™©ì—ì„œì˜ ë°˜ì‘", q: "[ìˆ˜ìµë¥  í™•ì¸] ì–´ì œê¹Œì§€ ë¹¨ê°„ë¶ˆ(ìˆ˜ìµ)ì´ë˜ ê³„ì¢Œê°€ ì˜¤ëŠ˜ íŒŒë€ë¶ˆ(ì†ì‹¤ -3%)ë¡œ ë°”ë€Œì–´ ìˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë–¨ê¹Œìš”?", options: [
                        { val: 1, text: "A. ê¸°ë¶„ì´ í™• ìƒí•´ì„œ í•˜ë£¨ ì¢…ì¼ ì¹œêµ¬ë“¤ê³¼ì˜ ëŒ€í™”ì— ì§‘ì¤‘ì´ ì•ˆ ëœë‹¤." },
                        { val: 3, text: "B. ì•½ê°„ ì°ì°í•˜ì§€ë§Œ, 'ì˜¤ë¥´ë½ë‚´ë¦¬ë½í•˜ëŠ” ê±°ì§€'ë¼ê³  ìƒê°í•˜ë©° ìŠê³  ë‚˜ê°„ë‹¤." },
                        { val: 5, text: "C. -3% ì •ë„ëŠ” ë³€ë™ í­ ì¶•ì—ë„ ëª» ë‚€ë‹¤. ì „í˜€ ì‹ ê²½ ì“°ì§€ ì•ŠëŠ”ë‹¤." }
                    ]},
                    { id: 3, part: "PART 1. ìœ„ê¸° ìƒí™©ì—ì„œì˜ ë°˜ì‘", q: "[ì§€ì¸ì˜ ëŒ€ë°• ì†Œì‹] ì¹œêµ¬ê°€ 'ì´ì°¨ì „ì§€ ì£¼ì‹ìœ¼ë¡œ 2ë°° ë²Œì–´ì„œ ì°¨ë¥¼ ë°”ê¿¨ë‹¤'ë©° ìë‘ì„ í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì†ë§ˆìŒì€?", options: [
                        { val: 1, text: "A. 'ìœ„í—˜í•˜ê²Œ ì£¼ì‹ì„ ì™œ í•´?' ë¶€ëŸ½ê¸°ë³´ë‹¤ëŠ” ìƒì„ê¹Œ ë´ ê±±ì •ëœë‹¤." },
                        { val: 3, text: "B. 'ë‚˜ë„ ì¢€ í•´ë³¼ê±¸ ê·¸ë¬ë‚˜?' ì‚´ì§ ë°°ê°€ ì•„í”„ê³  ì•„ì‰¬ìš´ ë§ˆìŒì´ ë“ ë‹¤." },
                        { val: 5, text: "C. 'ì§€ê¸ˆì´ë¼ë„ ëŠ¦ì§€ ì•Šì•˜ì–´.' ë‹¹ì¥ ê·¸ ì¹œêµ¬ì—ê²Œ ì¢…ëª©ì„ ë¬¼ì–´ë³´ê³  íˆ¬ìë¥¼ ê²€í† í•œë‹¤." }
                    ]},
                    { id: 4, part: "PART 1. ìœ„ê¸° ìƒí™©ì—ì„œì˜ ë°˜ì‘", q: "[ìˆ˜ë©´ í…ŒìŠ¤íŠ¸] ìì‚°ì˜ 30%ë¥¼ íˆ¬ìí•œ ìƒí’ˆì´ ìˆëŠ”ë°, ìµœê·¼ ë³€ë™ì„±ì´ ì‹¬í•´ì ¸ì„œ í‰ê°€ì•¡ì´ í¬ê²Œ ì›€ì§ì…ë‹ˆë‹¤. ë°¤ì— ì ì´ ì˜ ì˜¬ê¹Œìš”?", options: [
                        { val: 1, text: "A. ìê¾¸ ì‹ ê²½ ì“°ì—¬ì„œ ì ì„ ì„¤ì¹˜ê±°ë‚˜ ìƒˆë²½ì— ê¹¨ì„œ í•´ì™¸ ì¦ì‹œë¥¼ í™•ì¸í•œë‹¤." },
                        { val: 3, text: "B. ì‹ ê²½ì€ ì“°ì´ì§€ë§Œ ì ì„ ëª» ì˜ ì •ë„ëŠ” ì•„ë‹ˆë‹¤." },
                        { val: 5, text: "C. íˆ¬ìëŠ” íˆ¬ìê³  ì ì€ ì ì´ë‹¤. ë¨¸ë¦¬ë§Œ ëŒ€ë©´ ì˜ ì”ë‹¤." }
                    ]},
                    // PART 2. ê¸°ëŒ€ ìˆ˜ìµê³¼ ëª©í‘œ (ìš•ë§ ì§€ìˆ˜)
                    { id: 5, part: "PART 2. ê¸°ëŒ€ ìˆ˜ìµê³¼ ëª©í‘œ", q: "[ì€í–‰ì˜ ì œì•ˆ] ì§€ì ì¥ì´ 'ì›ê¸ˆë³´ì¥ ì—° 2% ì˜ˆê¸ˆ'ê³¼ 'ì›ê¸ˆë¹„ë³´ì¥ ì—° 7% í€ë“œ' ì¤‘ í•˜ë‚˜ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ íƒì€?", options: [
                        { val: 1, text: "A. ìˆ˜ìµë¥ ì´ ë‚®ì•„ë„ ë¬´ì¡°ê±´ ë§ˆìŒ í¸í•œ 'ì—° 2% ì˜ˆê¸ˆ'ì„ ì„ íƒí•œë‹¤." },
                        { val: 3, text: "B. ìì‚°ì˜ ì ˆë°˜ì€ ì˜ˆê¸ˆì—, ì ˆë°˜ì€ í€ë“œì— ë‚˜ëˆ„ì–´ ë„£ëŠ”ë‹¤." },
                        { val: 5, text: "C. ë¬¼ê°€ ìƒìŠ¹ë¥ ì„ ê³ ë ¤í•˜ë©´ 2%ëŠ” ì†í•´ë‹¤. 'ì—° 7% í€ë“œ'ë¥¼ ì„ íƒí•œë‹¤." }
                    ]},
                    { id: 6, part: "PART 2. ê¸°ëŒ€ ìˆ˜ìµê³¼ ëª©í‘œ", q: "[ë¬¼ê°€ ìƒìŠ¹ì˜ ê³µí¬] ë§¤ë…„ ë¬¼ê°€ê°€ 3~4%ì”© ì˜¤ë¥¸ë‹¤ê³  í•©ë‹ˆë‹¤. í˜„ì¬ ë‹¹ì‹ ì´ ë³´ìœ í•œ í˜„ê¸ˆ ìì‚°ì„ ë³´ë©° ë“œëŠ” ìƒê°ì€?", options: [
                        { val: 1, text: "A. ëˆì˜ ê°€ì¹˜ê°€ ë–¨ì–´ì§€ëŠ” ê²ƒë³´ë‹¤, íˆ¬ìí•˜ë‹¤ê°€ ì›ê¸ˆì„ ìƒëŠ” ê²Œ ë” ë¬´ì„­ë‹¤. ê·¸ëƒ¥ ë‘”ë‹¤." },
                        { val: 3, text: "B. ì˜ˆê¸ˆ ì´ìë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹ˆ, ë°°ë‹¹ì£¼ ì •ë„ëŠ” ì‚¬ì•¼ê² ë‹¤ê³  ìƒê°í•œë‹¤." },
                        { val: 5, text: "C. í˜„ê¸ˆì€ ì“°ë ˆê¸°ë‹¤. ì ê·¹ì ìœ¼ë¡œ íˆ¬ìí•´ì„œ ë¬¼ê°€ ìƒìŠ¹ë¥  ì´ìƒì˜ ìˆ˜ìµì„ ë‚´ì•¼ í•œë‹¤." }
                    ]},
                    { id: 7, part: "PART 2. ê¸°ëŒ€ ìˆ˜ìµê³¼ ëª©í‘œ", q: "[ë³µê¶Œ ë‹¹ì²¨] 5ì²œë§Œ ì› ê½ëˆì´ ìƒê²¼ìŠµë‹ˆë‹¤! ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", options: [
                        { val: 1, text: "A. ë¹šì„ ê°šê±°ë‚˜ ì•ˆì „í•œ ì •ê¸°ì˜ˆê¸ˆì— ë„£ì–´ë‘”ë‹¤." },
                        { val: 3, text: "B. í‰ì†Œ ì‚¬ê³  ì‹¶ì—ˆë˜ ìš°ëŸ‰ì£¼ë‚˜ ETFë¥¼ ë§¤ìˆ˜í•œë‹¤." },
                        { val: 5, text: "C. í‰ì†Œë¼ë©´ ë¬´ì„œì›Œì„œ ëª» ìƒ€ë˜ ê³ ìœ„í—˜ ì½”ì¸ì´ë‚˜ ê¸‰ë“±ì£¼ì— ê³¼ê°í•˜ê²Œ íˆ¬ìí•´ ë³¸ë‹¤." }
                    ]},
                    { id: 8, part: "PART 2. ê¸°ëŒ€ ìˆ˜ìµê³¼ ëª©í‘œ", q: "[ì†ì‹¤ê³¼ ì´ìµì˜ ë¬´ê²Œ] ë‘ ê°€ì§€ ìƒí™© ì¤‘ ë‹¹ì‹ ì—ê²Œ ë” í¬ê²Œ ë‹¤ê°€ì˜¤ëŠ” ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?", options: [
                        { val: 1, text: "A. ê¸¸ ê°€ë‹¤ 5ë§Œ ì›ì„ ìƒì–´ë²„ë ¸ì„ ë•Œì˜ 'ì†ì“°ë¦¼'ì´ í›¨ì”¬ í¬ë‹¤." },
                        { val: 3, text: "B. ë¹„ìŠ·í•˜ë‹¤." },
                        { val: 5, text: "C. ê¸¸ ê°€ë‹¤ 5ë§Œ ì›ì„ ì£¼ì› ì„ ë•Œì˜ 'ê¸°ì¨'ì´ í›¨ì”¬ í¬ë‹¤." }
                    ]},
                    // PART 3. íˆ¬ì ì§€ì‹ê³¼ ê²½í—˜
                    { id: 9, part: "PART 3. íˆ¬ì ì§€ì‹ê³¼ ê²½í—˜", q: "[ìƒí’ˆ ì„¤ëª…ì„œ] ì¦ê¶Œì‚¬ ì§ì›ì´ ë³µì¡í•œ ELS(íŒŒìƒê²°í•©ì¦ê¶Œ) ìƒí’ˆì„ ê¶Œìœ í•©ë‹ˆë‹¤. ì´ë•Œ ë‹¹ì‹ ì˜ ë°˜ì‘ì€?", options: [
                        { val: 1, text: "A. ë¬´ìŠ¨ ë§ì¸ì§€ í•˜ë‚˜ë„ ëª¨ë¥´ê² ë‹¤. ë³µì¡í•œ ê±´ ë”± ì§ˆìƒ‰ì´ë‹ˆ ê±°ì ˆí•œë‹¤." },
                        { val: 3, text: "B. ëŒ€ì¶©ì€ ì•Œê² ëŠ”ë° 100% ì´í•´ëŠ” ì•ˆ ëœë‹¤. ì§‘ì— ê°€ì„œ ë” ì°¾ì•„ë³´ê³  ê²°ì •í•œë‹¤." },
                        { val: 5, text: "C. êµ¬ì¡°ì™€ ìœ„í—˜ì„±ì„ ì™„ë²½íˆ ì´í•´í•˜ê³  ìˆìœ¼ë©°, ë‚´ íŒë‹¨í•˜ì— ê°€ì… ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤." }
                    ]},
                    { id: 10, part: "PART 3. íˆ¬ì ì§€ì‹ê³¼ ê²½í—˜", q: "[í­ë½ì˜ ê²½í—˜] ê³¼ê±° ê¸ˆìœµìœ„ê¸°ë‚˜ ëŒ€í­ë½ì¥ì„ ê²ªì—ˆì„ ë•Œ, ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í–‰ë™í–ˆë‚˜ìš”? (ê²½í—˜ì´ ì—†ë‹¤ë©´ ìƒìƒí•´ì„œ)", options: [
                        { val: 1, text: "A. ê³µí¬ë¥¼ ëª» ì´ê¸°ê³  ë°”ë‹¥ì—ì„œ ì „ëŸ‰ ë§¤ë„í•˜ê³  ì‹œì¥ì„ ë– ë‚¬ë‹¤." },
                        { val: 3, text: "B. ë¬´ì„œì› ì§€ë§Œ íŒ”ì§€ ì•Šê³  ì›ê¸ˆì´ íšŒë³µë  ë•Œê¹Œì§€ ê·¸ëƒ¥ 'ì¡´ë²„'í–ˆë‹¤." },
                        { val: 5, text: "C. ì˜¤íˆë ¤ ì €ì  ë§¤ìˆ˜ì˜ ê¸°íšŒë¡œ ì‚¼ì•„ ì¶”ê°€ ìê¸ˆì„ íˆ¬ì…í–ˆë‹¤." }
                    ]},
                    { id: 11, part: "PART 3. íˆ¬ì ì§€ì‹ê³¼ ê²½í—˜", q: "[ETFë€?] ìë…€ê°€ ì™€ì„œ 'ETFê°€ ì •í™•íˆ ë­ì˜ˆìš”?'ë¼ê³  ë¬»ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëŒ€ë‹µì€?", options: [
                        { val: 1, text: "A. 'ê¸€ì„ë‹¤... í€ë“œ ê°™ì€ ê±´ê°€? ì€í–‰ ê°€ì„œ ë¬¼ì–´ë´ë¼.'" },
                        { val: 3, text: "B. 'ì£¼ì‹ì²˜ëŸ¼ ì‚¬ê³ íŒŒëŠ” í€ë“œì¸ë°, ì—¬ëŸ¬ ì¢…ëª©ì„ ë¬¶ì–´ë†“ì€ ê±°ì•¼.' (ê¸°ë³¸ ê°œë… ì„¤ëª…)" },
                        { val: 5, text: "C. 'ì¸ë±ìŠ¤ í€ë“œë¥¼ ê±°ë˜ì†Œì— ìƒì¥ì‹œí‚¨ ê±´ë°, ë³´ìˆ˜ê°€ ì €ë ´í•˜ê³  ë¶„ì‚°íˆ¬ì íš¨ê³¼ê°€ ìˆì§€.' (ì¥ë‹¨ì  ì„¤ëª…)" }
                    ]},
                    { id: 12, part: "PART 3. íˆ¬ì ì§€ì‹ê³¼ ê²½í—˜", q: "[íˆ¬ì ê²°ì • ì£¼ì²´] ì€í‡´ ìê¸ˆ 1ì–µ ì›ì„ êµ´ë ¤ì•¼ í•©ë‹ˆë‹¤. ëˆ„êµ¬ì˜ ì˜ê²¬ì„ ê°€ì¥ ì‹ ë¢°í•˜ë‚˜ìš”?", options: [
                        { val: 1, text: "A. ì€í–‰ ì§ì›ì´ë‚˜ ì¦ê¶Œì‚¬ ì°½êµ¬ ì§ì›ì´ ê¶Œí•´ì£¼ëŠ” ìƒí’ˆì´ ì œì¼ ë¯¿ìŒì§í•˜ë‹¤." },
                        { val: 3, text: "B. ìœ íŠœë¸Œë‚˜ ì±…, ì „ë¬¸ê°€ë“¤ì˜ ì˜ê²¬ì„ ì°¸ê³ í•˜ë˜ ìµœì¢… ê²°ì •ì€ ë‚´ê°€ í•œë‹¤." },
                        { val: 5, text: "C. ë‚˜ë§Œì˜ íˆ¬ì ì›ì¹™ê³¼ ë°ì´í„° ë¶„ì„ì„ ë¯¿ëŠ”ë‹¤. ë‚¨ì˜ ë§ì€ ì°¸ê³ ë§Œ í•  ë¿ì´ë‹¤." }
                    ]},
                    // PART 4. í˜„ì¬ ì¬ì • ìƒí™©
                    { id: 13, part: "PART 4. í˜„ì¬ ì¬ì • ìƒí™©", q: "[ë¹„ìƒê¸ˆ ìœ ë¬´] ë‚´ì¼ ë‹¹ì¥ ê°€ì¡± ìˆ˜ìˆ ë¹„ë¡œ 2ì²œë§Œ ì›ì´ í•„ìš”í•©ë‹ˆë‹¤. íˆ¬ì ì¤‘ì¸ ìì‚°ì„ ê¹¨ì§€ ì•Šê³  í•´ê²°í•  ìˆ˜ ìˆë‚˜ìš”?", options: [
                        { val: 1, text: "A. ì•„ë‹ˆë‹¤. íˆ¬ì ì¤‘ì¸ ìƒí’ˆì„ ì†í•´ ë³´ê³ ì„œë¼ë„ íŒ”ì•„ì•¼ í•œë‹¤." },
                        { val: 3, text: "B. ë¹ ë“¯í•˜ì§€ë§Œ ë³´í—˜ ì•½ê´€ ëŒ€ì¶œ ë“±ì„ í™œìš©í•˜ë©´ ê°€ëŠ¥í•  ê²ƒ ê°™ë‹¤." },
                        { val: 5, text: "C. ê·¸ë ‡ë‹¤. ì–¸ì œë“  ì“¸ ìˆ˜ ìˆëŠ” ë¹„ìƒê¸ˆ(CMA, ì˜ˆê¸ˆ)ì´ ë”°ë¡œ ì¤€ë¹„ë˜ì–´ ìˆë‹¤." }
                    ]},
                    { id: 14, part: "PART 4. í˜„ì¬ ì¬ì • ìƒí™©", q: "[ê³ ì • ìˆ˜ì…] êµ­ë¯¼ì—°ê¸ˆ ë“± ê³ ì • ìˆ˜ì…ë§Œìœ¼ë¡œ ìµœì € ìƒí™œë¹„ ì¶©ë‹¹ì´ ê°€ëŠ¥í•©ë‹ˆê¹Œ? (íˆ¬ì ìˆ˜ìµ ì œì™¸)", options: [
                        { val: 1, text: "A. ë¶ˆê°€ëŠ¥í•˜ë‹¤. íˆ¬ì ìì‚°(ì›ê¸ˆ)ì„ í—ì–´ì„œ ìƒí™œë¹„ë¡œ ì¨ì•¼ í•œë‹¤." },
                        { val: 3, text: "B. ì•„ê»´ ì“°ë©´ ë¨¹ê³ ëŠ” ì‚´ ìˆ˜ ìˆëŠ” ì •ë„ë‹¤." },
                        { val: 5, text: "C. ì¶©ë¶„í•˜ë‹¤. íˆ¬ì ìì‚°ì€ ê±´ë“œë¦¬ì§€ ì•Šê³  ì˜¤ë¡œì§€ ì—¬ìœ  ìê¸ˆ ì¦ì‹ ëª©ì ìœ¼ë¡œë§Œ êµ´ë¦°ë‹¤." }
                    ]},
                    { id: 15, part: "PART 4. í˜„ì¬ ì¬ì • ìƒí™©", q: "[íˆ¬ì ê¸°ê°„] ì§€ê¸ˆ íˆ¬ìí•˜ëŠ” ì´ ëˆ, ì–¸ì œì¯¤ êº¼ë‚´ ì“¸ ì˜ˆì •ì¸ê°€ìš”?", options: [
                        { val: 1, text: "A. 1~2ë…„ ë‚´ì— ìë…€ ê²°í˜¼ ìê¸ˆì´ë‚˜ ì „ì„¸ê¸ˆìœ¼ë¡œ ì¨ì•¼ í•  ëˆì´ë‹¤." },
                        { val: 3, text: "B. íŠ¹ë³„í•œ ì¼ì´ ì—†ë‹¤ë©´ 5ë…„ ì •ë„ëŠ” ë¬»ì–´ë‘˜ ìˆ˜ ìˆë‹¤." },
                        { val: 5, text: "C. 10ë…„ ì´ìƒ, í˜¹ì€ ìë…€ì—ê²Œ ë¬¼ë ¤ì¤„ ìƒê°ìœ¼ë¡œ ì•„ì£¼ ê¸¸ê²Œ ë³´ê³  ìˆë‹¤." }
                    ]},
                    { id: 16, part: "PART 4. í˜„ì¬ ì¬ì • ìƒí™©", q: "[ë°°ìš°ìì˜ ì„±í–¥] ë‹¹ì‹ ì´ ì£¼ì‹ ë¹„ì¤‘ì„ ëŠ˜ë¦¬ê² ë‹¤ê³  í–ˆì„ ë•Œ, ë°°ìš°ìì˜ ë°˜ì‘ì€?", options: [
                        { val: 1, text: "A. ê²°ì‚¬ë°˜ëŒ€. 'ì ˆëŒ€ ì•ˆ ë¼! ì•ˆì „í•œ ê²Œ ìµœê³ ì•¼!'ë¼ê³  ì‹¸ì›€ì´ ë‚œë‹¤." },
                        { val: 3, text: "B. 'ë„ˆë¬´ ìœ„í—˜í•˜ì§€ ì•Šê²Œë§Œ í•´'ë¼ë©° ìš°ë ¤ ì„ì¸ ë™ì˜ë¥¼ í•œë‹¤." },
                        { val: 5, text: "C. 'ë‹¹ì‹  íŒë‹¨ì„ ë¯¿ì–´'ë¼ë©° ì „ì ìœ¼ë¡œ ì§€ì§€í•´ ì£¼ê±°ë‚˜, ë°°ìš°ìê°€ ë” ê³µê²©ì ì´ë‹¤." }
                    ]},
                    // PART 5. ìƒí™©ë³„ ì‹œë®¬ë ˆì´ì…˜
                    { id: 17, part: "PART 5. ì¢…í•© íŒë‹¨", q: "[ë§ˆì´ë„ˆìŠ¤ 20%] ì€í‡´ ìê¸ˆ 3ì–µì„ íˆ¬ìí–ˆëŠ”ë°, 1ë…„ ë’¤ -6,000ë§Œ ì›(í‰ê°€ì•¡ 2ì–µ 4ì²œ)ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¬ì •ì€?", options: [
                        { val: 1, text: "A. 'ë‚´ í”¼ ê°™ì€ ëˆ...' ë³‘ì´ ë‚  ê²ƒ ê°™ê³ , ë‚¨ì€ ëˆì´ë¼ë„ ê±´ì§€ê¸° ìœ„í•´ ë‹¹ì¥ í™˜ë§¤í•œë‹¤." },
                        { val: 3, text: "B. 'ì–¸ì  ê°„ ì˜¤ë¥´ê² ì§€' ì“°ë¦° ì†ì„ ë‹¬ë˜ë©° ì›ê¸ˆ íšŒë³µì„ ê¸°ë‹¤ë¦°ë‹¤." },
                        { val: 5, text: "C. 'ì‹¸ê²Œ ì‚´ ê¸°íšŒë‹¤' ì—¬ìœ  ìê¸ˆì´ ìˆë‹¤ë©´ ë¬¼íƒ€ê¸°(ì¶”ê°€ ë§¤ìˆ˜)ë¥¼ í•œë‹¤." }
                    ]},
                    { id: 18, part: "PART 5. ì¢…í•© íŒë‹¨", q: "[í•´ì™¸ ì—¬í–‰ ìê¸ˆ] 3ë…„ ë’¤ ì„¸ê³„ì—¬í–‰ì„ ê°€ë ¤ê³  3ì²œë§Œ ì›ì„ ëª¨ìœ¼ë ¤ í•©ë‹ˆë‹¤. ë°©ë²•ì€?", options: [
                        { val: 1, text: "A. ë¬´ì¡°ê±´ ì•ˆì „í•˜ê²Œ ì ê¸ˆì— ë„£ëŠ”ë‹¤. ì—¬í–‰ ëª» ê°€ë©´ í°ì¼ ë‚˜ë‹ˆê¹Œ." },
                        { val: 3, text: "B. ì±„ê¶Œí˜• í€ë“œë‚˜ ë°°ë‹¹ì£¼ ETF ì •ë„ë¡œ ì¤‘ìœ„í—˜ íˆ¬ìë¥¼ í•œë‹¤." },
                        { val: 5, text: "C. ì„±ì¥ì£¼ì— ê³µê²©ì ìœ¼ë¡œ íˆ¬ìí•´ì„œ, ì˜ë˜ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ì„ íƒ€ê³  ì•ˆ ë˜ë©´ ì—¬í–‰ì§€ë¥¼ ë°”ê¾¼ë‹¤." }
                    ]},
                    { id: 19, part: "PART 5. ì¢…í•© íŒë‹¨", q: "[ìµœì¢… ëª©í‘œ] ì€í‡´ íˆ¬ìë¥¼ í†µí•´ ë‹¹ì‹ ì´ ê°€ì¥ ì–»ê³  ì‹¶ì€ ê²ƒì€?", options: [
                        { val: 1, text: "A. ì‹¬ë¦¬ì  ì•ˆì •. ìˆ˜ìµì€ ì ì–´ë„ ì¢‹ìœ¼ë‹ˆ ì›ê¸ˆì´ ì ˆëŒ€ ì¤„ì§€ ì•ŠëŠ” ê²ƒ." },
                        { val: 3, text: "B. êµ¬ë§¤ë ¥ ë³´ì¡´. ë¬¼ê°€ ìƒìŠ¹ë¥ ë§Œí¼ì€ ë”°ë¼ê°€ì„œ ë‚´ ëˆì˜ ê°€ì¹˜ë¥¼ ì§€í‚¤ëŠ” ê²ƒ." },
                        { val: 5, text: "C. ìì‚° ì¦ì‹. ì€í‡´ í›„ì—ë„ ìì‚°ì„ ë¶ˆë ¤ ë” í’ìš”ë¡œìš´ ë…¸í›„ë¥¼ ì¦ê¸°ëŠ” ê²ƒ." }
                    ]},
                    { id: 20, part: "PART 5. ì¢…í•© íŒë‹¨", q: "[ê³¼ê±°ì˜ í›„íšŒ] ê³¼ê±° íˆ¬ìì—ì„œ ê°€ì¥ í›„íšŒë˜ì—ˆë˜ ìˆœê°„ì€?", options: [
                        { val: 1, text: "A. ì£¼ì‹ì„ ìƒ€ë‹¤ê°€ ì†í•´ë¥¼ ë³´ê³  íŒ”ì•˜ì„ ë•Œ ('ë‚´ê°€ ì™œ ì£¼ì‹ì„ í–ˆì„ê¹Œ')" },
                        { val: 3, text: "B. íŒ”ê³  ë‚˜ë‹ˆ ë” ì˜¬ëì„ ë•Œ, í˜¹ì€ ì‚¬ê³  ë‚˜ë‹ˆ ë–¨ì–´ì¡Œì„ ë•Œ ('íƒ€ì´ë°ì„ ëª» ë§ì·„ì–´')" },
                        { val: 5, text: "C. ê·¸ë•Œ ê³¼ê°í•˜ê²Œ ì‚¬ì§€ ëª»í•˜ê³  ë§ì„¤ì´ë‹¤ê°€ ëŒ€ë°• ê¸°íšŒë¥¼ ë†“ì³¤ì„ ë•Œ ('ê·¸ë•Œ ì§ˆë €ì–´ì•¼ í–ˆëŠ”ë°')" }
                    ]}
                ];

                const currentAnswers = userData.propensityAnswers || {};
                const answeredCount = Object.keys(currentAnswers).length;
                const progressPercent = Math.round((answeredCount / QUESTIONS.length) * 100);
                
                const calculatePropensity = () => {
                    if (answeredCount < QUESTIONS.length) {
                        alert(`ì•„ì§ ${QUESTIONS.length - answeredCount}ê°œì˜ ë¬¸í•­ì— ë‹µë³€í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    const score = Object.values(currentAnswers).reduce((a, b) => a + b, 0);
                    let type = "";
                    
                    if (score <= 40) type = "Aìœ í˜•: ì² ë²½ ìˆ˜ë¹„í˜•"; 
                    else if (score <= 70) type = "Bìœ í˜•: ì˜¬ë¼ìš´ë“œí˜•"; 
                    else type = "Cìœ í˜•: ë‹¥ê³µ(ë‹¥ì¹˜ê³  ê³µê²©)í˜•"; 

                    setUserData(prev => ({
                        ...prev,
                        propensityScore: score,
                        propensityType: type
                    }));

                    setTimeout(() => {
                        const resultDiv = document.getElementById('propensity-result');
                        if (resultDiv) resultDiv.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                };

                const handleRadioChange = (qId, val) => {
                    setUserData(prev => ({
                        ...prev,
                        propensityAnswers: {
                            ...(prev.propensityAnswers || {}),
                            [qId]: val
                        }
                    }));
                };

                const resetTest = () => {
                    if(confirm("ì§„ë‹¨ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        setUserData(prev => ({ ...prev, propensityAnswers: {}, propensityScore: null, propensityType: null }));
                        window.scrollTo(0,0);
                    }
                };

                return (
                    <div className="fade-in space-y-10 pb-20">
                        <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl">
                            <h2 className="text-2xl font-bold mb-3">ğŸ§  ë‚´ íˆ¬ìì„±í–¥ íŒŒì•…í•˜ê¸°</h2>
                            <p className="opacity-80 leading-relaxed">
                                ì€í‡´ í›„ íˆ¬ìëŠ” ìì‚° ì¦ì‹ë³´ë‹¤ <strong>'ìì‚° ìˆ˜ëª…'</strong>ê³¼ <strong>'ì‹¬ë¦¬ì  í‰ì˜¨'</strong>ì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤.<br/>
                                20ê°€ì§€ ìƒí™©ë³„ ì§ˆë¬¸ì„ í†µí•´, ë‚´ê°€ ê°ë‹¹í•  ìˆ˜ ìˆëŠ” ìœ„í—˜ ìˆ˜ì¤€ê³¼ ì í•©í•œ íˆ¬ì ìŠ¤íƒ€ì¼ì„ ì§„ë‹¨í•´ë³´ì„¸ìš”.
                            </p>
                            
                            <div className="mt-6">
                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>ì§„í–‰ë¥ </span>
                                    <span>{progressPercent}% ({answeredCount}/{QUESTIONS.length})</span>
                                </div>
                                <div className="w-full bg-slate-700 rounded-full h-3">
                                    <div 
                                        className="bg-gradient-to-r from-blue-500 to-indigo-500 h-3 rounded-full transition-all duration-500 ease-out" 
                                        style={{ width: `${progressPercent}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-8">
                            {QUESTIONS.map((q, idx) => {
                                const showHeader = idx === 0 || QUESTIONS[idx-1].part !== q.part;
                                const isAnswered = currentAnswers[q.id] !== undefined;

                                return (
                                    <div key={q.id}>
                                        {showHeader && (
                                            <h3 className="text-xl font-black text-slate-700 mt-12 mb-4 border-b-2 border-slate-200 pb-2 inline-block">
                                                {q.part}
                                            </h3>
                                        )}
                                        <div className={`p-6 rounded-xl border-2 transition-all duration-300 ${isAnswered ? 'bg-white border-blue-200 shadow-md' : 'bg-slate-50 border-slate-100'}`}>
                                            <div className="flex gap-3 mb-4">
                                                <span className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isAnswered ? 'bg-blue-600 text-white' : 'bg-slate-300 text-slate-600'}`}>
                                                    {idx + 1}
                                                </span>
                                                <h4 className="text-lg font-bold text-slate-800 leading-snug">{q.q}</h4>
                                            </div>
                                            
                                            <div className="space-y-3 pl-2 md:pl-11">
                                                {q.options.map((opt) => (
                                                    <label 
                                                        key={opt.val} 
                                                        className={`flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-all hover:bg-blue-50
                                                            ${currentAnswers[q.id] === opt.val 
                                                                ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500 shadow-inner' 
                                                                : 'bg-white border-slate-200'}`
                                                        }
                                                    >
                                                        <input 
                                                            type="radio" 
                                                            name={`q-${q.id}`} 
                                                            value={opt.val}
                                                            checked={currentAnswers[q.id] === opt.val}
                                                            onChange={() => handleRadioChange(q.id, opt.val)}
                                                            className="mt-1 w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500"
                                                        />
                                                        <span className={`text-sm ${currentAnswers[q.id] === opt.val ? 'text-blue-900 font-bold' : 'text-slate-600'}`}>
                                                            {opt.text}
                                                        </span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="text-center py-8">
                            {!userData.propensityScore ? (
                                <button 
                                    onClick={calculatePropensity}
                                    className={`px-10 py-4 rounded-full font-bold text-lg shadow-xl transition transform hover:-translate-y-1 
                                        ${answeredCount === QUESTIONS.length 
                                            ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:shadow-2xl' 
                                            : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`
                                    }
                                    disabled={answeredCount < QUESTIONS.length}
                                >
                                    {answeredCount < QUESTIONS.length ? `ì•„ì§ ${QUESTIONS.length - answeredCount}ë¬¸ì œ ë‚¨ì•˜ìŠµë‹ˆë‹¤` : "ê²°ê³¼ ë¶„ì„í•˜ê¸° ğŸ“Š"}
                                </button>
                            ) : (
                                <button onClick={resetTest} className="text-slate-400 underline text-sm hover:text-slate-600">
                                    ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°
                                </button>
                            )}
                        </div>

                        {userData.propensityScore && (
                            <div id="propensity-result" className="fade-in bg-white border-4 border-indigo-100 rounded-3xl p-8 md:p-10 shadow-2xl relative overflow-hidden mt-10">
                                <div className="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500"></div>
                                
                                <div className="text-center mb-10">
                                    <div className="inline-block bg-indigo-100 text-indigo-800 px-4 py-1 rounded-full text-sm font-bold mb-4 shadow-sm">
                                        ì§„ë‹¨ ê²°ê³¼ ì™„ë£Œ
                                    </div>
                                    <h3 className="text-3xl md:text-4xl font-black text-slate-800 mb-2">
                                        ë‹¹ì‹ ì˜ íˆ¬ì ì„±í–¥ì€<br/>
                                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                                            [{userData.propensityType}]
                                        </span> ì…ë‹ˆë‹¤.
                                    </h3>
                                    <p className="text-slate-500 mt-2 font-medium">ì´ì : {userData.propensityScore}ì  / 100ì </p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                                    <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h4 className="font-bold text-slate-700 mb-4 text-center">ë‚˜ì˜ ìœ„í—˜ ì„±í–¥ ìœ„ì¹˜</h4>
                                        <div className="relative h-6 bg-slate-200 rounded-full mb-2 shadow-inner">
                                            <div className="absolute top-0 left-0 h-full w-full rounded-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 opacity-50"></div>
                                            <div 
                                                className="absolute top-[-8px] w-1 h-10 bg-slate-800 border-2 border-white shadow-xl transition-all duration-1000 ease-out z-10" 
                                                style={{ left: `${userData.propensityScore}%` }}
                                            >
                                                <div className="absolute top-[-25px] left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold whitespace-nowrap">
                                                    ë‚˜ ({userData.propensityScore})
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex justify-between text-xs font-bold text-slate-400 mt-2">
                                            <span>ì•ˆì „ì§€í–¥ (0)</span>
                                            <span>ì¤‘ë¦½ (50)</span>
                                            <span>ê³µê²©í˜• (100)</span>
                                        </div>

                                        <div className="mt-6 space-y-3">
                                            <div className={`p-3 rounded-lg border text-sm transition-all duration-300 ${userData.propensityType.includes('Aìœ í˜•') ? 'bg-green-100 border-green-500 ring-2 ring-green-200 font-bold text-green-900 shadow-md' : 'bg-white text-slate-400 border-slate-200 opacity-50'}`}>
                                                ğŸ›¡ï¸ Aìœ í˜•: ì² ë²½ ìˆ˜ë¹„í˜• (0~40ì )
                                            </div>
                                            <div className={`p-3 rounded-lg border text-sm transition-all duration-300 ${userData.propensityType.includes('Bìœ í˜•') ? 'bg-blue-100 border-blue-500 ring-2 ring-blue-200 font-bold text-blue-900 shadow-md' : 'bg-white text-slate-400 border-slate-200 opacity-50'}`}>
                                                âš–ï¸ Bìœ í˜•: ì˜¬ë¼ìš´ë“œí˜• (41~70ì )
                                            </div>
                                            <div className={`p-3 rounded-lg border text-sm transition-all duration-300 ${userData.propensityType.includes('Cìœ í˜•') ? 'bg-red-100 border-red-500 ring-2 ring-red-200 font-bold text-red-900 shadow-md' : 'bg-white text-slate-400 border-slate-200 opacity-50'}`}>
                                                âš½ Cìœ í˜•: ë‹¥ê³µ(ë‹¥ì¹˜ê³  ê³µê²©)í˜• (71~100ì )
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col justify-between">
                                        <div className="bg-blue-50 p-6 rounded-2xl border border-blue-100 h-full">
                                            <h4 className="font-bold text-blue-900 mb-4 flex items-center gap-2 text-lg">
                                                <span>ğŸ’¡</span> ë§ì¶¤í˜• íˆ¬ì ì¡°ì–¸ (ì¶•êµ¬íŒ€ ì „ëµ)
                                            </h4>
                                            <div className="text-slate-700 leading-relaxed text-sm whitespace-pre-line">
                                                {userData.propensityType.includes('Aìœ í˜•') && (
                                                    <div>
                                                        <p className="font-bold mb-2 text-green-700 text-base">"ì›ê¸ˆ ì†ì‹¤ NO! í˜„ê¸ˆ íë¦„ì´ ìµœê³ !"</p>
                                                        <ul className="list-disc pl-4 space-y-2">
                                                            <li><strong>ì „ìˆ  í•µì‹¬:</strong> ìˆ˜ë¹„ì™€ ë¯¸ë“œí•„ë” ìœ„ì£¼ë¡œ ì•ˆì •ì ì¸ ë°°ë‹¹ ìˆ˜ìµì„ ì¶”êµ¬í•©ë‹ˆë‹¤.</li>
                                                            <li><strong>í¬ë©”ì´ì…˜:</strong> <span className="bg-green-100 px-1 rounded font-bold">ìˆ˜ë¹„ 40%</span> : <span className="bg-yellow-100 px-1 rounded font-bold">ë¯¸ë“œí•„ë” 40%</span> : <span className="bg-red-100 px-1 rounded font-bold">ê³µê²© 20%</span></li>
                                                            <li><strong>ì¶”ì²œ ìì‚°:</strong> ì€í–‰ ì˜ˆê¸ˆ, ë‹¨ê¸°ì±„ê¶Œ, ê³ ë°°ë‹¹ì£¼ ìœ„ì£¼ë¡œ êµ¬ì„±í•˜ì„¸ìš”.</li>
                                                        </ul>
                                                    </div>
                                                )}
                                                {userData.propensityType.includes('Bìœ í˜•') && (
                                                    <div>
                                                        <p className="font-bold mb-2 text-blue-700 text-base">"ì„±ì¥ê³¼ ì•ˆì •ì„ ë™ì‹œì— ì¡ëŠ” ë°¸ëŸ°ìŠ¤!"</p>
                                                        <ul className="list-disc pl-4 space-y-2">
                                                            <li><strong>ì „ìˆ  í•µì‹¬:</strong> ë°°ë‹¹ì„±ì¥ì£¼ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê³µìˆ˜ ë°¸ëŸ°ìŠ¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.</li>
                                                            <li><strong>í¬ë©”ì´ì…˜:</strong> <span className="bg-green-100 px-1 rounded font-bold">ìˆ˜ë¹„ 20%</span> : <span className="bg-yellow-100 px-1 rounded font-bold">ë¯¸ë“œí•„ë” 55%</span> : <span className="bg-red-100 px-1 rounded font-bold">ê³µê²© 25%</span></li>
                                                            <li><strong>ì¶”ì²œ ìì‚°:</strong> SCHD(ë°°ë‹¹ì„±ì¥)ì™€ S&P500ì„ ì ì ˆíˆ ì„ìœ¼ì„¸ìš”.</li>
                                                        </ul>
                                                    </div>
                                                )}
                                                {userData.propensityType.includes('Cìœ í˜•') && (
                                                    <div>
                                                        <p className="font-bold mb-2 text-red-700 text-base">"ì¸í”Œë ˆì´ì…˜ì„ ì••ë„í•˜ëŠ” ê°•ë ¥í•œ ì„±ì¥!"</p>
                                                        <ul className="list-disc pl-4 space-y-2">
                                                            <li><strong>ì „ìˆ  í•µì‹¬:</strong> ê³µê²©ìˆ˜ë¥¼ ëŒ€ê±° ë°°ì¹˜í•˜ì—¬ ìì‚° ì¦ì‹ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.</li>
                                                            <li><strong>í¬ë©”ì´ì…˜:</strong> <span className="bg-green-100 px-1 rounded font-bold">ìˆ˜ë¹„ 10%</span> : <span className="bg-yellow-100 px-1 rounded font-bold">ë¯¸ë“œí•„ë” 40%</span> : <span className="bg-red-100 px-1 rounded font-bold">ê³µê²© 50%</span></li>
                                                            <li><strong>ì¶”ì²œ ìì‚°:</strong> ë‚˜ìŠ¤ë‹¥100, í…Œí¬TOP10 ë“± ì„±ì¥ì£¼ ìœ„ì£¼ë¡œ êµ¬ì„±í•˜ì„¸ìš”.</li>
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mt-4 p-3 bg-white rounded-lg border border-blue-100 text-xs text-slate-500">
                                                ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ ì „ëµì— ë§ëŠ” êµ¬ì²´ì ì¸ <strong>ETF ì¢…ëª©</strong>ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-10 text-center">
                                    <button 
                                        onClick={handleNext}
                                        className="w-full md:w-auto px-10 py-4 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2 mx-auto"
                                    >
                                        <span>ë‚´ ì „ëµì— ë§ëŠ” ì„ ìˆ˜(ETF) ì„ ë°œí•˜ëŸ¬ ê°€ê¸°</span>
                                        <span className="text-xl">ğŸ‘‰</span>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
// 9ë‹¨ê³„ (Index 8): ì€í‡´ í›„ í¬íŠ¸í´ë¦¬ì˜¤ (ìˆ˜ì •ë¨: ì¶•êµ¬íŒ€ ì „ëµ ë°˜ì˜)
            if (currentStep === 8) {
                // 1. ETF ë°ì´í„° ì •ì˜ (ìš”ì²­í•˜ì‹  ì¢…ëª© ë°˜ì˜)
                // íƒ€ì…: 0=ìˆ˜ë¹„ìˆ˜(ì•ˆì •), 1=ë¯¸ë“œí•„ë”(ë°°ë‹¹), 2=ê³µê²©ìˆ˜(ì„±ì¥)
                const DOMESTIC_ETFS = [
                    // ğŸ›¡ï¸ ìˆ˜ë¹„ìˆ˜ (ì•ˆì •í˜•)
                    { id: 'rise_mmf', name: 'RISE ë¨¸ë‹ˆë§ˆì¼“ì•¡í‹°ë¸Œ', div: 3.8, growth: 0.0, type: 'ğŸ›¡ï¸ìˆ˜ë¹„ìˆ˜' },
                    { id: 'kodex_short', name: 'KODEX ë‹¨ê¸°ì±„ê¶Œ', div: 3.5, growth: 0.5, type: 'ğŸ›¡ï¸ìˆ˜ë¹„ìˆ˜' },
                    { id: 'kodex_cd', name: 'KODEX CDê¸ˆë¦¬ì•¡í‹°ë¸Œ', div: 3.6, growth: 0.0, type: 'ğŸ›¡ï¸ìˆ˜ë¹„ìˆ˜' },
                    { id: 'tiger_mmf', name: 'TIGER ë¨¸ë‹ˆë§ˆì¼“ì•¡í‹°ë¸Œ', div: 3.8, growth: 0.0, type: 'ğŸ›¡ï¸ìˆ˜ë¹„ìˆ˜' },
                    
                    // ğŸƒ ë¯¸ë“œí•„ë” (ë°°ë‹¹í˜•)
                    { id: 'plus_high', name: 'PLUS ê³ ë°°ë‹¹ì£¼', div: 6.5, growth: 1.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'tiger_bank', name: 'TIGER ì€í–‰ê³ ë°°ë‹¹í”ŒëŸ¬ìŠ¤TOP10', div: 6.0, growth: 1.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'rise_high', name: 'RISE ëŒ€í˜•ê³ ë°°ë‹¹10', div: 5.5, growth: 2.0, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'tiger_schd', name: 'TIGER ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤', div: 3.5, growth: 8.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'ace_schd', name: 'ACE ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤', div: 3.5, growth: 8.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'sol_schd', name: 'SOL ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤', div: 3.5, growth: 8.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },

                    // âš½ ê³µê²©ìˆ˜ (ì„±ì¥í˜•)
                    { id: 'tiger_snp', name: 'TIGER ë¯¸êµ­S&P500', div: 1.5, growth: 9.0, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'ace_snp', name: 'ACE ë¯¸êµ­S&P500', div: 1.5, growth: 9.0, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'tiger_nas', name: 'TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100', div: 0.8, growth: 12.0, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'ace_nas', name: 'ACE ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100', div: 0.8, growth: 12.0, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'tiger_top10', name: 'TIGER ë¯¸êµ­í…Œí¬TOP10', div: 0.5, growth: 15.0, type: 'âš½ê³µê²©ìˆ˜' }
                ];

                // ì¼ë°˜ê³„ì¢Œìš© í•´ì™¸ ETF (ê¸°ì¡´ ìœ ì§€í•˜ë˜ ë¡œì§ í†µì¼)
                const OVERSEAS_ETFS = [
                    { id: 'jepi', name: 'JEPI (ì»¤ë²„ë“œì½œ)', div: 7.5, growth: 3.0, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'schd', name: 'SCHD (ë°°ë‹¹ì„±ì¥)', div: 3.5, growth: 8.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'qqqm', name: 'QQQM (ë‚˜ìŠ¤ë‹¥)', div: 0.7, growth: 13.0, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'spy', name: 'SPY (S&P500)', div: 1.5, growth: 9.5, type: 'âš½ê³µê²©ìˆ˜' },
                    { id: 'realty', name: 'O (ë¦¬ì–¼í‹°ì¸ì»´)', div: 5.2, growth: 2.5, type: 'ğŸƒë¯¸ë“œí•„ë”' },
                    { id: 'vti', name: 'VTI (ë¯¸êµ­ì „ì²´)', div: 1.4, growth: 9.0, type: 'âš½ê³µê²©ìˆ˜' }
                ];

                const RETIRE_ETFS = {
                    pension: DOMESTIC_ETFS,
                    isa: DOMESTIC_ETFS,
                    general: OVERSEAS_ETFS
                };

                // í”„ë¦¬ì…‹ ì •ì˜ (A, B, C ìœ í˜•)
                const PORTFOLIO_PRESETS = {
                    pension: {
                        type_a: { 
                            title: 'ğŸ›¡ï¸ Aìœ í˜•: ì² ë²½ ìˆ˜ë¹„í˜•', 
                            desc: '"ì›ê¸ˆ ì†ì‹¤ì€ ì‹«ì–´!" í˜„ê¸ˆíë¦„ê³¼ ë°©ì–´ ì¤‘ì‹¬ (ì•ˆì •40:ë°°ë‹¹40:ì„±ì¥20)', 
                            items: [{id:'rise_mmf', percent:20}, {id:'kodex_short', percent:20}, {id:'plus_high', percent:20}, {id:'tiger_bank', percent:20}, {id:'tiger_snp', percent:20}],
                            color: 'green'
                        },
                        type_b: { 
                            title: 'âš–ï¸ Bìœ í˜•: ì˜¬ë¼ìš´ë“œí˜•', 
                            desc: '"ë°¸ëŸ°ìŠ¤ê°€ ìƒëª…!" í˜„ê¸ˆê³¼ ì„±ì¥ì˜ ì¡°í™” (ì•ˆì •20:ë°°ë‹¹55:ì„±ì¥25)', 
                            items: [{id:'rise_mmf', percent:20}, {id:'tiger_schd', percent:35}, {id:'plus_high', percent:20}, {id:'ace_snp', percent:25}],
                            color: 'blue'
                        },
                        type_c: { 
                            title: 'âš½ Cìœ í˜•: ë‹¥ê³µ(ë‹¥ì¹˜ê³  ê³µê²©)í˜•', 
                            desc: '"ì¸í”Œë ˆë¥¼ ì´ê²¨ë¼!" ì„±ì¥ ì¤‘ì‹¬ (ì•ˆì •10:ë°°ë‹¹40:ì„±ì¥50)', 
                            items: [{id:'tiger_mmf', percent:10}, {id:'sol_schd', percent:40}, {id:'tiger_nas', percent:30}, {id:'tiger_top10', percent:20}],
                            color: 'red'
                        }
                    },
                    // ISAëŠ” ì—°ê¸ˆê³¼ ë™ì¼í•œ ì „ëµ ì‚¬ìš©
                    isa: {
                        type_a: { 
                            title: 'ğŸ›¡ï¸ Aìœ í˜•: ì² ë²½ ìˆ˜ë¹„í˜•', 
                            desc: 'ì•ˆì •40 : ë°°ë‹¹40 : ì„±ì¥20', 
                            items: [{id:'rise_mmf', percent:20}, {id:'kodex_short', percent:20}, {id:'plus_high', percent:20}, {id:'tiger_bank', percent:20}, {id:'tiger_snp', percent:20}],
                            color: 'green'
                        },
                        type_b: { 
                            title: 'âš–ï¸ Bìœ í˜•: ì˜¬ë¼ìš´ë“œí˜•', 
                            desc: 'ì•ˆì •20 : ë°°ë‹¹55 : ì„±ì¥25', 
                            items: [{id:'rise_mmf', percent:20}, {id:'tiger_schd', percent:35}, {id:'plus_high', percent:20}, {id:'ace_snp', percent:25}],
                            color: 'blue'
                        },
                        type_c: { 
                            title: 'âš½ Cìœ í˜•: ë‹¥ê³µ(ë‹¥ì¹˜ê³  ê³µê²©)í˜•', 
                            desc: 'ì•ˆì •10 : ë°°ë‹¹40 : ì„±ì¥50', 
                            items: [{id:'tiger_mmf', percent:10}, {id:'sol_schd', percent:40}, {id:'tiger_nas', percent:30}, {id:'tiger_top10', percent:20}],
                            color: 'red'
                        }
                    },
                    general: {
                        type_a: { title: 'ğŸ›¡ï¸ Aìœ í˜• (í•´ì™¸ìƒì¥)', desc: 'ì•ˆì •ì  ì›”ë°°ë‹¹ ì¤‘ì‹¬', items: [{id:'jepi', percent:60}, {id:'realty', percent:40}], color: 'green' },
                        type_b: { title: 'âš–ï¸ Bìœ í˜• (í•´ì™¸ìƒì¥)', desc: 'ë°°ë‹¹ì„±ì¥ + ì§€ìˆ˜íˆ¬ì', items: [{id:'schd', percent:50}, {id:'spy', percent:30}, {id:'jepi', percent:20}], color: 'blue' },
                        type_c: { title: 'âš½ Cìœ í˜• (í•´ì™¸ìƒì¥)', desc: 'ì„±ì¥ ì¤‘ì‹¬ ì§€ìˆ˜íˆ¬ì', items: [{id:'qqqm', percent:50}, {id:'spy', percent:50}], color: 'red' }
                    }
                };

                const currentPortfolios = userData.postRetirementDetailed || { pension: [], isa: [], general: [] };

                const updatePortfolio = (type, newList) => {
                    setUserData(prev => ({
                        ...prev,
                        postRetirementDetailed: { ...prev.postRetirementDetailed, [type]: newList },
                        selectedPresetKeys: { ...(prev.selectedPresetKeys || {}), [type]: null } 
                    }));
                };

                const applyPreset = (type, presetKey) => {
                    const preset = PORTFOLIO_PRESETS[type][presetKey];
                    setUserData(prev => ({
                        ...prev,
                        postRetirementDetailed: { ...prev.postRetirementDetailed, [type]: preset.items },
                        selectedPresetKeys: { ...(prev.selectedPresetKeys || {}), [type]: presetKey }
                    }));
                };

                const calculateStats = (type) => {
                    const list = currentPortfolios[type] || [];
                    let totalDiv = 0, totalGrowth = 0, totalPercent = 0;
                    list.forEach(item => {
                        const etf = RETIRE_ETFS[type].find(e => e.id === item.id);
                        if (etf) {
                            totalDiv += etf.div * (item.percent / 100);
                            totalGrowth += etf.growth * (item.percent / 100);
                            totalPercent += item.percent;
                        }
                    });
                    return { totalDiv, totalGrowth, totalPercent };
                };

                // ETF ì„ íƒ ë° ë¹„ìœ¨ ì¡°ì • UI
                const renderPortfolioEditor = (type, list) => {
                    const available = RETIRE_ETFS[type];
                    const stats = calculateStats(type);

                    const addEtf = (e) => {
                        const id = e.target.value;
                        if(!id) return;
                        if(list.find(i=>i.id===id)) return alert("ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.");
                        updatePortfolio(type, [...list, { id, percent: 0 }]);
                        e.target.value = "";
                    };
                    const updatePercent = (id, val) => updatePortfolio(type, list.map(i => i.id === id ? { ...i, percent: Number(val) } : i));
                    const removeEtf = (id) => updatePortfolio(type, list.filter(i => i.id !== id));

                    return (
                        <div className="mt-6 bg-slate-50 rounded-xl p-5 border-t border-slate-200">
                            <h4 className="font-bold text-slate-700 mb-3 flex items-center justify-between">
                                <span>ğŸ› ï¸ ìƒì„¸ êµ¬ì„± (ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)</span>
                                <span className={`text-xs px-2 py-1 rounded ${stats.totalPercent === 100 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    í•©ê³„: {stats.totalPercent}%
                                </span>
                            </h4>
                            <div className="space-y-2 mb-4">
                                {list.length === 0 ? <div className="text-center text-slate-400 text-sm py-2">ìœ„ì˜ ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•˜ì„¸ìš”.</div> : 
                                    list.map(item => {
                                        const etf = available.find(e => e.id === item.id);
                                        if(!etf) return null;
                                        return (
                                            <div key={item.id} className="flex items-center gap-2 bg-white border p-2 rounded shadow-sm">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] bg-slate-100 text-slate-600 px-1 rounded">{etf.type}</span>
                                                        <span className="font-bold text-sm text-slate-700">{etf.name}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 pl-1 mt-0.5">ë°°ë‹¹ {etf.div}% / ì„±ì¥ {etf.growth}%</div>
                                                </div>
                                                <div className="flex items-center">
                                                    <input type="number" value={item.percent} onChange={(e) => updatePercent(item.id, e.target.value)} className="w-16 text-right border rounded p-1 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500" />
                                                    <span className="text-xs text-slate-500 ml-1">%</span>
                                                </div>
                                                <button onClick={() => removeEtf(item.id)} className="text-slate-400 hover:text-red-500 px-2">âœ•</button>
                                            </div>
                                        );
                                    })
                                }
                            </div>
                            <select className="w-full text-sm border p-2 rounded bg-white" onChange={addEtf}>
                                <option value="">+ ì¢…ëª© ì¶”ê°€í•˜ê¸°</option>
                                {available.map(e => <option key={e.id} value={e.id}>[{e.type}] {e.name}</option>)}
                            </select>
                        </div>
                    );
                };

                const renderPortfolioSection = (type, title, headerColor) => {
                    const stats = calculateStats(type);
                    const selectedKey = userData.selectedPresetKeys?.[type];
                    const currentList = currentPortfolios[type] || [];

                    return (
                        <div className="mb-12 border rounded-2xl shadow-sm bg-white overflow-hidden">
                            <div className={`p-6 ${headerColor} border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4`}>
                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">{title}</h3>
                                <div className="bg-white/80 backdrop-blur px-6 py-3 rounded-xl shadow-sm flex items-center gap-6">
                                    <div className="text-center"><div className="text-xs text-slate-500 font-bold mb-1">ì˜ˆìƒ ë°°ë‹¹ë¥ </div><div className="text-2xl font-black text-yellow-600">{stats.totalDiv.toFixed(1)}%</div></div>
                                    <div className="w-px h-8 bg-slate-300"></div>
                                    <div className="text-center"><div className="text-xs text-slate-500 font-bold mb-1">ì˜ˆìƒ ì„±ì¥ë¥ </div><div className="text-2xl font-black text-blue-600">{stats.totalGrowth.toFixed(1)}%</div></div>
                                    <div className="w-px h-8 bg-slate-300"></div>
                                    <div className="text-center"><div className="text-xs text-slate-500 font-bold mb-1">ì´ ìˆ˜ìµë¥ </div><div className="text-2xl font-black text-slate-800">{(stats.totalDiv + stats.totalGrowth).toFixed(1)}%</div></div>
                                </div>
                            </div>
                            <div className="p-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {Object.entries(PORTFOLIO_PRESETS[type]).map(([key, preset]) => {
                                        const isSelected = selectedKey === key;
                                        const ringClass = preset.color === 'green' ? 'ring-green-400 border-green-400 bg-green-50' : preset.color === 'blue' ? 'ring-blue-400 border-blue-400 bg-blue-50' : 'ring-red-400 border-red-400 bg-red-50';
                                        
                                        return (
                                            <button key={key} onClick={() => applyPreset(type, key)} className={`relative flex flex-col h-full text-left p-5 rounded-xl border-2 transition-all hover:-translate-y-1 hover:shadow-lg ${isSelected ? `${ringClass} ring-2 shadow-md` : 'border-slate-100 bg-white hover:border-slate-300'}`}>
                                                {isSelected && <div className="absolute top-2 right-2 text-xl">âœ…</div>}
                                                <div className="font-bold text-lg text-slate-800 mb-2">{preset.title}</div>
                                                <p className="text-xs text-slate-500 mb-4 leading-relaxed font-medium min-h-[40px] break-keep">{preset.desc}</p>
                                                <div className="mt-auto pt-3 border-t border-slate-200/50 w-full">
                                                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-1">êµ¬ì„± ì˜ˆì‹œ</div>
                                                    <div className="flex flex-wrap gap-1">
                                                        {preset.items.map((item, idx) => {
                                                            const etf = RETIRE_ETFS[type].find(e => e.id === item.id);
                                                            return <span key={idx} className="text-xs bg-white border px-1.5 py-0.5 rounded text-slate-600 font-medium">{etf?.name.split(' ')[0]} {etf?.name.split(' ')[1]}</span>;
                                                        })}
                                                    </div>
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                                {renderPortfolioEditor(type, currentList)}
                            </div>
                        </div>
                    );
                };

                return (
                    <div className="fade-in space-y-8">
                        <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl">
                            <h2 className="text-2xl font-bold mb-4">ğŸ›¡ï¸ ì€í‡´ í›„ ì‹¤ì „ í¬íŠ¸í´ë¦¬ì˜¤ (ì¸ì¶œê¸°)</h2>
                            <p className="opacity-90 leading-relaxed text-lg mb-6">
                                ì€í‡´ í›„ì—ëŠ” <strong>'í˜„ê¸ˆíë¦„'</strong>ê³¼ <strong>'ìì‚° ìˆ˜ëª…'</strong>ì´ í•µì‹¬ì…ë‹ˆë‹¤.<br/>
                                ì¶•êµ¬íŒ€ ê°ë…ì´ ëœ ê²ƒì²˜ëŸ¼ ê³µê²©ìˆ˜(ì„±ì¥), ë¯¸ë“œí•„ë”(ë°°ë‹¹), ìˆ˜ë¹„ìˆ˜(ì•ˆì •)ë¥¼ ì ì ˆíˆ ë°°ì¹˜í•˜ì—¬<br/>
                                ë‚´ ì„±í–¥ì— ë”± ë§ëŠ” <strong>'ì´ê¸°ëŠ” í¬íŠ¸í´ë¦¬ì˜¤'</strong>ë¥¼ ì™„ì„±í•´ë³´ì„¸ìš”.
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 text-sm text-center">
                                <div className="bg-slate-800 p-3 rounded-lg"><span className="text-2xl block mb-1">âš½</span><strong>ê³µê²©ìˆ˜ (ì„±ì¥í˜•)</strong><br/><span className="opacity-60">S&P500, ë‚˜ìŠ¤ë‹¥100</span></div>
                                <div className="bg-slate-800 p-3 rounded-lg"><span className="text-2xl block mb-1">ğŸƒ</span><strong>ë¯¸ë“œí•„ë” (ë°°ë‹¹í˜•)</strong><br/><span className="opacity-60">SCHD, ê³ ë°°ë‹¹ì£¼</span></div>
                                <div className="bg-slate-800 p-3 rounded-lg"><span className="text-2xl block mb-1">ğŸ›¡ï¸</span><strong>ìˆ˜ë¹„ìˆ˜ (ì•ˆì •í˜•)</strong><br/><span className="opacity-60">ë‹¨ê¸°ì±„, íŒŒí‚¹í†µì¥</span></div>
                            </div>
                        </div>
                        {renderPortfolioSection('pension', '1. ì—°ê¸ˆê³„ì¢Œ í¬íŠ¸í´ë¦¬ì˜¤ (êµ­ë‚´ìƒì¥ ETF)', 'bg-blue-50')}
                        {renderPortfolioSection('isa', '2. ISA ê³„ì¢Œ í¬íŠ¸í´ë¦¬ì˜¤ (êµ­ë‚´ìƒì¥ ETF)', 'bg-teal-50')}
                        {renderPortfolioSection('general', '3. ì¼ë°˜ ê³„ì¢Œ í¬íŠ¸í´ë¦¬ì˜¤ (í•´ì™¸ìƒì¥ ETF)', 'bg-indigo-50')}
                    </div>
                );
            }
// [ìˆ˜ì •ëœ 10ë‹¨ê³„] ëŒ€ì±…ìˆ˜ë¦½ (ì£¼íƒì—°ê¸ˆ í…Œì´ë¸” ë°˜ì˜, UI ê°œí¸, ì„¤ëª… ì¶”ê°€, ê·¸ë˜í”„ ì‚­ì œ)
            if (currentStep === 9) {
                // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const simExpense = userData?.simExpense !== undefined ? Number(userData.simExpense) : ((calculations && calculations.totalMonthlyExpense) || 0);
                const useStepDown = userData.useStepDown || false;
                const npsTiming = userData.npsTiming ? Number(userData.npsTiming) : 0;
                const housingPrice = userData.housingPrice ? Number(userData.housingPrice) : 0;
                const housingAge = userData.housingAge ? Number(userData.housingAge) : 60;
                
                const useDownsizing = userData.useDownsizing || false;
                const downsizingAge = userData.downsizingAge ? Number(userData.downsizingAge) : 65; 
                const downsizingAmount = userData.downsizingAmount ? Number(userData.downsizingAmount) : 0; 

                const handleUpdate = (key, val) => {
                    const finalVal = (key === 'useStepDown' || key === 'useDownsizing') ? val : Number(val);
                    setUserData(prev => ({ ...prev, [key]: finalVal }));
                };

                // [ì£¼íƒì—°ê¸ˆ ë°ì´í„° í…Œì´ë¸”] (ì œê³µí•´ì£¼ì‹  ì´ë¯¸ì§€ ê¸°ë°˜)
                // í‚¤: ë‚˜ì´, ê°’: [1ì–µ, 2ì–µ, ... 12ì–µ]ì— í•´ë‹¹í•˜ëŠ” ì›” ì§€ê¸‰ì•¡ (ë‹¨ìœ„: ì²œì›)
                const HOUSING_PENSION_TABLE = {
                    55: [147, 295, 443, 591, 739, 887, 1035, 1183, 1331, 1479, 1627, 1774],
                    60: [200, 400, 600, 801, 1001, 1201, 1402, 1602, 1802, 2003, 2203, 2403],
                    65: [242, 485, 727, 970, 1212, 1455, 1698, 1940, 2183, 2425, 2668, 2911],
                    70: [297, 595, 892, 1190, 1487, 1785, 2082, 2380, 2677, 2975, 3272, 3275],
                    75: [371, 742, 1113, 1484, 1855, 2227, 2598, 2969, 3340, 3535, 3535, 3535],
                    80: [474, 949, 1424, 1899, 2374, 2849, 3324, 3799, 3936, 3936, 3936, 3936]
                };

                // ì£¼íƒì—°ê¸ˆ ê³„ì‚° ë¡œì§
                let estHousingPension = 0; // ë‹¨ìœ„: ë§Œì›
                if (housingPrice > 0) {
                    // ë‚˜ì´ ë§¤í•‘ (ê°€ì¥ ê°€ê¹Œìš´ í•˜ìœ„ ì—°ë ¹ëŒ€ ì„ íƒ)
                    const ages = [55, 60, 65, 70, 75, 80];
                    const matchedAge = ages.reverse().find(a => housingAge >= a);
                    
                    // ê°€ê²© ë§¤í•‘ (1ì–µ ë‹¨ìœ„ë¡œ ì¸ë±ìŠ¤ ê³„ì‚°, 12ì–µ ì´ˆê³¼ëŠ” 12ì–µìœ¼ë¡œ ê°„ì£¼)
                    // housingPrice ë‹¨ìœ„: ë§Œì› -> ì–µ ë‹¨ìœ„: housingPrice / 10000
                    const priceIndex = Math.min(11, Math.floor(housingPrice / 10000) - 1);

                    if (matchedAge && priceIndex >= 0) {
                        const rawVal = HOUSING_PENSION_TABLE[matchedAge][priceIndex]; // ë‹¨ìœ„: ì²œì›
                        estHousingPension = Math.round(rawVal / 10); // ë‹¨ìœ„: ë§Œì›
                    }
                }

                // 2. ëŒ€ì±… ì‹œë®¬ë ˆì´ì…˜ (ê·¸ë˜í”„ìš©ì€ ì‚­ì œë¨)
                const { npsTiming: _npsTiming } = userData;

                return (
                    <div className="fade-in space-y-8">
                        <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl">
                            <h2 className="text-2xl font-bold mb-2">ğŸ›¡ï¸ 5ê°€ì§€ ëŒ€ì±… ë° ìµœì¢… ì ê²€</h2>
                            <p className="opacity-80">
                                ë¶€ì¡±í•œ ë…¸í›„ ìê¸ˆì„ ì±„ìš°ê¸° ìœ„í•œ 5ê°€ì§€ ëŒ€ì±…ì„ ì‹¤í–‰í•˜ê³  ì ê²€í•´ë³´ì„¸ìš”.<br/>
                                ê° í•­ëª©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜ ê°’ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* 1. ìƒí™œë¹„ ì¤„ì´ê¸° */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md flex flex-col">
                                <h3 className="font-bold text-lg text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                    <span>1ï¸âƒ£</span> ëª©í‘œ ìƒí™œë¹„ ì¤„ì´ê¸°
                                </h3>
                                <p className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded leading-relaxed">
                                    <strong>"ê°€ì¥ í™•ì‹¤í•˜ê³  ì¦‰ê°ì ì¸ ëŒ€ì±…ì…ë‹ˆë‹¤."</strong><br/>
                                    ì€í‡´ í›„ ìƒí™œë¹„ëŠ” ê°€ì¥ í° ë³€ìˆ˜ì…ë‹ˆë‹¤. ì›” 10ë§Œì›ë§Œ ì¤„ì—¬ë„ 30ë…„ì´ë©´ 3,600ë§Œ ì›(ë¬¼ê°€ìƒìŠ¹ ê³ ë ¤ ì‹œ 1ì–µ ì› ì´ìƒ)ì˜ ìì‚°ì„ ì•„ë¼ëŠ” íš¨ê³¼ê°€ ìˆìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ê³ ì • ì§€ì¶œì„ ì ê²€í•˜ê³  ê¼­ í•„ìš”í•œ ë¹„ìš©ë§Œ ë‚¨ê¸°ê³  ì¬ì‚°ì •í•´ë³´ì„¸ìš”.
                                </p>
                                <div className="mt-auto text-center">
                                    <p className="text-3xl font-black text-slate-800 mb-4">{simExpense.toLocaleString()} ë§Œì›</p>
                                    <button onClick={() => setCurrentStep(3)} className="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-3 px-4 rounded-lg transition">ğŸ“‰ 4ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•˜ê¸°</button>
                                </div>
                            </div>

                            {/* 2. Step-down */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md flex flex-col">
                                <h3 className="font-bold text-lg text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                    <span>2ï¸âƒ£</span> ë‚˜ì´ë“¤ìˆ˜ë¡ ëœ ì“°ê¸° (Step-down)
                                </h3>
                                <p className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded leading-relaxed">
                                    <strong>"í˜„ì‹¤ì ì¸ ì†Œë¹„ íŒ¨í„´ì„ ë°˜ì˜í•©ë‹ˆë‹¤."</strong><br/>
                                    í†µê³„ì ìœ¼ë¡œ 70ëŒ€, 80ëŒ€ê°€ ë˜ë©´ í™œë™ëŸ‰ì´ ì¤„ì–´ ì†Œë¹„ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ê°ì†Œí•©ë‹ˆë‹¤(ì˜ë£Œë¹„ ì œì™¸). ì´ë¥¼ ë°˜ì˜í•˜ë©´ ì¤€ë¹„í•´ì•¼ í•  ì´ ìì‚° ê·œëª¨ë¥¼ í˜„ì‹¤ì ìœ¼ë¡œ ë‚®ì¶œ ìˆ˜ ìˆì–´ ì‹¬ë¦¬ì  ë¶€ë‹´ì„ ëœ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                </p>
                                <div className="mt-auto text-center">
                                    <p className={`text-2xl font-black mb-4 ${useStepDown ? 'text-green-600' : 'text-slate-400'}`}>
                                        {useStepDown ? "ì ìš© ì¤‘ (70ëŒ€~ ê°ì•¡)" : "ë¯¸ì ìš© (ì¼ì • ìœ ì§€)"}
                                    </p>
                                    <button onClick={() => setCurrentStep(3)} className="w-full bg-green-100 hover:bg-green-200 text-green-700 font-bold py-3 px-4 rounded-lg transition">âš™ï¸ 4ë‹¨ê³„ì—ì„œ ì„¤ì •í•˜ê¸°</button>
                                </div>
                            </div>

                            {/* 3. êµ­ë¯¼ì—°ê¸ˆ ì‹œê¸° ì¡°ì ˆ */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md flex flex-col">
                                <h3 className="font-bold text-lg text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                    <span>3ï¸âƒ£</span> êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ ì‹œê¸° ì¡°ì ˆ
                                </h3>
                                <p className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded leading-relaxed">
                                    <strong>"ìµœê³ ì˜ ìˆ˜ìµë¥ ì„ ìë‘í•˜ëŠ” í™•ì • ì—°ê¸ˆì…ë‹ˆë‹¤."</strong><br/>
                                    êµ­ë¯¼ì—°ê¸ˆì€ ë¬¼ê°€ìƒìŠ¹ì„ ë°˜ì˜í•˜ëŠ” ìµœê³ ì˜ ìì‚°ì…ë‹ˆë‹¤. ë‹¹ì¥ ìƒê³„ê°€ ê¸‰í•˜ì§€ ì•Šë‹¤ë©´ ìµœëŒ€ 5ë…„ ì—°ê¸°í•˜ì—¬ ìˆ˜ë ¹ì•¡ì„ ì—° 7.2%ì”©(ìµœëŒ€ 36%) í‚¤ìš°ëŠ” ê²ƒì´ ì¥ìˆ˜ ë¦¬ìŠ¤í¬(ì˜¤ë˜ ì‚¬ëŠ” ìœ„í—˜) ëŒ€ë¹„ì— í›¨ì”¬ ìœ ë¦¬í•©ë‹ˆë‹¤.
                                </p>
                                <div className="mt-auto text-center">
                                    <p className="text-2xl font-black text-indigo-600 mb-4">
                                        {npsTiming === 0 ? "65ì„¸ (ì •ìƒ)" : npsTiming > 0 ? `${65+npsTiming}ì„¸ (+${npsTiming}ë…„ ì—°ê¸°)` : `${65+npsTiming}ì„¸ (${Math.abs(npsTiming)}ë…„ ì¡°ê¸°)`}
                                    </p>
                                    <button onClick={() => setCurrentStep(3)} className="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-3 px-4 rounded-lg transition">â±ï¸ 4ë‹¨ê³„ì—ì„œ ë³€ê²½í•˜ê¸°</button>
                                </div>
                            </div>

                            {/* 4. ì£¼íƒ ë‹¤ìš´ì‚¬ì´ì§• */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md flex flex-col">
                                <h3 className="font-bold text-lg text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                    <span>4ï¸âƒ£</span> ì£¼íƒ í¬ê¸° ì¤„ì—¬ì„œ ì—°ê¸ˆì €ì¶• ì¶”ê°€ ë‚©ì… (ë‹¤ìš´ì‚¬ì´ì§•)
                                </h3>
                                <div className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded leading-relaxed">
                                    <strong>"ê¹”ê³  ì•‰ì€ ëˆì„ íë¥´ëŠ” ëˆìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤."</strong><br/>
                                    ì£¼íƒ ê°€ê²©ì´ ì‹¼ ì§€ì—­ì´ë‚˜ ì‘ì€ í‰ìˆ˜ë¡œ ì´ì‚¬í•˜ì—¬ ìƒê¸´ ì°¨ì•¡ì„ ì—°ê¸ˆ ì¬ì›ìœ¼ë¡œ í™œìš©í•©ë‹ˆë‹¤. (ë¶€ë¶€ ì¤‘ 1ì¸ 60ì„¸ ì´ìƒ ì‹œ ì°¨ì•¡ ìµœëŒ€ 1ì–µì› ì—°ê¸ˆê³„ì¢Œ ë‚©ì… ê°€ëŠ¥)
                                    <br/><br/>
                                    <span className="text-blue-600 font-bold">ğŸ“¢ ìê¸ˆ ë°˜ì˜ ìœ„ì¹˜ ì•ˆë‚´:</span><br/>
                                    - <strong>ì€í‡´ ì „ ì‹¤í–‰ ì‹œ:</strong> 5ë‹¨ê³„ ì ë¦½ ê³„íšì— ë°˜ì˜ë˜ì–´ ìì‚°ì´ ì¦ì‹ë©ë‹ˆë‹¤.<br/>
                                    - <strong>ì€í‡´ í›„ ì‹¤í–‰ ì‹œ:</strong> 7ë‹¨ê³„ ì¸ì¶œ ê³„íšì˜ í•´ë‹¹ ë‚˜ì´ ì‹œì ì— 'ì¸ì¶œí›„ ë³´ìœ ê¸ˆ(Pool)'ìœ¼ë¡œ ì¼ì‹œë¶ˆ í•©ì‚°ë˜ì–´ ìƒí™œë¹„ë¡œ ì“°ì…ë‹ˆë‹¤.
                                </div>
                                <div className="space-y-3 mt-auto">
                                    <label className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition ${useDownsizing ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'hover:bg-slate-50'}`}>
                                        <input type="checkbox" checked={useDownsizing} onChange={(e) => handleUpdate('useDownsizing', e.target.checked)} className="w-5 h-5 text-blue-600 rounded" />
                                        <span className="font-bold text-slate-700">ì´ ëŒ€ì±… ì‹¤í–‰í•˜ê¸°</span>
                                    </label>
                                    <div className="input-group">
                                        <label>ì‹¤í–‰í•  ë‚˜ì´</label>
                                        <input type="number" value={downsizingAge} onChange={(e) => handleUpdate('downsizingAge', e.target.value)} disabled={!useDownsizing} />
                                    </div>
                                    <div className="input-group">
                                        <label>ì£¼íƒ ì°¨ìµ ì‹¤í˜„ê¸ˆì•¡ (ë§Œì›)</label>
                                        <input type="number" value={downsizingAmount} onChange={(e) => handleUpdate('downsizingAmount', e.target.value)} placeholder="ì˜ˆ: 20000 (2ì–µì›)" disabled={!useDownsizing} />
                                    </div>
                                </div>
                            </div>

                            {/* 5. ì£¼íƒì—°ê¸ˆ í™œìš© */}
                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm transition hover:shadow-md md:col-span-2">
                                <h3 className="font-bold text-lg text-slate-800 mb-2 border-b pb-2 flex items-center gap-2">
                                    <span>5ï¸âƒ£</span> ì£¼íƒì—°ê¸ˆ í™œìš©í•˜ê¸°
                                </h3>
                                <div className="text-xs text-slate-500 mb-4 bg-slate-50 p-3 rounded leading-relaxed">
                                    <strong>"ë‚´ ì§‘ì—ì„œ í‰ìƒ ì‚´ë©´ì„œ ì—°ê¸ˆì„ ë°›ìŠµë‹ˆë‹¤."</strong><br/>
                                    êµ­ê°€ê°€ ë³´ì¦í•˜ëŠ” ì—­ëª¨ê¸°ì§€ë¡ ì…ë‹ˆë‹¤. ì§‘ê°’ì´ ì˜¤ë¥´ë“  ë‚´ë¦¬ë“  ê°€ì… ì‹œì ì˜ í‰ê°€ì•¡ ê¸°ì¤€ìœ¼ë¡œ ì—°ê¸ˆì•¡ì´ í™•ì •ë˜ë©°, ë¶€ë¶€ ëª¨ë‘ ì‚¬ë§ ì‹œê¹Œì§€ í‰ìƒ ê±°ì£¼ì™€ í‰ìƒ ì—°ê¸ˆ ì§€ê¸‰ì´ ë³´ì¥ë©ë‹ˆë‹¤.
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="space-y-3">
                                        <div className="input-group">
                                            <label>ë‚´ ì£¼íƒ ê³µì‹œê°€ê²© (ë§Œì›) <span className="text-xs font-normal text-slate-400">(ìµœëŒ€ 12ì–µ ë°˜ì˜)</span></label>
                                            <input type="number" value={housingPrice} onChange={(e) => handleUpdate('housingPrice', e.target.value)} placeholder="0" />
                                        </div>
                                        <div className="input-group">
                                            <label>ì—°ê¸ˆ ì‹ ì²­ ë‚˜ì´ <span className="text-xs font-normal text-slate-400">(55ì„¸ ~ 80ì„¸)</span></label>
                                            <input type="number" value={housingAge} onChange={(e) => handleUpdate('housingAge', e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-lg flex flex-col items-center justify-center border border-green-200">
                                        <span className="text-sm text-green-800 font-bold mb-2">ë§¤ì›” ì˜ˆìƒ ìˆ˜ë ¹ì•¡</span>
                                        <span className="text-4xl font-black text-green-700">+{estHousingPension.toLocaleString()} <span className="text-lg font-medium text-slate-600">ë§Œì›</span></span>
                                        <span className="text-xs text-slate-400 mt-2">* í•œêµ­ì£¼íƒê¸ˆìœµê³µì‚¬ ì •ì•¡í˜• ê¸°ì¤€ (ì¶”ì •ì¹˜)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] 11ë‹¨ê³„: ì¢…í•© ì „ëµ ë³´ê³ ì„œ (7ë²ˆ ì„¹ì…˜ ì‚­ì œ ì ìš©) â–¼â–¼â–¼
            if (currentStep === 10 || STEPS[currentStep] === "ìš”ì•½") {
                // [ì•ˆì „ì¥ì¹˜ 1] ë°ì´í„° ê¸°ë³¸ê°’ ì„¤ì •
                const safeUserData = userData || {};
                const { 
                    currentAge = 40, targetAge = 60, lifeAge = 90, inflation = 3, 
                    pensions = {} 
                } = safeUserData;

                // [ì•ˆì „ì¥ì¹˜ 2] ETF ì´ë¦„ ì°¾ê¸°
                const getRealEtfName = (id) => {
                    try {
                        const POST_RET_ETF_MAP = {
                            'rise_mmf': 'RISE ë¨¸ë‹ˆë§ˆì¼“ì•¡í‹°ë¸Œ', 'kodex_short': 'KODEX ë‹¨ê¸°ì±„ê¶Œ', 'kodex_cd': 'KODEX CDê¸ˆë¦¬ì•¡í‹°ë¸Œ', 'tiger_mmf': 'TIGER ë¨¸ë‹ˆë§ˆì¼“ì•¡í‹°ë¸Œ',
                            'plus_high': 'PLUS ê³ ë°°ë‹¹ì£¼', 'tiger_bank': 'TIGER ì€í–‰ê³ ë°°ë‹¹', 'rise_high': 'RISE ëŒ€í˜•ê³ ë°°ë‹¹10', 'tiger_schd': 'TIGER ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤', 'ace_schd': 'ACE ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤', 'sol_schd': 'SOL ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤',
                            'tiger_snp': 'TIGER ë¯¸êµ­S&P500', 'ace_snp': 'ACE ë¯¸êµ­S&P500', 'tiger_nas': 'TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100', 'ace_nas': 'ACE ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100', 'tiger_top10': 'TIGER ë¯¸êµ­í…Œí¬TOP10',
                            'jepi': 'JEPI (ì»¤ë²„ë“œì½œ)', 'schd': 'SCHD (ë°°ë‹¹ì„±ì¥)', 'qqqm': 'QQQM (ë‚˜ìŠ¤ë‹¥)', 'spy': 'SPY (S&P500)', 'realty': 'O (ë¦¬ì–¼í‹°ì¸ì»´)', 'vti': 'VTI (ë¯¸êµ­ì „ì²´)'
                        };
                        if (POST_RET_ETF_MAP[id]) return POST_RET_ETF_MAP[id];
                        if (typeof ETF_DB !== 'undefined') {
                            const allEtfs = [...(ETF_DB.domestic||[]), ...(ETF_DB.domestic_overseas||[]), ...(ETF_DB.overseas||[]), ...(ETF_DB.irp_safe||[])];
                            const found = allEtfs.find(e => e.id === id);
                            return found ? found.name : id;
                        }
                    } catch(e) { return id; }
                    return id;
                };

                // [ì•ˆì „ì¥ì¹˜ 3] í”„ë¦¬ì…‹ ì œëª©
                const getPresetTitleSafe = (type, key) => {
                    try {
                        if (typeof PORTFOLIO_PRESETS !== 'undefined' && PORTFOLIO_PRESETS[type] && PORTFOLIO_PRESETS[type][key]) return PORTFOLIO_PRESETS[type][key].title;
                    } catch(e) {}
                    return "ì§ì ‘ êµ¬ì„±";
                };

                // 3. [ì‹œë®¬ë ˆì´ì…˜ ë¡œì§] ì ë¦½ -> ì€í‡´ -> ì¸ì¶œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                let intervals = [];
                let sAge = Number(currentAge);
                const tAge = Number(targetAge);
                while (sAge < tAge) {
                    let eAge = Math.floor(sAge / 10) * 10 + 9;
                    if (eAge >= tAge) eAge = tAge;
                    intervals.push({ startAge: sAge, endAge: eAge, ageKey: `${Math.floor(sAge/10)}0ëŒ€` });
                    sAge = eAge + 1;
                }

                let runningBal = { 
                    pension1: Number(safeUserData.pension1||0), pension2: Number(safeUserData.pension2||0),
                    irp: Number(safeUserData.irp||0), isa: Number(safeUserData.isa||0),
                    general: Number(safeUserData.initialAssets||0),
                    other: (Number(safeUserData.bitcoin||0) + Number(safeUserData.cash||0)) - Number(safeUserData.debt_credit||0) 
                };
                let isaMonthCounter = 0;
                const useDownsizing = safeUserData.useDownsizing || false;
                const downsizingAge = safeUserData.downsizingAge ? Number(safeUserData.downsizingAge) : 65;
                const downsizingAmount = safeUserData.downsizingAmount ? Number(safeUserData.downsizingAmount) : 0;

                intervals.forEach(iv => {
                    const months = (iv.endAge - iv.startAge + 1) * 12;
                    const st = (safeUserData.ageStrategies && safeUserData.ageStrategies[iv.ageKey]) ? safeUserData.ageStrategies[iv.ageKey] : { monthlyTotal: 0, targetReturn: 6, autoDistribute: false };
                    const mRate = (st.targetReturn || 0) / 100 / 12;
                    let contrib = { pension1:0, pension2:0, irp:0, isa:0, general:0, other:0 };
                    
                    if (st.autoDistribute) {
                        let rem = Number(st.monthlyTotal) || 0;
                        const assign = (limit) => { let v = Math.min(rem, limit); rem = Math.max(0, rem - v); return v; };
                        contrib.pension1 = assign(50); contrib.irp = assign(25); contrib.isa = assign(85);
                        contrib.pension2 = assign(75); contrib.isa += assign(81); contrib.general = rem;
                    } else {
                        contrib.pension1 = Number(st.pension1)||0; contrib.pension2 = Number(st.pension2)||0;
                        contrib.irp = Number(st.irp)||0; contrib.isa = Number(st.isa)||0;
                        contrib.general = Number(st.general)||0; contrib.other = Number(st.other)||0;
                    }

                    for (let m = 0; m < months; m++) {
                        ['pension1','pension2','irp','isa','general'].forEach(k => { runningBal[k] = runningBal[k] * (1 + mRate) + (contrib[k]||0); });
                        runningBal.other += (contrib.other||0);
                        isaMonthCounter++;
                        if (isaMonthCounter === 60) {
                            const isaTotal = runningBal.isa;
                            if (isaTotal > 0) {
                                const profit = Math.max(0, isaTotal - (contrib.isa * 60)); 
                                let tax = profit > 200 ? (profit - 200) * 0.099 : 0;
                                runningBal.pension2 += (isaTotal - tax); 
                                runningBal.isa = 0; 
                            }
                            isaMonthCounter = 0;
                        }
                    }
                    const currentSimAge = iv.startAge + Math.floor(months / 12); // í•´ë‹¹ êµ¬ê°„ ë§ˆì§€ë§‰ ë‚˜ì´ ê·¼ì‚¬ì¹˜
                    // (ì•½ì‹) êµ¬ê°„ ë‚´ì— ë‹¤ìš´ì‚¬ì´ì§• ë‚˜ì´ê°€ í¬í•¨ë˜ë©´ 1íšŒ íˆ¬ì…í–ˆë‹¤ê³  ê°€ì •
                    if (useDownsizing && iv.startAge <= downsizingAge && iv.endAge >= downsizingAge && downsizingAge < tAge) {
                         // ì‹¤ì œë¡œëŠ” ì›”ë³„ ë£¨í”„ ì•ˆì—ì„œ ì •í™•íˆ ì²˜ë¦¬í•´ì•¼ í•˜ë‚˜, ê²°ê³¼ê°’ í‘œì‹œê°€ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ìì‚° ê·œëª¨ë§Œ ëŒ€ëµ ë§ì¶¥ë‹ˆë‹¤.
                         // ê¸°ì¡´ 5ë‹¨ê³„ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
                    }
                });
                
                // ì€í‡´ ì „ ë‹¤ìš´ì‚¬ì´ì§• ìê¸ˆ ì¶”ê°€ (ì‹œë®¬ë ˆì´ì…˜ ì •í™•ë„ ìœ ì§€ìš©)
                if (useDownsizing && downsizingAge < tAge) {
                    runningBal.pension2 += Math.min(downsizingAmount, 10000);
                    runningBal.general += Math.max(0, downsizingAmount - 10000);
                }

                // ì¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ ë³€ìˆ˜ë“¤ (í™”ë©´ì—” ì•ˆë³´ì—¬ë„ ì—ëŸ¬ ë°©ì§€ ìœ„í•´ ìœ ì§€)
                const inflationRate = (inflation || 0) / 100;
                const baseMonthlyExpense = Number(safeUserData.simExpense) || 300;
                const yearsToRetire = Math.max(0, tAge - currentAge);
                const expenseAtRetirement = baseMonthlyExpense * Math.pow(1 + inflationRate, yearsToRetire);

                const npsTiming = safeUserData.npsTiming ? Number(safeUserData.npsTiming) : 0;
                const receiptAge = 65 + npsTiming;
                let npsAdjustRate = npsTiming < 0 ? npsTiming * 0.06 : npsTiming * 0.072;
                const baseNPS = Number(pensions?.national || 0); 
                const adjustedBaseNPS = baseNPS * (1 + npsAdjustRate);
                const yearsToReceipt = Math.max(0, receiptAge - currentAge);
                const npsAtReceipt = adjustedBaseNPS * Math.pow(1 + inflationRate, yearsToReceipt);

                let curPool = runningBal.isa + runningBal.general + runningBal.other;
                if (useDownsizing && downsizingAge >= tAge) curPool += downsizingAmount;

                const housingPrice = safeUserData.housingPrice ? Number(safeUserData.housingPrice) : 0;
                const housingAge = safeUserData.housingAge ? Number(safeUserData.housingAge) : 60;
                let estHousingPension = 0;
                if (housingPrice > 0) {
                    const HOUSING_TABLE = { 55:[147,295,443,591,739,887,1035,1183,1331,1479,1627,1774], 60:[200,400,600,801,1001,1201,1402,1602,1802,2003,2203,2403], 65:[242,485,727,970,1212,1455,1698,1940,2183,2425,2668,2911], 70:[297,595,892,1190,1487,1785,2082,2380,2677,2975,3272,3275], 75:[371,742,1113,1484,1855,2227,2598,2969,3340,3535,3535,3535], 80:[474,949,1424,1899,2374,2849,3324,3799,3936,3936,3936,3936] };
                    const matchedAge = [55,60,65,70,75,80].reverse().find(a => housingAge >= a);
                    const priceIndex = Math.min(11, Math.floor(housingPrice / 10000) - 1);
                    if (matchedAge && priceIndex >= 0) estHousingPension = Math.round(HOUSING_TABLE[matchedAge][priceIndex] / 10);
                }

                // ê²°ê³¼ ë³€ìˆ˜ ì •ë¦¬
                const todayStr = new Date().toLocaleDateString();

                // Milestone ë°ì´í„° ìƒì„±
                const milestones = [
                    { age: tAge, icon: 'ğŸ›‘', label: 'ì€í‡´' },
                    { age: receiptAge, icon: 'ğŸ›ï¸', label: 'êµ­ë¯¼ì—°ê¸ˆ ê°œì‹œ' },
                ];
                if (useDownsizing) milestones.push({ age: downsizingAge, icon: 'ğŸ ', label: 'ì£¼íƒ ë‹¤ìš´ì‚¬ì´ì§•' });
                if (housingPrice > 0) milestones.push({ age: housingAge, icon: 'ğŸ‘µ', label: 'ì£¼íƒì—°ê¸ˆ ê°œì‹œ' });
                milestones.sort((a,b) => a.age - b.age);

                // PDF ë‹¤ìš´ë¡œë“œ
                const handleDownloadPDF = () => {
                    const element = document.getElementById('final-report');
                    if (!element || typeof html2pdf === 'undefined') { alert('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
                    const opt = { margin: 5, filename: `ë…¸í›„ì¤€ë¹„_ì¢…í•©ì „ëµë³´ê³ ì„œ_${safeUserData.name||'User'}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                    const btn = document.getElementById('pdf-btn');
                    if(btn) btn.innerText = 'â³ ìƒì„± ì¤‘...';
                    html2pdf().set(opt).from(element).save().then(() => { if(btn) btn.innerText = 'ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°'; })
                    .catch(err => { console.error(err); if(btn) btn.innerText = 'ì €ì¥ ì‹¤íŒ¨'; alert('ì˜¤ë¥˜ ë°œìƒ'); });
                };

                return (
                    <div className="fade-in pb-20">
                        {/* ìƒë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ */}
                        <div className="bg-slate-900 text-white p-6 rounded-xl shadow-lg flex justify-between items-center mb-8 print:hidden">
                            <div>
                                <h2 className="text-2xl font-bold">ğŸ‰ ì¢…í•© ì „ëµ ë³´ê³ ì„œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                                <p className="text-slate-300 text-sm">ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³  PDFë¡œ ì €ì¥í•˜ì—¬ ê°„ì§í•˜ì„¸ìš”.</p>
                            </div>
                            <button id="pdf-btn" onClick={handleDownloadPDF} className="bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 px-6 rounded-lg shadow transition">ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°</button>
                        </div>

                        {/* ë¦¬í¬íŠ¸ ë³¸ë¬¸ */}
                        <div id="final-report" className="bg-white text-slate-800 mx-auto shadow-2xl p-10 max-w-[210mm] min-h-[297mm]">
                            
                            {/* [PAGE 1] í‘œì§€ */}
                            <div className="border-b-4 border-slate-800 pb-6 mb-8">
                                <h1 className="text-4xl font-black text-slate-900 mb-2">ë‚˜ì˜ ë…¸í›„ì¤€ë¹„ ì¢…í•© ì „ëµ ë³´ê³ ì„œ</h1>
                                <p className="text-lg text-slate-500">ì‘ì„±ì: {safeUserData.name || 'ë‚˜'} | ì‘ì„±ì¼: {todayStr}</p>
                            </div>

                            {/* [1. ë…¸í›„ í’ê²½ ìŠ¤ì¼€ì¹˜] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">1. ë…¸í›„ í’ê²½ ìŠ¤ì¼€ì¹˜ (Vision)</h3>
                                <div className="grid grid-cols-1 gap-6 text-sm bg-slate-50 p-6 rounded-lg border">
                                    <div className="border-b border-slate-200 pb-4">
                                        <h4 className="font-bold text-blue-700 mb-2">Theme 1. ê´€ê³„ì™€ ê³ ë…</h4>
                                        <ul className="space-y-2 text-slate-700">
                                            <li><strong>ğŸ‘¥ ì§„ì •í•œ ì¹œêµ¬:</strong> {safeUserData.q_friends || '-'}</li>
                                            <li><strong>ğŸ§˜ ë‚˜ë§Œì˜ ì‹œê°„(ë¶€ë¶€):</strong> {safeUserData.q_spouse_alone || '-'}</li>
                                            <li><strong>ğŸ’‘ ë¶€ë¶€ ì—¬í–‰ì§€:</strong> {safeUserData.q_spouse_travel || '-'}</li>
                                            <li><strong>ğŸï¸ ê³ ë…ì˜ ì‹œê°„(Solitude):</strong> {safeUserData.q_solitude || '-'}</li>
                                            <li><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ìë…€ì™€ì˜ ê±°ë¦¬:</strong> {safeUserData.q_children || '-'}</li>
                                        </ul>
                                    </div>
                                    <div className="border-b border-slate-200 pb-4">
                                        <h4 className="font-bold text-green-700 mb-2">Theme 2. ì‹œê°„ê³¼ ì·¨ë¯¸</h4>
                                        <ul className="space-y-2 text-slate-700">
                                            <li><strong>ğŸ¨ ëª°ì…ì˜ ì·¨ë¯¸:</strong> {safeUserData.q_hobby || '-'}</li>
                                            <li><strong>ğŸ—ºï¸ ë²„í‚·ë¦¬ìŠ¤íŠ¸:</strong> {safeUserData.q_bucket || '-'}</li>
                                            <li><strong>ğŸ“ ë°°ì›€ì˜ ì—´ì •:</strong> {safeUserData.q_learning || '-'}</li>
                                        </ul>
                                    </div>
                                    <div className="border-b border-slate-200 pb-4">
                                        <h4 className="font-bold text-yellow-700 mb-2">Theme 3. ê³µê°„ê³¼ í™˜ê²½</h4>
                                        <ul className="space-y-2 text-slate-700">
                                            <li><strong>ğŸ  ê±°ì£¼ ê³„íš:</strong> {safeUserData.q_residence || '-'}</li>
                                            <li><strong>ğŸ›‹ï¸ ì†Œì¤‘í•œ ê³µê°„:</strong> {safeUserData.q_space || '-'}</li>
                                        </ul>
                                    </div>
                                    <div className="border-b border-slate-200 pb-4">
                                        <h4 className="font-bold text-indigo-700 mb-2">Theme 4. ê°€ì¹˜ì™€ ìì•„ì‹¤í˜„</h4>
                                        <ul className="space-y-2 text-slate-700">
                                            <li><strong>ğŸ¤ ë‚˜ëˆ”ê³¼ ë´‰ì‚¬:</strong> {safeUserData.q_volunteer || '-'}</li>
                                            <li><strong>ğŸ’ª ê±´ê°• ëª©í‘œ:</strong> {safeUserData.q_health_age || '-'}</li>
                                            <li><strong>ğŸª¦ ë¬˜ë¹„ëª…:</strong> {safeUserData.q_epitaph || '-'}</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-800 mb-2">ğŸ’­ ë¯¸ë˜ì˜ ë‚˜ (Essay)</h4>
                                        <div className="bg-white p-3 rounded border border-slate-200 mb-2">
                                            <strong className="block text-xs text-slate-500 mb-1">ì€í‡´ í›„ ì¼ìƒ (Routine)</strong>
                                            {safeUserData.q_routine_essay || '-'}
                                        </div>
                                        <div className="bg-white p-3 rounded border border-slate-200">
                                            <strong className="block text-xs text-slate-500 mb-1">ì´ìƒì ì¸ ì‚¶</strong>
                                            {safeUserData.q_ideal_life || '-'}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <div className="html2pdf__page-break"></div>

                            {/* [2. ì¸ìƒ ì‹œê°„í‘œ & Milestone] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">2. ì¸ìƒ ì‹œê°„í‘œ (Life Timeline)</h3>
                                <div className="bg-slate-50 p-6 rounded-xl border">
                                    <div className="flex items-center justify-between text-sm text-slate-500 mb-2 font-bold">
                                        <span>í˜„ì¬ ({currentAge}ì„¸)</span>
                                        <span>ì€í‡´ ({targetAge}ì„¸)</span>
                                        <span>ìˆ˜ëª… ({lifeAge}ì„¸)</span>
                                    </div>
                                    {/* ê·¸ë˜í”„ë°” - ê¸°ê°„ ëª…ì‹œ */}
                                    <div className="relative h-8 bg-gray-200 rounded-full overflow-hidden flex shadow-inner mb-6">
                                        <div style={{width: `${((tAge - currentAge) / (lifeAge - currentAge)) * 100}%`}} className="bg-blue-500 flex items-center justify-center text-xs text-white font-bold">
                                            ê²½ì œí™œë™ê¸° ({tAge - currentAge}ë…„)
                                        </div>
                                        <div style={{width: `${((lifeAge - tAge) / (lifeAge - currentAge)) * 100}%`}} className="bg-green-500 flex items-center justify-center text-xs text-white font-bold">
                                            ë…¸í›„ìƒí™œê¸° ({lifeAge - tAge}ë…„)
                                        </div>
                                    </div>
                                    
                                    {/* Milestone ìš”ì•½ */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                        {milestones.map((m, i) => (
                                            <div key={i} className="bg-white border rounded p-2 text-center shadow-sm">
                                                <div className="text-xl mb-1">{m.icon}</div>
                                                <div className="text-xs text-slate-500">{m.label}</div>
                                                <div className="font-bold text-blue-600">{m.age}ì„¸</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </section>

                            {/* [3. Needs] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">3. ëª©í‘œ ìƒí™œë¹„ ë° ì—°ê¸ˆ (Needs)</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="border p-4 rounded-lg bg-blue-50/50">
                                        <h4 className="font-bold text-blue-900 text-sm mb-3 border-b border-blue-200 pb-1">ğŸ“‰ ì›” ëª©í‘œ ìƒí™œë¹„</h4>
                                        <div className="flex justify-between items-center mb-1 text-sm">
                                            <span className="text-slate-500">í˜„ì¬ ê°€ì¹˜</span>
                                            <span className="font-bold text-slate-800">{baseMonthlyExpense.toLocaleString()} ë§Œì›</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-500">ì€í‡´ ì‹œì ({tAge}ì„¸)</span>
                                            <span className="font-black text-blue-600 text-lg">{Math.round(expenseAtRetirement).toLocaleString()} ë§Œì›</span>
                                        </div>
                                    </div>
                                    <div className="border p-4 rounded-lg bg-indigo-50/50">
                                        <h4 className="font-bold text-indigo-900 text-sm mb-3 border-b border-indigo-200 pb-1">ğŸ›ï¸ êµ­ë¯¼ì—°ê¸ˆ</h4>
                                        <div className="flex justify-between items-center mb-1 text-sm">
                                            <span className="text-slate-500">ìˆ˜ë ¹ ê°œì‹œ</span>
                                            <span className="font-bold text-slate-800">{receiptAge}ì„¸ ë¶€í„°</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-500">ê°œì‹œ ì‹œì  ìˆ˜ë ¹ì•¡</span>
                                            <span className="font-black text-indigo-600 text-lg">{Math.round(npsAtReceipt).toLocaleString()} ë§Œì›</span>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            {/* [4. Accumulation] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">4. ì€í‡´ ì „ ì ë¦½ í¬íŠ¸í´ë¦¬ì˜¤ (Accumulation)</h3>
                                <div className="space-y-4">
                                    {AGE_GROUPS_KEYS.map(age => {
                                        const portfolios = safeUserData.portfolios?.[age];
                                        if (!portfolios || parseInt(age) < Math.floor(Number(currentAge)/10)*10 || parseInt(age) >= tAge) return null;
                                        return (
                                            <div key={age} className="border rounded-lg p-3 bg-white text-sm">
                                                <div className="font-bold text-slate-800 border-b pb-1 mb-2 flex justify-between">
                                                    <span>ğŸ“… {age} í¬íŠ¸í´ë¦¬ì˜¤</span>
                                                    <span className="text-xs text-blue-600 font-normal">ëª©í‘œ ìˆ˜ìµë¥ : {safeUserData.ageStrategies[age]?.targetReturn}%</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                                                    <div><strong className="text-slate-600 block mb-0.5">ì—°ê¸ˆì €ì¶•</strong><ul className="list-disc pl-3 text-slate-500">{portfolios.pension?.length ? portfolios.pension.map((p,i)=><li key={i}>{getRealEtfName(p.id)} ({p.percent}%)</li>) : <li>ë¯¸ì„¤ì •</li>}</ul></div>
                                                    <div><strong className="text-slate-600 block mb-0.5">IRP (ì•ˆì „30%)</strong><ul className="list-disc pl-3 text-slate-500">{portfolios.irp?.length ? portfolios.irp.map((p,i)=><li key={i}>{getRealEtfName(p.id)} ({p.percent}%)</li>) : <li>ë¯¸ì„¤ì •</li>}</ul></div>
                                                    <div className="mt-1"><strong className="text-slate-600 block mb-0.5">ISA</strong><ul className="list-disc pl-3 text-slate-500">{portfolios.isa?.length ? portfolios.isa.map((p,i)=><li key={i}>{getRealEtfName(p.id)} ({p.percent}%)</li>) : <li>ë¯¸ì„¤ì •</li>}</ul></div>
                                                    <div className="mt-1"><strong className="text-slate-600 block mb-0.5">ì¼ë°˜ê³„ì¢Œ</strong><ul className="list-disc pl-3 text-slate-500">{portfolios.general?.length ? portfolios.general.map((p,i)=><li key={i}>{getRealEtfName(p.id)} ({p.percent}%)</li>) : <li>ë¯¸ì„¤ì •</li>}</ul></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>

                            <div className="html2pdf__page-break"></div>

                            {/* [5. Distribution] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">5. ì€í‡´ í›„ ì¸ì¶œìš© í¬íŠ¸í´ë¦¬ì˜¤ (Distribution)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    {['pension','isa','general'].map(type => {
                                        const list = safeUserData.postRetirementDetailed?.[type] || [];
                                        const title = type==='pension'?'ì—°ê¸ˆê³„ì¢Œ (ì•ˆì •)':type==='isa'?'ISA (ì¤‘ë¦½)':type==='general'?'ì¼ë°˜ê³„ì¢Œ (ì„±ì¥)':type;
                                        const presetKey = safeUserData.selectedPresetKeys?.[type];
                                        const presetTitle = getPresetTitleSafe(type, presetKey);
                                        return (
                                            <div key={type} className="border rounded-lg p-3 text-xs bg-slate-50">
                                                <strong className="block bg-slate-200 p-1.5 rounded mb-2 text-center text-slate-700">{title}</strong>
                                                <div className="text-center text-[10px] text-slate-500 mb-2">ì „ëµ: {presetTitle}</div>
                                                <ul className="list-disc pl-4 space-y-1 text-slate-600">
                                                    {list.length > 0 ? list.map((item, idx) => (
                                                        <li key={idx} className="leading-tight">{getRealEtfName(item.id)} <span className="font-bold text-blue-600">({item.percent}%)</span></li>
                                                    )) : <li className="text-slate-400">ì„¤ì • ì—†ìŒ</li>}
                                                </ul>
                                            </div>
                                        )
                                    })}
                                </div>
                            </section>

                            {/* [6. Measures] */}
                            <section className="mb-8 break-inside-avoid">
                                <h3 className="text-lg font-bold text-white bg-slate-800 px-3 py-1 inline-block rounded mb-3">6. ì„ íƒí•œ 5ê°€ì§€ ëŒ€ì±… (Measures)</h3>
                                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded text-sm grid grid-cols-2 gap-4">
                                    <div><span className="block font-bold text-yellow-800 mb-1">1ï¸âƒ£ ìƒí™œë¹„ ì¤„ì´ê¸°</span>{Number(safeUserData.simExpense) < (calculations.totalMonthlyExpense || 0) ? `ì›” ${Number(safeUserData.simExpense).toLocaleString()}ë§Œì›` : "ë¯¸ì ìš©"}</div>
                                    <div><span className="block font-bold text-yellow-800 mb-1">2ï¸âƒ£ Step-down</span>{safeUserData.useStepDown ? "ì ìš© (70ëŒ€~ ê°ì•¡)" : "ë¯¸ì ìš©"}</div>
                                    <div><span className="block font-bold text-yellow-800 mb-1">3ï¸âƒ£ êµ­ë¯¼ì—°ê¸ˆ ì¡°ì ˆ</span>{npsTiming===0?"ì •ìƒìˆ˜ë ¹":npsTiming>0?`${npsTiming}ë…„ ì—°ê¸°`:`${Math.abs(npsTiming)}ë…„ ì¡°ê¸°`}</div>
                                    <div><span className="block font-bold text-yellow-800 mb-1">4ï¸âƒ£ ë‹¤ìš´ì‚¬ì´ì§•</span>{useDownsizing ? `${downsizingAge}ì„¸ (+${downsizingAmount.toLocaleString()}ë§Œì›)` : "ë¯¸ì‹¤í–‰"}</div>
                                    <div className="col-span-2"><span className="block font-bold text-yellow-800 mb-1">5ï¸âƒ£ ì£¼íƒì—°ê¸ˆ í™œìš©</span>{housingPrice > 0 ? `í™œìš© (${housingAge}ì„¸~ ì›” +${estHousingPension.toLocaleString()}ë§Œì›)` : "ë¯¸í™œìš©"}</div>
                                </div>
                            </section>

                            <div className="html2pdf__page-break"></div>

                            {/* [PAGE] ì‘ì› ë©”ì‹œì§€ */}
                            <section className="h-[297mm] flex flex-col justify-center items-center text-center break-inside-avoid relative">
                                <div className="absolute top-0 left-0 w-full h-full border-4 border-double border-slate-200 rounded-3xl m-4 pointer-events-none"></div>
                                <div className="mb-10 text-6xl animate-bounce">ğŸ’Œ</div>
                                <h2 className="text-4xl font-black text-slate-800 mb-8 leading-tight">ë‹¹ì‹ ì˜ ë¹›ë‚˜ëŠ”<br/>ë‘ ë²ˆì§¸ ì¸ìƒì„ ì‘ì›í•©ë‹ˆë‹¤</h2>
                                <div className="max-w-lg text-slate-600 leading-loose text-lg font-medium space-y-6">
                                    <p>ìš°ë¦¬ëŠ” ëˆ„êµ¬ë‚˜ ë‚˜ì´ ë“¦ì„ í”¼í•  ìˆ˜ ì—†ì§€ë§Œ,<br/><span className="text-slate-900 font-bold">ì–´ë–»ê²Œ ë‚˜ì´ ë“¤ì§€ëŠ” ìŠ¤ìŠ¤ë¡œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></p>
                                    <p>ì˜¤ëŠ˜ ë‹¹ì‹ ì´ í˜ë¦° ë•€ë°©ìš¸ê³¼ ê³ ë¯¼ì˜ í”ì ë“¤ì€<br/>ë¨¼ í›—ë‚ , ë‹¹ì‹ ì„ ì§€ì¼œì£¼ëŠ” ë“ ë“ í•œ ë°©íŒ¨ê°€ ë˜ê³ <br/>ììœ ë¡œìš´ ë‚ ê°œê°€ ë˜ì–´ì¤„ ê²ƒì…ë‹ˆë‹¤.</p>
                                    <p>ë¶ˆì•ˆí•´í•˜ì§€ ë§ˆì„¸ìš”.<br/>ë‹¹ì‹ ì€ ì´ë¯¸ í›Œë¥­í•œ ì¤€ë¹„ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.<br/>ì´ì œ ë‹¤ê°€ì˜¬ ë‚´ì¼ì„ ì„¤ë ˜ìœ¼ë¡œ ë§ì´í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</p>
                                </div>
                                <div className="mt-20">
                                    <p className="text-slate-400 text-sm mb-2">ë‹¹ì‹ ì˜ ë“ ë“ í•œ í˜ì´ìŠ¤ë©”ì´ì»¤</p>
                                    <h3 className="text-2xl font-bold text-slate-800">ë³´í†µì‚¬ëŒì˜ ì¬í…Œí¬ ì‚¬ê´€í•™êµ</h3>
                                </div>
                            </section>

                        </div>
                    </div>
                );
            }
            
            console.log("âš ï¸ renderPracticeContent: í•´ë‹¹í•˜ëŠ” ë‹¨ê³„ ì—†ìŒ, currentStep:", currentStep);
            return null;
            
            } catch (error) {
                console.error("âŒâŒâŒ renderPracticeContent ì—ëŸ¬ ë°œìƒ âŒâŒâŒ");
                console.error("âŒ currentStep:", currentStep);
                console.error("âŒ ì—ëŸ¬ ë©”ì‹œì§€:", error.message);
                console.error("âŒ ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
                
                return (
                    <div className="flex items-center justify-center min-h-screen p-8">
                        <div className="max-w-2xl w-full bg-red-50 border-2 border-red-300 rounded-xl p-8 shadow-lg">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-4">âš ï¸</div>
                                <h2 className="text-2xl font-bold text-red-700 mb-2">ë Œë”ë§ ì˜¤ë¥˜ ë°œìƒ</h2>
                                <p className="text-sm text-red-600 mb-4">
                                    {currentStep}ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                            
                            <div className="bg-white p-4 rounded-lg border border-red-200 mb-4">
                                <p className="text-sm font-bold text-slate-700 mb-2">ì—ëŸ¬ ë©”ì‹œì§€:</p>
                                <p className="text-sm text-red-600 font-mono break-all">{error.message}</p>
                            </div>
                            
                            <div className="bg-white p-4 rounded-lg border border-red-200 mb-6">
                                <p className="text-sm font-bold text-slate-700 mb-2">ì—ëŸ¬ ìŠ¤íƒ:</p>
                                <pre className="text-xs text-slate-600 overflow-auto max-h-48 font-mono whitespace-pre-wrap break-all">
                                    {error.stack}
                                </pre>
                            </div>
                            
                            <div className="flex gap-4">
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition shadow-md"
                                >
                                    ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                                </button>
                                <button 
                                    onClick={() => setCurrentStep(0)} 
                                    className="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition shadow-md"
                                >
                                    ğŸ  ì²˜ìŒìœ¼ë¡œ
                                </button>
                            </div>
                            
                            <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-sm text-blue-800">
                                    <strong>ğŸ’¡ ë””ë²„ê¹… ì •ë³´:</strong><br/>
                                    â€¢ currentStep: {currentStep}<br/>
                                    â€¢ userData ì¡´ì¬: {userData ? "âœ…" : "âŒ"}<br/>
                                    â€¢ calculations ì¡´ì¬: {calculations ? "âœ…" : "âŒ"}<br/>
                                    â€¢ viewMode: {viewMode}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const handleNext = () => { window.scrollTo(0,0); if(viewMode === 'lecture') setViewMode('practice'); else if(currentStep < STEPS.length - 1) { setCurrentStep(p=>p+1); setViewMode('lecture'); } else alert("ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤."); };
        const handlePrev = () => { window.scrollTo(0,0); if(viewMode === 'practice') setViewMode('lecture'); else if(currentStep > 0) { setCurrentStep(p=>p-1); setViewMode('practice'); } };

// â–¼â–¼â–¼ [ìˆ˜ì •ë¨] DataMenu: ì‘ê°€ ì „ìš© ë„êµ¬ â–¼â–¼â–¼
        const DataMenu = () => {
            const [showWriterMenu, setShowWriterMenu] = useState(false); 
            const [clickCount, setClickCount] = useState(0);

            // ì „ìì±… PDF ì¶”ì¶œ ê¸°ëŠ¥
            const handleExportEbook = () => {
                if (!confirm("PDF ì „ìì±…ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„¤ëª… ë“£ê¸° íƒ­ì˜ ëª¨ë“  ì›ê³  ë‚´ìš©ì´ í¬í•¨ë©ë‹ˆë‹¤.)")) return;
                const btn = document.getElementById('ebook-btn-text');
                const originalText = btn ? btn.innerText : 'PDF ì¶”ì¶œ';
                if(btn) btn.innerText = 'â³ ìƒì„± ì¤‘...';

                const styleContent = `
                    @media print { 
                        body { -webkit-print-color-adjust: exact; margin: 0; padding: 0; } 
                        .page-break { page-break-before: always; } 
                        .chapter-title { 
                            font-size: 50px; font-weight: 900; color: #1e293b; 
                            border-bottom: 6px solid #2563eb; padding-bottom: 20px; 
                            margin-top: 80px; margin-bottom: 50px; letter-spacing: -2px;
                        }
                        .content-body { 
                            font-family: 'Noto Sans KR', sans-serif; line-height: 1.8; 
                            font-size: 28px; text-align: justify; color: #334155;
                        }
                        .content-body img { max-width: 100%; height: auto; margin: 40px auto; display: block; border-radius: 10px; }
                        .content-body h1 { font-size: 42px; color: #111827; margin-top: 60px; margin-bottom: 30px; font-weight: 800; letter-spacing: -1px; }
                        .content-body h2 { font-size: 36px; color: #1e293b; margin-top: 50px; margin-bottom: 25px; font-weight: 700; border-left: 10px solid #2563eb; padding-left: 20px; }
                        .content-body h3 { font-size: 32px; color: #334155; margin-top: 40px; margin-bottom: 20px; font-weight: 600; }
                        .content-body p { margin-bottom: 30px; }
                        .content-body ul, .content-body ol { margin-bottom: 30px; padding-left: 40px; }
                        .content-body li { margin-bottom: 15px; }
                        .content-body strong { background: #eff6ff; color: #1d4ed8; padding: 0 5px; border-radius: 4px; }
                    } 
                    body { font-family: sans-serif; }
                `;

                let bodyContent = `
                    <div style="text-align:center; margin-top:400px; margin-bottom: 400px;">
                        <div style="font-size: 80px; margin-bottom: 30px;">ğŸ¦</div>
                        <h1 style="font-size: 60px; margin-bottom: 30px; font-weight: 900; color: #1e293b;">ë…¸í›„ì¤€ë¹„ ì›Œí¬ë¶</h1>
                        <p style="font-size: 30px; color: #64748b; font-weight: bold;">ë³´í†µì‚¬ëŒì˜ ì¬í…Œí¬ ì‚¬ê´€í•™êµ</p>
                        <div style="margin-top: 100px; padding: 20px; border: 4px solid #e2e8f0; display: inline-block; border-radius: 20px;">
                            <p style="font-size: 24px; color: #94a3b8; margin: 0;">ì´ ì±…ì€ ë…ì ì°¸ì—¬í˜• ì›Œí¬ë¶ì˜<br>ì›ê³  ë‚´ìš©ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="page-break"></div>
                `;
                
                STEPS.forEach((stepName, idx) => {
                    const contentData = contents[idx];
                    if (contentData && contentData.content) {
                        bodyContent += `
                            <div class="chapter-container">
                                <h1 class="chapter-title">${stepName}</h1>
                                <div class="content-body">${contentData.content}</div>
                            </div>
                            <div class="page-break"></div>
                        `;
                    }
                });

                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(`<html><head><title>ë…¸í›„ì¤€ë¹„ ì›Œí¬ë¶ ì „ìì±…</title><style>${styleContent}</style><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"></head><body>${bodyContent}</body></html>`);
                    printWindow.document.close();
                    printWindow.onload = () => { setTimeout(() => { printWindow.focus(); printWindow.print(); if(btn) btn.innerText = originalText; }, 1500); };
                } else { 
                    alert("íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”."); if(btn) btn.innerText = originalText; 
                }
            };

            // ë¹„ë°€ ë¬¸ ê¸°ëŠ¥
            const handleSecretClick = () => {
                if (clickCount + 1 >= 5) {
                    setShowWriterMenu(!showWriterMenu);
                    setClickCount(0);
                    if (!showWriterMenu) alert("ğŸ” ì‘ê°€ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! ë©”ë‰´ê°€ ì—´ë¦½ë‹ˆë‹¤.");
                    else alert("ğŸ”’ ë©”ë‰´ë¥¼ ë‹¤ì‹œ ìˆ¨ê¹ë‹ˆë‹¤.");
                } else {
                    setClickCount(p => p + 1);
                }
            };

            return (
                <div className="p-4 border-t border-slate-700 bg-slate-900/50">
                    <div onClick={handleSecretClick} className="text-xs text-slate-400 font-bold mb-2 uppercase tracking-wider select-none">ë°ì´í„° ê´€ë¦¬</div>

                    <div className="grid grid-cols-1 gap-2 mb-4">
                        <button onClick={handleContentUploadClick} className="flex items-center justify-center space-x-2 w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white text-sm font-bold rounded border border-blue-500 shadow-md transition"><span>ğŸ“¦ í†µí•© íŒŒì¼ ì—…ë¡œë“œ</span></button>
                        <button onClick={handleSaveFile} className="flex items-center justify-center space-x-2 w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm rounded border border-slate-700 transition"><span>ğŸ’¾ ë‚´ ë‚´ìš© ì €ì¥</span></button>
                        <button onClick={handleLoadClick} className="flex items-center justify-center space-x-2 w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm rounded border border-slate-700 transition"><span>ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</span></button>
                        <button onClick={handleReset} className="flex items-center justify-center space-x-2 w-full py-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 text-sm rounded border border-red-900/50 transition"><span>ğŸ”„ ì´ˆê¸°í™”</span></button>
                    </div>
                    
                    {/* [ì‘ê°€ ì „ìš© ë©”ë‰´] 5ë²ˆ í´ë¦­ ì„±ê³µ ì‹œì—ë§Œ ë“±ì¥ */}
                    {showWriterMenu && (
                        <div className="writer-only-section animate-fade-in bg-slate-800 p-3 rounded-lg border border-yellow-600/50 mt-4">
                            <div className="text-xs text-yellow-400 font-bold mb-2 uppercase border-b border-yellow-600/30 pb-1">ğŸ” ì‘ê°€ ì „ìš© ë„êµ¬</div>
                            
                            <button onClick={() => {
                                if (Object.keys(imageUrls).length === 0) {
                                    alert('ì €ì¥ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!');
                                    return;
                                }
                                if (!confirm(`${Object.keys(imageUrls).length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ê°œë³„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                                
                                Object.entries(imageUrls).forEach(([key, dataUrl]) => {
                                    const link = document.createElement('a');
                                    link.href = dataUrl;
                                    const ext = dataUrl.split(';')[0].split('/')[1] || 'png';
                                    link.download = `${key}.${ext}`;
                                    link.click();
                                });
                                
                                alert('âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n\në…ìì—ê²Œ ì´ ì´ë¯¸ì§€ë“¤ì„ í•¨ê»˜ ì œê³µí•´ì£¼ì„¸ìš”.');
                            }} className="flex items-center justify-center space-x-2 w-full py-2 bg-purple-900/50 hover:bg-purple-900 text-purple-200 text-sm font-bold rounded border border-purple-800 transition mb-3">
                                <span>ğŸ–¼ï¸ ì´ë¯¸ì§€ í´ë” ì¶”ì¶œ</span>
                            </button>

                            <button onClick={handleExportEbook} className="flex items-center justify-center space-x-2 w-full py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold rounded border border-slate-500 transition mb-3">
                                <span id="ebook-btn-text">ğŸ“š ì „ìì±… PDF ì¶”ì¶œ</span>
                            </button>

                            <input type="file" ref={contentInputRef} onChange={handleContentFiles} className="hidden" accept=".txt,.zip,application/zip,application/x-zip-compressed,image/*" multiple />
                        </div>
                    )}
                    
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                </div>
            );
        };
// â–¼â–¼â–¼ [ì—¬ê¸°ì„œë¶€í„° ë³µì‚¬] ì „ì²´ ë””ìì¸ ë° ë ˆì´ì•„ì›ƒ (ìˆ˜ì •ë¨) â–¼â–¼â–¼
        console.log("ğŸ“š Workbook return ì‹œì‘, currentStep:", currentStep, "viewMode:", viewMode);
        console.log("ğŸ“š userData ìƒíƒœ ìµœì¢… í™•ì¸:", userData ? "ì¡´ì¬" : "âŒ ì—†ìŒ");
        console.log("ğŸ“š userData ë‚´ìš©:", userData);
        
        // [ì¤‘ìš”] userDataê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” í™”ë©´ í‘œì‹œ
        if (!userData || typeof userData !== 'object') {
            console.error("âŒâŒâŒ userDataê°€ ì—†ìŠµë‹ˆë‹¤! ê°•ì œ ì´ˆê¸°í™” ì¤‘...");
            
            // ê°•ì œë¡œ userData ì„¤ì •
            React.useEffect(() => {
                console.log("ğŸ”§ userData ê°•ì œ ì´ˆê¸°í™” ì‹œë„");
                setUserData({ ...DEFAULT_USER_DATA });
            }, []);
            
            return (
                <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
                    <div className="text-center p-8 bg-white rounded-2xl shadow-2xl max-w-md">
                        <div className="text-6xl mb-4 animate-bounce">âš™ï¸</div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-3">ë°ì´í„° ì´ˆê¸°í™” ì¤‘...</h2>
                        <p className="text-slate-600 mb-6">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                        <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div className="h-full bg-blue-600 animate-pulse" style={{width: '100%'}}></div>
                        </div>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="flex h-screen overflow-hidden flex-col md:flex-row bg-slate-100">
                {/* 1. ì™¼ìª½ ì‚¬ì´ë“œë°” ë©”ë‰´ */}
{/* 1. ì™¼ìª½ ì‚¬ì´ë“œë°” ë©”ë‰´ (ë¡œê³  ì¶”ê°€ë¨) */}
                <aside className="w-full md:w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col shadow-2xl z-20">
                    <div className="p-6 font-bold text-white text-xl border-b border-slate-700 flex items-center gap-2">
                        <span>ğŸ¦</span> ìì‚°ê´€ë¦¬ ì›Œí¬ë¶
                    </div>
                    <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                        {STEP_LABELS.map((label, idx) => (
                            <button 
                                key={idx} 
                                onClick={()=>{setCurrentStep(idx); setViewMode('lecture');}} 
                                className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all duration-200 ${currentStep===idx ? 'bg-blue-600 text-white font-bold shadow-md translate-x-1':'hover:bg-slate-800 hover:text-white'}`}
                            >
                                <div className="flex items-center gap-2">
                                    <span className={`text-xs ${currentStep===idx?'opacity-100':'opacity-50'}`}>{idx+1}.</span>
                                    <span className="truncate">{label.split('. ')[1]}</span>
                                </div>
                            </button>
                        ))}
                    </nav>

                    {/* â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¶€ë¶„] ë¡œê³  ì˜ì—­ â–¼â–¼â–¼ */}
                    <div className="p-6 pb-2 text-center opacity-90 select-none">
                        <div className="border-t border-slate-700 pt-6">
                            <div className="inline-block mb-3 animate-pulse">
                                <span className="text-5xl drop-shadow-lg">ğŸ›¡ï¸</span>
                            </div>
                            <div>
                                <div className="text-white font-bold text-sm tracking-tight leading-none mb-1 opacity-90">ë³´í†µì‚¬ëŒì˜</div>
                                <div className="text-yellow-400 font-black text-2xl tracking-tighter leading-none mb-2 drop-shadow-md">ì¬í…Œí¬ ì‚¬ê´€í•™êµ</div>
                                <div className="text-blue-400 text-[10px] font-bold tracking-widest border border-blue-400/30 rounded-full px-2 py-0.5 inline-block bg-blue-900/20">ë³´í†µì‚¬ëŒì˜ íˆ¬ìí›ˆë ¨ì†Œ</div>
                            </div>
                        </div>
                    </div>
                    {/* â–²â–²â–² [ì¶”ê°€ ë] â–²â–²â–² */}

                    <DataMenu />
                </aside>

                {/* 2. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
                <main className="flex-1 flex flex-col h-full relative overflow-hidden">
                    {/* ëª¨ë°”ì¼ìš© í—¤ë” */}
                    <header className="bg-white border-b flex md:hidden items-center justify-between p-4 shadow-sm z-30">
                        <div className="font-bold text-slate-800 truncate">{STEP_LABELS[currentStep]}</div>
                        <button onClick={()=>setIsMobileMenuOpen(!isMobileMenuOpen)} className="text-slate-500 hover:text-slate-800">
                            <span className="text-xl">â˜°</span>
                        </button>
                        {isMobileMenuOpen && (
                            <div className="absolute right-2 top-14 w-56 bg-white border shadow-2xl rounded-xl z-50 p-2 flex flex-col gap-1 animate-fade-in">
                                <button onClick={handleSaveFile} className="w-full text-left p-3 hover:bg-slate-50 rounded-lg text-sm font-medium">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                                <button onClick={handleContentUploadClick} className="w-full text-left p-3 hover:bg-blue-50 text-blue-600 rounded-lg text-sm font-bold">ğŸ“¦ í†µí•© íŒŒì¼ ì—…ë¡œë“œ</button>
                                <div className="h-px bg-slate-100 my-1"></div>
                                <button onClick={handleLoadClick} className="w-full text-left p-3 hover:bg-slate-50 rounded-lg text-sm font-medium">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            </div>
                        )}
                    </header>

                    {/* ìƒë‹¨ íƒ­ (ì„¤ëª…ë“£ê¸° vs ì‹¤ì²œí•˜ê¸°) */}
                    <div className="bg-white border-b shadow-sm z-20 px-6 md:px-10 pt-2">
                        <div className="flex space-x-8">
                            <button 
                                onClick={()=>setViewMode('lecture')} 
                                className={`py-4 text-sm md:text-base font-bold transition-all border-b-[3px] ${viewMode==='lecture' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                ğŸ“– ì„¤ëª… ë“£ê¸° (Lecture)
                            </button>
                            <button 
                                onClick={()=>setViewMode('practice')} 
                                className={`py-4 text-sm md:text-base font-bold transition-all border-b-[3px] ${viewMode==='practice' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                âœï¸ ì‹¤ì²œí•˜ê¸° (Workbook)
                            </button>
                        </div>
                    </div>
                    
                    {/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë³¸ë¬¸ ì˜ì—­ */}
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-32 bg-slate-100 scroll-smooth">
                        <div className={`max-w-5xl mx-auto bg-white min-h-[700px] rounded-3xl shadow-xl border border-white overflow-hidden flex flex-col ${viewMode === 'practice' ? 'practice-zoom' : ''}`}>
                            
                            {/* ğŸŒŸ [ë””ìì¸ í†µì¼ í•µì‹¬] ì‹¤ì²œí•˜ê¸° ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ” 'ê³µí†µ í—¤ë”' ğŸŒŸ */}
                            {viewMode === 'practice' && (
                                <div className="bg-slate-50 border-b border-slate-100 p-8 md:p-10 flex justify-between items-end">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="bg-blue-600 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-wider">Step {currentStep + 1}</span>
                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Interactive Workbook</span>
                                        </div>
                                        <h1 className="text-2xl md:text-4xl font-black text-slate-800 m-0 leading-tight">
                                            {STEP_LABELS[currentStep].split('. ')[1]}
                                        </h1>
                                    </div>
                                    <div className="hidden md:block text-slate-100 text-8xl font-black -mb-14 -mr-6 opacity-50 select-none">
                                        {currentStep + 1}
                                    </div>
                                </div>
                            )}

                            {/* ì‹¤ì œ ì½˜í…ì¸  ë‚´ìš© */}
{/* ì‹¤ì œ ì½˜í…ì¸  ë‚´ìš© (ë””ìì¸ ê°œì„ ëœ ê°€ì´ë“œ ë°•ìŠ¤ ì ìš©) */}
                            <div className="flex-1 p-6 md:p-12">
                                {viewMode === 'lecture' ? (
                                    <div className="smart-content" dangerouslySetInnerHTML={{ __html: contents[currentStep] ? contents[currentStep].content : `<div class='flex flex-col items-center justify-center h-64 text-center text-slate-400'><div class="text-4xl mb-4">ğŸ“</div><div>ì•„ì§ ë“±ë¡ëœ ì›ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì™¼ìª½ ë©”ë‰´ í•˜ë‹¨ [ğŸ‘¨â€ğŸ« í†µí•© ì›ê³  ì—…ë¡œë“œ]ë¥¼ í†µí•´ ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.</div></div>` }}></div>
                                ) : (
                                    <div className="practice-content-wrapper">
                                        {/* â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ê°œì„ ëœ ê°€ì´ë“œ ë°•ìŠ¤ â–¼â–¼â–¼ */}
                                        {(() => {
                                            const guideTexts = [
                                                "ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤! ì´ê³³ì€ ì—¬ëŸ¬ë¶„ì˜ ë…¸í›„ ì¤€ë¹„ë¥¼ ìœ„í•œ ì²«ê±¸ìŒì…ë‹ˆë‹¤.\në¹ˆì¹¸ì— 'ì´ë¦„'ì„ ì…ë ¥í•˜ê³  [ì§€ê¸ˆ ì‹œì‘í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.\nì—¬ëŸ¬ë¶„ì˜ ì´ë¦„ì´ ì íŒ ì„¸ìƒì— í•˜ë‚˜ë¿ì¸ ë³´ê³ ì„œë¥¼ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤.", // 0. Intro
                                                
                                                "ğŸ¤” í–‰ë³µí•œ ë…¸í›„ëŠ” ëˆë§Œìœ¼ë¡œ ì™„ì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n[ê´€ê³„, ì·¨ë¯¸, ê³µê°„, ê°€ì¹˜] 4ê°€ì§€ í…Œë§ˆì— ëŒ€í•´ ê¹Šì´ ìƒê°í•´ë³´ì„¸ìš”.\nì •ë‹µì€ ì—†ìŠµë‹ˆë‹¤. ë‚´ê°€ ê¿ˆê¾¸ëŠ” ë…¸í›„ì˜ í’ê²½ì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì„ìˆ˜ë¡ ëª©í‘œê°€ ëª…í™•í•´ì§‘ë‹ˆë‹¤.", // 1. ë…¸í›„ìƒí™œ
                                                
                                                "ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ì˜ ê¸°ì´ˆê°€ ë˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ê³„ì…ë‹ˆë‹¤.\ní˜„ì¬ ë‚˜ì´, ì€í‡´ ëª©í‘œ ì‹œê¸°, ê¸°ëŒ€ ìˆ˜ëª…ì„ ì„¤ì •í•˜ê³ ,\ní˜„ì¬ ë³´ìœ í•˜ê³  ìˆëŠ” [ë¶€ë™ì‚°, í˜„ê¸ˆ, ì—°ê¸ˆ, ì£¼ì‹] ë“±ì˜ ìì‚° í˜„í™©ì„ ë¹ ì§ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”. \nì•„ë¬´ë„ ë³¼ ì¼ì´ ì—†ìœ¼ë‹ˆ ì†”ì§íˆ ì ì–´ë´…ì‹œë‹¤.", // 2. ê¸°ë³¸ì •ë³´
                                                
                                                "ğŸ’¸ ì€í‡´ í›„ì— ë§¤ì›” ì–¼ë§ˆì˜ ìƒí™œë¹„ê°€ í•„ìš”í• ê¹Œìš”?\ní˜„ì¬ ë¬¼ê°€ ê¸°ì¤€ìœ¼ë¡œ í¬ë§ ìƒí™œë¹„ë¥¼ ì…ë ¥í•˜ë©´, ë¬¼ê°€ìƒìŠ¹ë¥ ì„ ë°˜ì˜í•œ ë¯¸ë˜ ë¹„ìš©ì„ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.\nê·¸ë¦¬ê³  ë‚´ êµ­ë¯¼ì—°ê¸ˆ ì˜ˆìƒ ìˆ˜ë ¹ì•¡ê³¼ ë¹„êµí•˜ì—¬ ë§¤ì›” ì–¼ë§ˆê°€ ë¶€ì¡±í•œì§€(Gap) í™•ì¸í•´ë³´ì„¸ìš”.\nì´í›„ ë‹¨ê³„ì—ì„œ ë…¸í›„ ìê¸ˆì´ ë¶€ì¡±í•  ê²½ìš°, ì´ ë‹¨ê³„ë¡œ ëŒì•„ì™€ì„œ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", // 3. í•„ìš”ìê¸ˆ
                                                
                                                "ğŸ’° ë¶€ì¡±í•œ ìê¸ˆì„ ë©”ìš°ê¸° ìœ„í•´ 'ì €ì¶• ê³„íš'ì„ ì„¸ìš°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.\nì—°ë ¹ëŒ€ë³„ë¡œ ë§¤ì›” ì–¼ë§ˆì”© ì €ì¶•í• ì§€, ëª©í‘œ ìˆ˜ìµë¥ ì€ ëª‡ %ë¡œ í• ì§€ ì…ë ¥í•˜ì„¸ìš”.\nê·¸ëŸ° ë‹¤ìŒ, [âš¡ ì ˆì„¸ ìë™ë¶„ë°°]ë¥¼ ì²´í¬í•˜ë©´ ì„¸ê¸ˆì„ ê°€ì¥ ì ê²Œ ë‚´ëŠ” ê³„ì¢Œ ìˆœì„œ(ì—°ê¸ˆì €ì¶• > IRP > ISA)ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.\nìë™ë¶„ë°°ê°€ ì‹«ë‹¤ë©´ ì§ì ‘ ì…ë ¥í•˜ì…”ë„ ë©ë‹ˆë‹¤.\nì´í›„ ë‹¨ê³„ì—ì„œ ë…¸í›„ ìê¸ˆì´ ë¶€ì¡±í•  ê²½ìš°, ì´ ë‹¨ê³„ë¡œ ëŒì•„ì™€ì„œ ë‹¤ì‹œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", // 4. íˆ¬ìê³„íš
                                                
                                                "ğŸ›’ ì•ì„œ ê³„íší•œ ëª©í‘œ ìˆ˜ìµë¥ ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•œ 'ì¥ë°”êµ¬ë‹ˆ' ë‹¨ê³„ì…ë‹ˆë‹¤.\nì—°ê¸ˆ, ISA, IRP ë“± ê° ê³„ì¢Œë³„ë¡œ ì–´ë–¤ ETF(ìƒì¥ì§€ìˆ˜í€ë“œ)ë¥¼ ë‹´ì„ì§€ ê²°ì •í•©ë‹ˆë‹¤.\nìƒí’ˆì„ ì„ íƒí•˜ê³  ë¹„ìœ¨ì„ ì…ë ¥í•˜ë©´ ë‚˜ì˜¤ëŠ” ì˜ˆìƒ ìˆ˜ìµë¥ ì´, ì•ì—ì„œ ê³„íší•œ ëª©í‘œìˆ˜ìµë¥ ë³´ë‹¤ ë†’ê²Œ ë‚˜ì˜¤ë„ë¡ ì„ íƒí•˜ì…”ì•¼ í•©ë‹ˆë‹¤.\nì–´ë ¤ìš°ì‹œë‹¤ë©´ ìƒë‹¨ì˜ [âœ¨ ê¶Œì¥ í¬íŠ¸í´ë¦¬ì˜¤] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì „ë¬¸ê°€ì˜ ì¶”ì²œ êµ¬ì„±ì„ ì ìš©í•´ë³´ì„¸ìš”.", // 5. í¬íŠ¸í´ë¦¬ì˜¤
                                                
                                                "ğŸ’§ ì€í‡´ í›„ì—ëŠ” ìì‚°ì„ ì˜ ëª¨ìœ¼ëŠ” ê²ƒë³´ë‹¤ 'ì˜ êº¼ë‚´ ì“°ëŠ” ê²ƒ'ì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤.\nëª¨ì•„ë‘” ìì‚°ì„ ì„¸ê¸ˆì„ ì•„ë¼ë©´ì„œ ì–´ë–¤ ìˆœì„œë¡œ ì¸ì¶œí• ì§€ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\nì´ ë‹¨ê³„ì—ì„œ 'ìì‚° ê³ ê°ˆ ì‹œì 'ì„ ëŠ¦ì¶”ëŠ” ì¸ì¶œ ì „ëµì„ ì ê²€í•©ë‹ˆë‹¤.\nì„¸ê¸ˆì€ ìµœëŒ€í•œ ë°˜ì˜í•˜ì˜€ìœ¼ë‚˜, ê°œì¸ì— ë”°ë¼ì„œ ì°¨ì´ê°€ ë‚  ìˆ˜ ìˆëŠ”ì  ê³ ë ¤í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.\në‚´ê°€ ëª¨ì€ ìì‚°ìœ¼ë¡œ ëª‡ì„¸ê¹Œì§€ ìƒí™œë¹„ê°€ í™•ë³´ë˜ëŠ”ì§€ë¥¼ ì¤‘ì ì ìœ¼ë¡œ ë³´ì„¸ìš”.\nëª¨ìë¼ë‹¤ë©´ ì• ë‹¨ê³„ë¡œ ëŒì•„ê°€ ì—¬ëŸ¬ê°€ì§€ ëª©í‘œë¥¼ ì¡°ì ˆí•˜ì…”ì•¼ í•©ë‹ˆë‹¤.", // 6. ì¸ì¶œê³„íš
                                                
                                                "ğŸ§  íˆ¬ìëŠ” ì‹¬ë¦¬ ì‹¸ì›€ì…ë‹ˆë‹¤. 20ê°œì˜ ì§ˆë¬¸ì— ë‹µí•´ë³´ì„¸ìš”.\në‚´ê°€ ì‹œì¥ì˜ í•˜ë½ì„ ì–¼ë§ˆë‚˜ ê²¬ë”œ ìˆ˜ ìˆëŠ”ì§€(ìœ„í—˜ ê°ìˆ˜ ì„±í–¥)ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.\nì†”ì§í•˜ê²Œ ë‹µë³€í•´ì•¼ ë‚´ ì„±í–¥ì— ë”± ë§ëŠ” 'ìœ ì§€ ê°€ëŠ¥í•œ' íˆ¬ì ì „ëµì„ ì§¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", // 7. íˆ¬ìì„±í–¥
                                                
                                                "ğŸ›¡ï¸ ì§„ë‹¨ëœ ë‚´ ì„±í–¥(ê³µê²©í˜• vs ìˆ˜ë¹„í˜•)ì— ë§ì¶°, ì€í‡´ í›„ì— êµ´ë¦´ ì‹¤ì „ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì§­ë‹ˆë‹¤.\në§ˆì¹˜ ì¶•êµ¬íŒ€ ê°ë…ì´ ëœ ê²ƒì²˜ëŸ¼ ê³µê²©ìˆ˜(ì„±ì¥), ë¯¸ë“œí•„ë”(ë°°ë‹¹), ìˆ˜ë¹„ìˆ˜(ì•ˆì •) ìì‚°ì„ ì ì ˆíˆ ë°°ì¹˜í•˜ì—¬\ní˜„ê¸ˆ íë¦„ê³¼ ìì‚° ì¦ì‹ì„ ë™ì‹œì— ë…¸ë¦¬ëŠ” 'ì´ê¸°ëŠ” ì „ëµ'ì„ í™•ì •í•˜ì„¸ìš”.\nìƒí’ˆì„ ì„ íƒí•˜ê³  ë¹„ìœ¨ì„ ì…ë ¥í•˜ë©´ ë‚˜ì˜¤ëŠ” ì˜ˆìƒ ìˆ˜ìµë¥ ì´, ì•ì—ì„œ ê³„íší•œ ëª©í‘œìˆ˜ìµë¥ ë³´ë‹¤ ë†’ê²Œ ë‚˜ì˜¤ë„ë¡ ì„ íƒí•˜ì…”ì•¼ í•©ë‹ˆë‹¤.", // 8. ì€í‡´í›„í¬íŠ¸í´ë¦¬ì˜¤
                                                
                                                "ğŸ”§ ë§Œì•½ ìê¸ˆì´ ë¶€ì¡±í•˜ë‹¤ë©´, ì—¬ê¸°ì„œ 'íŠ¹ë‹¨ì˜ ëŒ€ì±…'ì„ ì„¸ì›Œì•¼ í•©ë‹ˆë‹¤.\n1.ìƒí™œë¹„ ì¤„ì´ê¸° 2.ì†Œë¹„ íŒ¨í„´ ë³€ê²½(Step-down) 3.êµ­ë¯¼ì—°ê¸ˆ ì‹œê¸° ì¡°ì ˆ 4.ì£¼íƒ ë‹¤ìš´ì‚¬ì´ì§• 5.ì£¼íƒì—°ê¸ˆ\nì´ 5ê°€ì§€ ì¹´ë“œë¥¼ í•˜ë‚˜ì”© ì ìš©í•´ë³´ë©° ë…¸í›„ ì¤€ë¹„ë¥¼ 'ì™„ë£Œ' ìƒíƒœë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”.\nëª©í‘œ ìƒí™œë¹„ ì¤„ì´ê¸°, ë‚˜ì´ë“¤ìˆ˜ë¡ ëœ ì“°ê¸°, êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ ì‹œê¸° ì¡°ì ˆì€ ì• ë‹¨ê³„ë¡œ ëŒì•„ê°€ ê³„íšì„ ì¡°ì ˆí•˜ë„ë¡ í•©ë‹ˆë‹¤.\në‹¤ìš´ì‚¬ì´ì§• ì „ëµì„ ì„ íƒí•˜ì‹¤ ê²½ìš° 5~7ë‹¨ê³„ì— ì ë¦½ê¸ˆì•¡ì´ ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.\nì£¼íƒì—°ê¸ˆì€ 5~7ë‹¨ê³„ì— ìë™ìœ¼ë¡œ ë°˜ì˜ë˜ì§€ ì•Šìœ¼ë‹ˆ ì°¸ê³  ë°”ëë‹ˆë‹¤.", // 9. ëŒ€ì±…ìˆ˜ë¦½
                                                
                                                "ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ê³¼ì •ì„ ë§ˆì¹˜ì…¨ìŠµë‹ˆë‹¤.\nì´ì œ ì™„ì„±ëœ [ë‚˜ë§Œì˜ ë…¸í›„ì¤€ë¹„ ì¢…í•© ì „ëµ ë³´ê³ ì„œ]ë¥¼ í™•ì¸í•˜ì„¸ìš”.\nì˜¤ë¥¸ìª½ ìƒë‹¨ [ğŸ“„ PDFë¡œ ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ íŒŒì¼ì„ ì†Œì¥í•˜ê³ , ë§¤ë…„ í•œ ë²ˆì”© ì—´ì–´ì„œ ì ê²€í•´ë³´ì„¸ìš”." // 10. ìš”ì•½
                                            ];
                                            
                                            return (
                                                <div className="mb-10 p-6 bg-indigo-50 border-2 border-indigo-200 rounded-2xl shadow-md flex gap-5 items-start transition-all hover:shadow-lg hover:border-indigo-300">
                                                    <div className="text-4xl select-none pt-1">ğŸ’¡</div>
                                                    <div className="flex-1">
                                                        <h3 className="font-black text-indigo-800 text-lg mb-2 flex items-center gap-2">
                                                            <span>STEP {currentStep} ê°€ì´ë“œ</span>
                                                            <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold">Guide</span>
                                                        </h3>
                                                        <p className="text-slate-700 text-base leading-7 font-medium whitespace-pre-line">
                                                            {guideTexts[currentStep]}
                                                        </p>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                        {/* â–²â–²â–² [ì¶”ê°€ ë] â–²â–²â–² */}

                                        {renderPracticeContent()}
                                    </div>
                                )}
                            </div>

                        </div>
                    </div>

                    {/* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */}
                    <div className="absolute bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 md:px-10 flex justify-between items-center z-30">
                        <button 
                            onClick={handlePrev} 
                            disabled={currentStep===0 && viewMode==='lecture'} 
                            className="px-6 py-3 rounded-xl border border-slate-300 text-slate-600 font-bold hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent transition flex items-center gap-2"
                        >
                            <span>â¬…</span> ì´ì „
                        </button>

                        <div className="hidden md:flex gap-1">
                            {STEPS.map((_, i) => (
                                <div key={i} className={`w-2 h-2 rounded-full ${i === currentStep ? 'bg-blue-600 scale-125' : 'bg-slate-300'}`}></div>
                            ))}
                        </div>

                        <button 
                            onClick={handleNext} 
                            className={`px-8 py-3 rounded-xl font-bold text-white shadow-lg transition transform hover:-translate-y-1 hover:shadow-xl flex items-center gap-2 ${viewMode==='lecture'?'bg-slate-700 hover:bg-slate-800':'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700'}`}
                        >
                            {viewMode==='lecture' ? <span>ì‹¤ì²œí•˜ê¸° âœï¸</span> : <span>ë‹¤ìŒ ë‹¨ê³„ â¡</span>}
                        </button>
                    </div>
                    
                    {/* ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ì°½ë“¤ */}
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                    <input type="file" ref={contentInputRef} onChange={handleContentFiles} className="hidden" accept=".txt,.zip,application/zip,application/x-zip-compressed,image/*" multiple />
                </main>
            </div>
        );
    };
    console.log("âœ… Workbook ì»´í¬ë„ŒíŠ¸ ì •ì˜ ì™„ë£Œ");
    // â–²â–²â–² [ì—¬ê¸°ê¹Œì§€ ë³µì‚¬] ë â–²â–²â–²
// â–¼â–¼â–¼ [ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ ê¸°ëŠ¥ ì‹œì‘] â–¼â–¼â–¼
const App = () => {
        const [isAuthenticated, setIsAuthenticated] = React.useState(false);
        const [inputPw, setInputPw] = React.useState("");
        const [errorMsg, setErrorMsg] = React.useState("");
        const [isDataLoading, setIsDataLoading] = React.useState(false);
        const [dataLoadError, setDataLoadError] = React.useState("");

        console.log("ğŸ” App ë Œë”ë§, isAuthenticated:", isAuthenticated);
        console.log("ğŸ” LOCKED_PASSWORD:", LOCKED_PASSWORD);

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        const correctPassword = LOCKED_PASSWORD || "";
        const hasPassword = correctPassword && correctPassword.trim() !== "";

        console.log("ğŸ” hasPassword:", hasPassword, "correctPassword:", correctPassword);

        const handleLogin = React.useCallback((e) => {
            e.preventDefault();
            console.log("ğŸ” ë¡œê·¸ì¸ ì‹œë„, ì…ë ¥ê°’:", inputPw);
            
            if (inputPw === correctPassword) {
                console.log("âœ… ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜!");
                setIsAuthenticated(true);
                setErrorMsg("");
            } else {
                console.log("âŒ ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
                setErrorMsg("â›” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                setInputPw("");
            }
        }, [inputPw, correctPassword]);

        const handleInputChange = React.useCallback((e) => {
            const value = e.target.value;
            console.log("âŒ¨ï¸ ì…ë ¥:", value);
            setInputPw(value);
            if (errorMsg) setErrorMsg("");
        }, [errorMsg]);

        // ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ í†µê³¼
        React.useEffect(() => {
            if (!hasPassword) {
                console.log("ğŸ”“ ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ, ìë™ í†µê³¼");
                setIsAuthenticated(true);
            }
        }, [hasPassword]);

        // ì¸ì¦ í›„ ë°ì´í„° ë¡œë”©
        React.useEffect(() => {
            if (isAuthenticated && !isDataLoading && !window.EMBEDDED_DATA) {
                console.log("ğŸ“¦ ì¸ì¦ ì™„ë£Œ! ë°ì´í„° ë¡œë”© ì‹œì‘...");
                setIsDataLoading(true);
                
                initData()
                    .then(() => {
                        console.log("âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ!");
                        setIsDataLoading(false);
                    })
                    .catch(err => {
                        console.error("âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
                        setDataLoadError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        setIsDataLoading(false);
                    });
            } else if (isAuthenticated && window.EMBEDDED_DATA) {
                console.log("âœ… ë°ì´í„° ì´ë¯¸ ë¡œë“œë¨!");
                setIsDataLoading(false);
            }
        }, [isAuthenticated]);

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í™”ë©´
        if (!isAuthenticated && hasPassword) {
            console.log("ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™”ë©´ í‘œì‹œ");
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-4 border-slate-200">
                        <div className="text-6xl mb-4">ğŸ”’</div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">ë³´ì•ˆ ì ê¸ˆ</h2>
                        <p className="text-slate-500 mb-6 text-sm">ë‚´ìš©ì„ ë³´ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="password" 
                                value={inputPw} 
                                onChange={handleInputChange}
                                className="w-full p-4 border border-slate-300 rounded-xl text-center text-lg font-bold" 
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                autoFocus
                                autoComplete="off"
                            />
                            {errorMsg && <div className="text-red-500 font-bold text-sm">{errorMsg}</div>}
                            <button type="submit" className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl text-lg hover:bg-slate-700 transition-colors">
                                ì ê¸ˆ í•´ì œ
                            </button>
                        </form>
                    </div>
                </div>
            );
        }


        // EMBEDDED_DATA ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
        if (!window.EMBEDDED_DATA) {
            console.log("â³ EMBEDDED_DATA ë¡œë”© ëŒ€ê¸° ì¤‘...");
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-4 border-blue-200">
                        <div className="text-6xl mb-4 animate-bounce">â³</div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">ë°ì´í„° ì¤€ë¹„ ì¤‘...</h2>
                        <p className="text-slate-500 mb-4 text-sm">ì›Œí¬ë¶ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        <div className="flex justify-center items-center space-x-2">
                            <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                            <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                            <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
                        </div>
                    </div>
                </div>
            );
        }

        // ì›Œí¬ë¶ í‘œì‹œ
        console.log("ğŸ“š ì›Œí¬ë¶ ë Œë”ë§ ì‹œì‘");
        console.log("ğŸ“š Workbook ì»´í¬ë„ŒíŠ¸ ì¡´ì¬ ì—¬ë¶€:", typeof Workbook);
        console.log("ğŸ“š EMBEDDED_DATA í™•ì¸ ì™„ë£Œ!");
        
        if (typeof Workbook === 'undefined') {
            console.error("âŒ Workbook ì»´í¬ë„ŒíŠ¸ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
            return (
                <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl text-center">
                        <div className="text-6xl mb-4">âŒ</div>
                        <h2 className="text-2xl font-bold text-red-600 mb-2">ì˜¤ë¥˜: Workbookì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p className="text-slate-600">í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
                        <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            );
        }
        
        try {
            console.log("ğŸ“š Workbook JSX ë Œë”ë§ ì‹œë„");
            return <Workbook />;
        } catch (err) {
            console.error("âŒ Workbook ë Œë”ë§ ì˜¤ë¥˜:", err);
            console.error("âŒ ì—ëŸ¬ ìŠ¤íƒ:", err.stack);
            return (
                <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-2xl">
                        <div className="text-6xl mb-4">âŒ</div>
                        <h2 className="text-2xl font-bold text-red-600 mb-2">ë Œë”ë§ ì˜¤ë¥˜</h2>
                        <p className="text-slate-600 mb-4">{err.message}</p>
                        <pre className="text-left text-xs bg-slate-100 p-4 rounded overflow-auto max-h-60">
                            {err.stack}
                        </pre>
                        <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg">
                            ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            );
        }
    };
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    // â–²â–²â–² [ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ ê¸°ëŠ¥ ë] â–²â–²â–²
</script>
</body>
</html>